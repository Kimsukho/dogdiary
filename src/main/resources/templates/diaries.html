<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<head>
    <title>일지 관리</title>
</head>
<body>
<div layout:fragment="content">
    <div class="diary-page">
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prevMonthBtn">◀</button>
                <h3 id="currentMonth"></h3>
                <button id="nextMonthBtn">▶</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="diary-content">
            <div class="summary-container">
                <div class="summary-item total-item">
                    <div class="summary-icon-circle total-icon">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div class="summary-value" id="currentMonthTotalCount">0</div>
                    <div class="summary-label" id="currentMonthLabel">0월 총 일지</div>
                </div>
                <div class="summary-item mood-item mood-happy">
                    <div class="summary-icon-circle happy-icon">
                        <i class="fas fa-smile"></i>
                    </div>
                    <div class="summary-value" id="happyCount">0</div>
                    <div class="summary-label">행복</div>
                </div>
                <div class="summary-item mood-item mood-sad">
                    <div class="summary-icon-circle sad-icon">
                        <i class="fas fa-frown"></i>
                    </div>
                    <div class="summary-value" id="sadCount">0</div>
                    <div class="summary-label">슬픔</div>
                </div>
                <div class="summary-item mood-item mood-angry">
                    <div class="summary-icon-circle angry-icon">
                        <i class="fas fa-angry"></i>
                    </div>
                    <div class="summary-value" id="angryCount">0</div>
                    <div class="summary-label">화남</div>
                </div>
                <div class="summary-item mood-item mood-excited">
                    <div class="summary-icon-circle excited-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="summary-value" id="excitedCount">0</div>
                    <div class="summary-label">신남</div>
                </div>
            </div>

            <div class="diary-cards" id="diaryCards">
                <div id="emptyCard" class="empty-card">등록된 일지가 없습니다.</div>
            </div>
        </div>
    </div>

    <div class="floating-menu">
        <button id="mainFab" class="fab main-fab">＋</button>
    </div>

    <!-- 각각의 모달 -->    
    <div id="diaryModal" class="diaryModal hidden">
        <div class="modal-content">
            <div class="dogModal-header">
                <h3 id="modalTitle">
                    <i class="fas fa-book-open" style="margin-right: 8px; color: #666;"></i>
                    일지 작성
                </h3>
                <button class="dogModal-back-btn" id="closeModalBtn" title="닫기">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <input type="hidden" id="diaryId" name="diaryId" />
            <div class="dogModal-fields">
                <div class="dogModal-field">
                    <label>날짜</label>
                    <div class="dogModal-field-wrapper">
                        <input type="date" id="diaryDate" required="required" />
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div class="dogModal-field">
                    <label>반려견</label>
                    <div class="dogModal-field-wrapper">
                        <select id="diaryDogSelect" required="required">
                            <option value="" selected>반려견 선택</option>
                        </select>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div class="dogModal-field">
                    <label>기분</label>
                    <div class="dogModal-field-wrapper">
                        <select id="diaryMood" required="required">
                            <option value="" selected hidden>기분 선택</option>
                            <option value="HAPPY">행복</option>
                            <option value="SAD">슬픔</option>
                            <option value="ANGRY">화남</option>
                            <option value="EXCITED">신남</option>
                        </select>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div class="dogModal-field">
                    <label>내용</label>
                    <div class="dogModal-field-wrapper">
                        <textarea id="diaryContent" placeholder="내용" style="resize: vertical; min-height: 100px;"></textarea>
                    </div>
                </div>
            </div>
            <div class="dogModal-action-buttons">
                <button class="dogModal-save-btn" id="saveDiaryBtn">저장하기</button>
            </div>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3>삭제 확인</h3>
            <p>정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.</p>
            <div class="modal-buttons">
            <button class="button confirm-button" id="confirmDeleteBtn">삭제</button>
            <button class="button cancel-button" id="cancelDeleteBtn">취소</button>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            async function init() {
                const diaryCards = document.getElementById('diaryCards');
                const emptyCard = document.getElementById('emptyCard');
                const calendarGrid = document.getElementById('calendarGrid');
                const currentMonthEl = document.getElementById('currentMonth');

                const currentMonthTotalCountEl = document.getElementById('currentMonthTotalCount');
                const cuurentMonthLabel = document.getElementById('currentMonthLabel');
                
                const happyCountEl = document.getElementById('happyCount');
                const sadCountEl = document.getElementById('sadCount');
                const angryCountEl = document.getElementById('angryCount');
                const excitedCountEl = document.getElementById('excitedCount');

                const modal = document.getElementById('diaryModal');
                const closeModalBtn = document.getElementById('closeModalBtn');
                const saveDiaryBtn = document.getElementById('saveDiaryBtn');

                const modalTitle = document.getElementById('modalTitle');
                const diaryId = document.getElementById('diaryId');
                const diaryDate = document.getElementById('diaryDate');
                const diarySelect = document.getElementById('diaryDogSelect');
                const diaryContent = document.getElementById('diaryContent');
                const diaryMood = document.getElementById('diaryMood');

                const deleteModal = document.getElementById("deleteConfirmModal");
                const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
                const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");            
                
                // 플로팅 메뉴
                const mainFab = document.getElementById("mainFab");
                const fabMenu = document.querySelector(".fab-menu");

                let selectedDate = new Date();
                let diaries = [];
                let editingId = null;

                const summaryElements = {
                    currentMonthTotalCountEl: currentMonthTotalCountEl,
                    currentMonthLabel: cuurentMonthLabel,
                    happyCountEl: happyCountEl,
                    sadCountEl: sadCountEl,
                    angryCountEl: angryCountEl,
                    excitedCountEl: excitedCountEl
                };

                const moodClassMap = { 'HAPPY':'mood-Happy','SAD':'mood-Sad','ANGRY':'mood-Angry','EXCITED':'mood-Excited' };
                const moodLabelMap = { 'HAPPY':'행복','SAD':'슬픔','ANGRY':'화남','EXCITED':'신남' };

                // 닫기 버튼
                closeModalBtn.onclick = () => { 
                    modal.style.display='none';
                    diaryId.value=''; 
                    diaryDate.value=''; 
                    diarySelect.value=''; 
                    diaryMood.value=''; 
                    diaryContent.value=''; 
                };

                window.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") {
                        modal.style.display='none';
                    }
                });

                // 저장 버튼
                saveDiaryBtn.onclick = async () => {
                    try {
                        // 필수 필드 검증
                        if (!diaryDate.value) {
                            alert('날짜를 선택해주세요.');
                            return;
                        }
                        if (!diarySelect.value) {
                            alert('반려견을 선택해주세요.');
                            return;
                        }
                        if (!diaryMood.value) {
                            alert('기분을 선택해주세요.');
                            return;
                        }
                        
                        // 모달에서 선택한 날짜 사용
                        const selectedDateFromModal = new Date(diaryDate.value);
                        
                        const isUpdate = saveDiaryBtn.textContent === "수정하기";
                        const data = { 
                            dog_id: diarySelect.value, 
                            mood: diaryMood.value,
                            content: diaryContent.value,
                            created_at: diaryDate.value
                        };
                        
                        // 수정 시에만 id 추가
                        if (isUpdate && diaryId.value) {
                            data.id = diaryId.value;
                        }
                        
                        const apiUrl = isUpdate ? "/api/updateDogDiaryByDogId" : "/api/saveDogDiaryByDogId";
                        const response = await axios.post(apiUrl, data);
                        
                        if (response.data.returnCode === "SUCCESS") {
                            modal.style.display='none';
                            diaries = await ApiCommon.loadDiaries();
                            // 모달에서 선택한 날짜로 selectedDate 업데이트
                            selectedDate = selectedDateFromModal;
                            renderCalendar(selectedDate);
                            renderDiaryList();
                            
                            // 기본 반려견 필터링된 일지 배열 생성
                            const defaultDogId = localStorage.getItem('defaultDogId');
                            let filteredDiaries = diaries;
                            if (defaultDogId && defaultDogId !== '') {
                                filteredDiaries = diaries.filter(d => d.dog_id == defaultDogId);
                            }
                            ApiCommon.renderSummary(selectedDate, filteredDiaries, summaryElements);
                        } else {
                            alert('저장 실패: ' + (response.data.errorMessage || '알 수 없는 오류가 발생했습니다.'));
                        }
                    } catch (error) {
                        console.error('일지 저장 중 오류 발생:', error);
                        alert('일지 저장 중 오류가 발생했습니다: ' + (error.response?.data?.errorMessage || error.message || '알 수 없는 오류'));
                    }
                };

                // 삭제 확인
                confirmDeleteBtn.onclick = async () => {
                    try {
                        const response = await axios.post("/api/deleteDogDiaryById", { id: diaryId.value });
                        if (response.data.returnCode === "SUCCESS") {
                            diaries = await ApiCommon.loadDiaries();
                            renderDiaryList();
                            renderCalendar(selectedDate);
                            
                            // 기본 반려견 필터링된 일지 배열 생성
                            const defaultDogId = localStorage.getItem('defaultDogId');
                            let filteredDiaries = diaries;
                            if (defaultDogId && defaultDogId !== '') {
                                filteredDiaries = diaries.filter(d => d.dog_id == defaultDogId);
                            }
                            ApiCommon.renderSummary(selectedDate, filteredDiaries, summaryElements);
                        } else {
                            alert("삭제 실패: " + response.data.errorMessage);
                        }
                    } catch (e) { console.error(e); }
                    modal.style.display = "none";
                    deleteModal.style.display = "none";
                };

                // 취소 클릭
                cancelDeleteBtn.onclick = () => { 
                    modal.style.display = "none";
                    deleteModal.style.display = "none";
                };

                // 플로팅 버튼 토글
                mainFab.addEventListener("click", () => {
                    modal.classList.remove("hidden");
                    modal.style.display = "flex";
                    editingId=null; 
                    modalTitle.innerHTML='<i class="fas fa-book-open" style="margin-right: 8px; color: #666;"></i>일지 작성';
                    saveDiaryBtn.textContent='저장하기';
                    diaryId.value=''; 
                    // 현재 선택한 날짜를 모달의 날짜 필드에 설정
                    const year = selectedDate.getFullYear();
                    const month = String(selectedDate.getMonth() + 1).padStart(2, '0');
                    const day = String(selectedDate.getDate()).padStart(2, '0');
                    diaryDate.value = `${year}-${month}-${day}`;
                    // 로컬 스토리지에 defaultDogId가 있으면 자동 선택, 없으면 빈 값
                    const defaultDogId = localStorage.getItem('defaultDogId');
                    diarySelect.value = (defaultDogId && defaultDogId !== '') ? defaultDogId : ''; 
                    diaryMood.value=''; 
                    diaryContent.value=''; 
                });

                async function loadDogs() {
                    try {
                    const response = await axios.get("/api/getDogsByUserId");
                    if (response.data.returnCode === "SUCCESS") {
                        const dogs = response.data.resultData || [];

                        // 기존 옵션 초기화
                        diarySelect.innerHTML = '';

                        // 로컬 스토리지에서 기본 반려견 ID 읽기
                        const defaultDogId = localStorage.getItem('defaultDogId');

                        // 강아지 목록이 있으면 "반려견 선택" 옵션을 유지하고 기본 반려견을 선택
                        if (dogs.length > 0) {
                            // "반려견 선택" 옵션 추가
                            const defaultOption = document.createElement("option");
                            defaultOption.value = "";
                            defaultOption.textContent = "반려견 선택";
                            diarySelect.appendChild(defaultOption);
                            
                            // 강아지 목록 추가
                            dogs.forEach((dog, index) => {
                                const option = document.createElement("option");
                                option.value = dog.id;
                                option.textContent = dog.name;
                                diarySelect.appendChild(option);
                            });
                            
                            // 로컬 스토리지에 defaultDogId가 있고 목록에 해당 강아지가 있으면 선택
                            if (defaultDogId && defaultDogId !== '') {
                                const foundDog = dogs.find(dog => dog.id == defaultDogId);
                                if (foundDog) {
                                    diarySelect.value = defaultDogId;
                                } else {
                                    // 저장된 defaultDogId가 목록에 없으면 첫 번째 강아지 선택
                                    diarySelect.value = dogs[0].id;
                                }
                            } else {
                                // defaultDogId가 없으면 첫 번째 강아지 선택
                                diarySelect.value = dogs[0].id;
                            }
                        } else {
                            // 강아지가 없으면 "반려견 선택" 옵션만 표시
                            const option = document.createElement("option");
                            option.value = "";
                            option.textContent = "반려견 선택";
                            option.selected = true;
                            diarySelect.appendChild(option);
                        }
                    } else {
                        console.warn("반려견 목록 불러오기 실패:", response.data.message);
                    }
                    } catch (error) {
                        console.error("반려견 목록 조회 중 오류 발생:", error);
                    }
                }

                function renderDiaryList() {
                    // localStorage에서 기본 반려견 ID 읽기
                    const defaultDogId = localStorage.getItem('defaultDogId');
                    
                    let filtered = diaries.filter(d=>new Date(d.created_at).toDateString()===selectedDate.toDateString());
                    
                    // 기본 반려견이 설정되어 있으면 해당 강아지의 일지만 필터링
                    if (defaultDogId && defaultDogId !== '') {
                        filtered = filtered.filter(d => d.dog_id == defaultDogId);
                    }
                    
                    filtered = filtered.sort((a, b) => {
                        // 최신순 정렬: last_updated가 있으면 그것을 기준으로, 없으면 created_at 기준
                        const dateA = a.last_updated ? new Date(a.last_updated) : new Date(a.created_at);
                        const dateB = b.last_updated ? new Date(b.last_updated) : new Date(b.created_at);
                        return dateB - dateA;
                    });
                    diaryCards.innerHTML='';
                    if(filtered.length===0){ 
                        diaryCards.appendChild(emptyCard); 
                        emptyCard.style.display='flex'; 
                    } else {
                        filtered.forEach(d=>{
                            const moodClass=moodClassMap[d.mood]||'';
                            const moodLabel=moodLabelMap[d.mood]||(d.mood||'-');
                            // 일지의 날짜는 created_at 기준으로 표시
                            const dateObj = new Date(d.created_at);
                            const formattedDate = `${dateObj.getFullYear()}년 ${dateObj.getMonth() + 1}월 ${dateObj.getDate()}일`;
                            
                            // 기분에 따른 아이콘 색상 설정 (다크 모드 감지)
                            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                            let iconColor = 'var(--primary-color)';
                            if (isDarkMode) {
                                // 다크 모드일 때는 연한 회색 사용
                                iconColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#b0b0b0';
                            } else {
                                // 라이트 모드일 때는 기분에 따른 색상 사용
                                if (d.mood === 'HAPPY') {
                                    iconColor = '#FF6B9D';
                                } else if (d.mood === 'SAD') {
                                    iconColor = '#1976D2';
                                } else if (d.mood === 'ANGRY') {
                                    iconColor = '#C62828';
                                } else if (d.mood === 'EXCITED') {
                                    iconColor = '#7B1FA2';
                                }
                            }
                            
                            const card=document.createElement('div');
                            card.className='diary-card';
                            card.innerHTML=`
                                <div class="diary-card-left-border ${moodClass}"></div>
                                <div class="diary-card-body">
                                    <div class="diary-card-header-section">
                                        <div class="diary-date-header">
                                            <i class="fas fa-calendar-alt" style="color: ${iconColor};"></i>
                                            <span>${formattedDate}</span>
                                        </div>
                                        <div class="diary-card-actions">
                                            <button class="edit-btn" data-id="${d.id}" title="수정"><i class="fas fa-pencil-alt"></i></button>
                                            <button class="delete-btn" data-id="${d.id}" title="삭제"><i class="fas fa-trash-alt"></i></button>
                                        </div>
                                    </div>
                                    <div class="diary-profile-section">
                                        <div class="diary-avatar ${moodClass}">
                                            <i class="fas ${d.mood === 'HAPPY' ? 'fa-smile' : d.mood === 'SAD' ? 'fa-frown' : d.mood === 'ANGRY' ? 'fa-angry' : 'fa-star'}"></i>
                                        </div>
                                        <div class="diary-info">
                                            <h3 class="diary-dog-name">${d.name}</h3>
                                        </div>
                                    </div>
                                    <div class="diary-content-section">
                                        <div class="diary-about-title">
                                            <i class="fas fa-sticky-note" style="color: ${iconColor};"></i>
                                            <span>메모</span>
                                        </div>
                                        <p class="diary-content">${d.content || "내용이 없습니다."}</p>
                                    </div>
                                </div>
                            `;
                            diaryCards.appendChild(card);
                            
                            // 수정 클릭
                            card.querySelector('.edit-btn').onclick = () => {
                                modal.classList.remove("hidden");
                                modal.style.display = "flex";
                                modalTitle.innerHTML='<i class="fas fa-book-open" style="margin-right: 8px; color: #666;"></i>일지 수정';
                                saveDiaryBtn.textContent='수정하기';
                                diaryId.value = d.id;
                                // 기존 일지의 날짜(created_at)를 모달의 날짜 필드에 설정
                                const dateObj = new Date(d.created_at);
                                const year = dateObj.getFullYear();
                                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                const day = String(dateObj.getDate()).padStart(2, '0');
                                diaryDate.value = `${year}-${month}-${day}`;
                                diarySelect.value=d.dog_id; 
                                diaryMood.value=d.mood; 
                                diaryContent.value=d.content; 
                            };
                            // 삭제 클릭
                            card.querySelector('.delete-btn').onclick = async () => {
                                deleteModal.style.display='flex';
                                diaryId.value = d.id;
                            };
                        });
                    }
                }

                function renderCalendar(date){
                    const year=date.getFullYear(); const month=date.getMonth();
                    currentMonthEl.textContent=`${year}년 ${month+1}월`;
                    const firstDay=new Date(year,month,1).getDay();
                    const lastDate=new Date(year,month+1,0).getDate();
                    calendarGrid.innerHTML='';
                    
                    // localStorage에서 기본 반려견 ID 읽기
                    const defaultDogId = localStorage.getItem('defaultDogId');
                    
                    // 요일 헤더 추가
                    const weekdays = ['일', '월', '화', '수', '목', '금', '토'];
                    weekdays.forEach(day => {
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'calendar-weekday';
                        dayHeader.textContent = day;
                        calendarGrid.appendChild(dayHeader);
                    });
                    
                    for(let i=0;i<firstDay;i++) calendarGrid.appendChild(document.createElement('div'));
                    for(let day=1;day<=lastDate;day++){
                        const dayEl=document.createElement('div'); 
                        dayEl.className='calendar-day';
                        const thisDate=new Date(year,month,day);
                        const dayOfWeek = thisDate.getDay();
                        
                        // 주말 스타일 추가
                        if(dayOfWeek === 0) dayEl.classList.add('sunday');
                        if(dayOfWeek === 6) dayEl.classList.add('saturday');
                        
                        // 날짜 숫자 컨테이너
                        const dayNumber = document.createElement('div');
                        dayNumber.className = 'calendar-day-number';
                        dayNumber.textContent = day;
                        dayEl.appendChild(dayNumber);
                        
                        // 해당 날짜의 일지들 필터링 (created_at 기준)
                        let dayDiaries = diaries.filter(d => {
                            const dd = new Date(d.created_at);
                            return dd.getFullYear() === year && dd.getMonth() === month && dd.getDate() === day;
                        });
                        
                        // 기본 반려견이 설정되어 있으면 해당 강아지의 일지만 필터링
                        if (defaultDogId && defaultDogId !== '') {
                            dayDiaries = dayDiaries.filter(d => d.dog_id == defaultDogId);
                        }
                        
                        if(dayDiaries.length > 0) {
                            // 작은 원 표시
                            const dotIndicator = document.createElement('div');
                            dotIndicator.className = 'calendar-diary-dot';
                            dayNumber.appendChild(dotIndicator);
                            
                            // 일지 개수 표시
                            const countBadge = document.createElement('div');
                            countBadge.className = 'calendar-diary-count';
                            countBadge.textContent = "+" + dayDiaries.length;
                            dayEl.appendChild(countBadge);
                        }
                        
                        // 오늘 날짜 체크
                        const today = new Date();
                        if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                            dayEl.classList.add('today');
                        }
                        
                        dayEl.onclick=()=>{ selectedDate=thisDate; renderCalendar(selectedDate); renderDiaryList(); };
                        if(thisDate.toDateString()===selectedDate.toDateString()) dayEl.classList.add('selected');
                        calendarGrid.appendChild(dayEl);
                    }
                }

                window.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") {
                        fabMenu.classList.remove("show");
                        document.querySelectorAll(".modal").forEach(m => m.classList.add("hidden"));
                    }
                });

                document.getElementById('prevMonthBtn').onclick=()=>{ 
                    selectedDate.setMonth(selectedDate.getMonth() - 1);
                    renderCalendar(selectedDate);
                    renderDiaryList();
                    
                    // 기본 반려견 필터링된 일지 배열 생성
                    const defaultDogId = localStorage.getItem('defaultDogId');
                    let filteredDiaries = diaries;
                    if (defaultDogId && defaultDogId !== '') {
                        filteredDiaries = diaries.filter(d => d.dog_id == defaultDogId);
                    }
                    ApiCommon.renderSummary(selectedDate, filteredDiaries, summaryElements);
                };

                document.getElementById('nextMonthBtn').onclick=()=>{ 
                    selectedDate.setMonth(selectedDate.getMonth() + 1);
                    renderCalendar(selectedDate);
                    renderDiaryList();
                    
                    // 기본 반려견 필터링된 일지 배열 생성
                    const defaultDogId = localStorage.getItem('defaultDogId');
                    let filteredDiaries = diaries;
                    if (defaultDogId && defaultDogId !== '') {
                        filteredDiaries = diaries.filter(d => d.dog_id == defaultDogId);
                    }
                    ApiCommon.renderSummary(selectedDate, filteredDiaries, summaryElements); 
                };

                document.querySelectorAll(".close-button").forEach(btn => {
                    btn.addEventListener("click", () => {
                        btn.closest(".diaryModal").classList.add("hidden");
                    });
                });

                diaries = await ApiCommon.loadDiaries();
                await loadDogs();
                renderCalendar(selectedDate);
                renderDiaryList();
                
                // 기본 반려견 필터링된 일지 배열 생성
                const defaultDogId = localStorage.getItem('defaultDogId');
                let filteredDiaries = diaries;
                if (defaultDogId && defaultDogId !== '') {
                    filteredDiaries = diaries.filter(d => d.dog_id == defaultDogId);
                }
                ApiCommon.renderSummary(selectedDate, filteredDiaries, summaryElements);
            }
            init();
        });

    </script>
</th:block>
</body>
</html>
