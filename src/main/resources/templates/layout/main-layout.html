<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <head th:replace="fragments/head :: headFragment"></head>
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>
<body>
    <div class="wrapper">
        <aside th:replace="fragments/sidebar :: sidebar"></aside>

        <div class="main-content-wrapper" id="mainContentWrapper">
            <header th:replace="fragments/header :: header(title=${title})"></header>
            
            <main layout:fragment="content"></main>

            <th:block layout:fragment="script"></th:block>
            
            <footer th:replace="fragments/footer :: footer"></footer>
        </div>
    </div>

    <div id="toast">메시지가 여기에 표시됩니다!</div>

    <!-- 알림 모달 -->
    <div id="notificationModal" class="notification-modal">
        <div class="notification-modal-content">
            <div class="notification-modal-header">
                <h3><i class="fas fa-bell"></i> 알림</h3>
                <button class="notification-modal-close" id="closeNotificationModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notification-modal-body">
                <div class="notification-list" id="notificationList">
                    <!-- 알림 목록이 여기에 동적으로 추가됩니다 -->
                    <div class="notification-empty">
                        <i class="fas fa-bell-slash"></i>
                        <p>새로운 알림이 없습니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 공통 API JavaScript 파일 -->
    <script th:src="@{/js/api-common.js}"></script>

    <script>
        // 알림 모달 전역 함수 정의 (header fragment보다 먼저 실행되도록)
        window.openNotificationModal = function() {
            const notificationModal = document.getElementById('notificationModal');
            if (notificationModal) {
                notificationModal.style.display = 'flex';
            } else {
                console.warn('알림 모달을 찾을 수 없습니다.');
            }
        };

        window.closeNotificationModal = function() {
            const notificationModal = document.getElementById('notificationModal');
            if (notificationModal) {
                notificationModal.style.display = 'none';
            }
        };

        // 알림 모달 이벤트 리스너 초기화
        document.addEventListener('DOMContentLoaded', function() {
            const notificationModal = document.getElementById('notificationModal');
            const closeNotificationModal = document.getElementById('closeNotificationModal');

            if (!notificationModal) {
                console.warn('알림 모달을 찾을 수 없습니다.');
                return;
            }

            // 닫기 버튼 클릭 이벤트
            if (closeNotificationModal) {
                closeNotificationModal.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    window.closeNotificationModal();
                });
            }

            // 모달 외부 클릭 시 닫기
            notificationModal.addEventListener('click', function(e) {
                if (e.target === notificationModal) {
                    window.closeNotificationModal();
                }
            });

            // ESC 키로 모달 닫기
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && notificationModal && notificationModal.style.display === 'flex') {
                    window.closeNotificationModal();
                }
            });
        });

        // 페이지 로드 시 테마, 폰트 크기, 애니메이션 효과 적용 (다른 스크립트보다 먼저 실행)
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const savedFontSize = localStorage.getItem('fontSize') || 'medium';
            document.documentElement.setAttribute('data-font-size', savedFontSize);
            
            const savedAnimations = localStorage.getItem('animations');
            const animationsEnabled = savedAnimations === null ? true : savedAnimations === 'true';
            document.documentElement.setAttribute('data-animations', animationsEnabled ? 'true' : 'false');
        })();

        document.addEventListener('DOMContentLoaded', () => {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar'); // sidebar fragment에 id="sidebar"가 추가되어야 함

            if (!sidebar) {
                console.error("Sidebar element with id 'sidebar' not found. Please ensure sidebar fragment has id='sidebar'.");
                return;
            }

            const sidebarTitle = sidebar.querySelector('.sidebar-title');
            const sidebarCollapsedTitle = sidebar.querySelector('.sidebar-collapsed-title');

            function setInitialSidebarState() {
                if (window.innerWidth <= 1024) { // 태블릿 사이즈까지는 기본 접힘
                    sidebar.classList.add('collapsed');
                    if (sidebarTitle) sidebarTitle.style.display = 'none';
                    if (sidebarCollapsedTitle) sidebarCollapsedTitle.style.display = 'block';
                } else {
                    sidebar.classList.remove('collapsed');
                    if (sidebarTitle) sidebarTitle.style.display = 'block';
                    if (sidebarCollapsedTitle) sidebarCollapsedTitle.style.display = 'none';
                }
            }
            setInitialSidebarState();

            if (sidebarToggle) { 
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    
                    if (sidebar.classList.contains('collapsed')) {
                        if (sidebarTitle) sidebarTitle.style.display = 'none';
                        if (sidebarCollapsedTitle) sidebarCollapsedTitle.style.display = 'block';
                    } else {
                        if (sidebarTitle) sidebarTitle.style.display = 'block';
                        if (sidebarCollapsedTitle) sidebarCollapsedTitle.style.display = 'none';
                    }
                });
            } else {
                console.warn("Sidebar toggle button with id 'sidebarToggle' not found. Sidebar toggling will not work.");
            }

            function handleResize() {
                if (window.innerWidth <= 1024) {
                    if (!sidebar.classList.contains('collapsed')) { // 아직 접히지 않았다면
                        sidebar.classList.add('collapsed');
                        if (sidebarTitle) sidebarTitle.style.display = 'none';
                        if (sidebarCollapsedTitle) sidebarCollapsedTitle.style.display = 'block';
                    }
                } else { 
                    // PC 화면에서는 기본적으로 펼쳐진 상태 (혹은 이전 상태 유지)
                    sidebar.classList.remove('collapsed');
                    if (sidebarTitle) sidebarTitle.style.display = 'block';
                    if (sidebarCollapsedTitle) sidebarCollapsedTitle.style.display = 'none';
                }
            }
            window.addEventListener('resize', handleResize);
        });

        function showToast(message) {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.classList.add('reveal');
                setTimeout(() => {
                    toast.classList.remove('reveal');
                }, 3000);
            } else {
                console.warn("Toast element with id 'toast' not found.");
            }
        }
    </script>
</body>
</html>