<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<head>
    <title>사용자 관리</title>
</head>
<body>
<div layout:fragment="content">
    <div class="admin-users-page">
        <div class="admin-header">
            <h2><i class="fas fa-users-cog"></i> 사용자 관리</h2>
            <button class="admin-add-btn" id="addUserBtn">
                <i class="fas fa-plus"></i> 사용자 추가
            </button>
        </div>

        <!-- 검색 및 필터 영역 -->
        <div class="admin-search-filter">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="사용자명 또는 이메일로 검색...">
            </div>
            <div class="filter-box">
                <select id="roleFilter" class="filter-select">
                    <option value="">전체 역할</option>
                    <option value="USER">일반 사용자</option>
                    <option value="ADMIN">관리자</option>
                </select>
            </div>
        </div>

        <!-- 사용자 목록 테이블 -->
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>사용자명</th>
                        <th>이메일</th>
                        <th>역할</th>
                        <th>가입일</th>
                        <th>최종 수정일</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr>
                        <td colspan="7" class="loading-row">
                            <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 빈 상태 -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-users"></i>
            <p>등록된 사용자가 없습니다.</p>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination-container" id="paginationContainer" style="display: none;">
            <div class="pagination" id="pagination">
                <!-- 페이지네이션 버튼이 여기에 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>

    <!-- 사용자 추가/수정 모달 -->
    <div id="userModal" class="modal-overlay" style="display: none;">
        <div class="modal-container admin-modal-container">
            <div class="modal-header">
                <h3 id="modalTitle">사용자 추가</h3>
                <button class="modal-close" id="closeUserModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-field">
                        <label for="username">사용자명 <span class="required">*</span></label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-field">
                        <label for="email">이메일 <span class="required">*</span></label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-field">
                        <label for="password" id="passwordLabel">비밀번호 <span class="required">*</span></label>
                        <input type="password" id="password">
                        <small id="passwordHint" class="form-hint">수정 시 비밀번호를 입력하지 않으면 기존 비밀번호가 유지됩니다.</small>
                    </div>
                    <div class="form-field">
                        <label for="role">역할 <span class="required">*</span></label>
                        <select id="role" required>
                            <option value="USER">일반 사용자</option>
                            <option value="ADMIN">관리자</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="button cancel-button" id="cancelUserBtn">취소</button>
                <button class="button confirm-button" id="saveUserBtn">저장</button>
            </div>
        </div>
    </div>

    <!-- 사용자 상세 정보 모달 -->
    <div id="userDetailModal" class="modal-overlay" style="display: none;">
        <div class="modal-container admin-modal-container">
            <div class="modal-header">
                <h3>사용자 상세 정보</h3>
                <button class="modal-close" id="closeDetailModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="userDetailContent">
                    <!-- 사용자 상세 정보가 여기에 표시됩니다 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="button confirm-button" id="closeDetailBtn">닫기</button>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="deleteConfirmModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3>삭제 확인</h3>
                <button class="modal-close" id="closeDeleteModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>정말 이 사용자를 삭제하시겠습니까?</p>
                <p class="warning-text">이 작업은 되돌릴 수 없습니다.</p>
            </div>
            <div class="modal-footer">
                <button class="button cancel-button" id="cancelDeleteBtn">취소</button>
                <button class="button confirm-button" id="confirmDeleteBtn">삭제</button>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const userTableBody = document.getElementById('userTableBody');
        const searchInput = document.getElementById('searchInput');
        const roleFilter = document.getElementById('roleFilter');
        const addUserBtn = document.getElementById('addUserBtn');
        const userModal = document.getElementById('userModal');
        const userDetailModal = document.getElementById('userDetailModal');
        const deleteModal = document.getElementById('deleteConfirmModal');
        
        let users = [];
        let editingUserId = null;
        let deletingUserId = null;

        // 이메일 마스킹 함수
        function maskEmail(email) {
            if (!email) return '';
            const [localPart, domain] = email.split('@');
            if (!localPart || !domain) return email;
            
            const maskedLocal = localPart.length > 2 
                ? localPart.substring(0, 2) + '*'.repeat(localPart.length - 2)
                : localPart.charAt(0) + '*';
            
            return maskedLocal + '@' + domain;
        }

        // 날짜 포맷팅 함수
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 페이지네이션 변수
        let currentPage = 1;
        const pageSize = 10;
        let totalPages = 1;
        let totalCount = 0;

        // 사용자 목록 로드
        async function loadUsers(page = 1) {
            try {
                currentPage = page;
                // 전체 데이터를 받아오기 위해 큰 페이지 크기 사용 (또는 페이지네이션 없이)
                const response = await axios.get(`/api/admin/getUserList?page=1&size=10000`);
                if (response.data.returnCode === 'SUCCESS') {
                    const result = response.data.resultData;
                    users = result.list || [];
                    renderUsers();
                    renderPagination();
                } else {
                    console.error('사용자 목록 조회 실패:', response.data.errorMessage);
                    showToast('사용자 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('사용자 목록 조회 중 오류:', error);
                showToast('사용자 목록을 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 전역 함수로 노출 (페이지네이션 버튼에서 사용)
        window.loadUsers = loadUsers;

        // 사용자 목록 렌더링
        function renderUsers() {
            const searchTerm = searchInput.value.toLowerCase();
            const roleFilterValue = roleFilter.value;

            let filteredUsers = users.filter(user => {
                const matchesSearch = !searchTerm || 
                    (user.username && user.username.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm));
                const matchesRole = !roleFilterValue || user.role === roleFilterValue;
                return matchesSearch && matchesRole;
            });

            // 필터링된 결과 기준으로 페이지네이션 재계산
            const filteredCount = filteredUsers.length;
            totalCount = filteredCount;
            totalPages = Math.ceil(filteredCount / pageSize);
            
            // 현재 페이지가 필터링된 결과의 페이지 수를 초과하면 첫 페이지로 이동
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = 1;
            }

            // 현재 페이지에 해당하는 데이터만 표시
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const paginatedUsers = filteredUsers.slice(startIndex, endIndex);

            userTableBody.innerHTML = '';

            if (paginatedUsers.length === 0) {
                userTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-row">
                            검색 결과가 없습니다.
                        </td>
                    </tr>
                `;
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }

            if (totalPages > 1) {
                document.getElementById('paginationContainer').style.display = 'flex';
            } else {
                document.getElementById('paginationContainer').style.display = 'none';
            }

            paginatedUsers.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username || '-'}</td>
                    <td>${maskEmail(user.email || '-')}</td>
                    <td>
                        <span class="role-badge ${user.role === 'ADMIN' ? 'admin-badge' : 'user-badge'}">
                            ${user.role === 'ADMIN' ? '관리자' : '일반 사용자'}
                        </span>
                    </td>
                    <td>${formatDate(user.regdate)}</td>
                    <td>${formatDate(user.last_updated)}</td>
                    <td class="action-buttons">
                        <button class="action-btn view-btn" data-id="${user.id}" title="상세 보기">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn edit-btn" data-id="${user.id}" title="수정">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" data-id="${user.id}" title="삭제">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                userTableBody.appendChild(row);
            });

            // 이벤트 리스너 추가
            attachEventListeners();
        }

        // 이벤트 리스너 연결
        function attachEventListeners() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = parseInt(e.currentTarget.dataset.id);
                    showUserDetail(userId);
                });
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = parseInt(e.currentTarget.dataset.id);
                    editUser(userId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = parseInt(e.currentTarget.dataset.id);
                    deleteUser(userId);
                });
            });
        }

        // 사용자 상세 정보 표시 (관리자는 전체 정보 확인 가능)
        async function showUserDetail(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // 상세 정보는 API를 통해 전체 정보 조회 (마스킹 없이)
            try {
                const response = await axios.get(`/api/admin/getUserByName?userName=${user.username}`);
                if (response.data.returnCode === 'SUCCESS') {
                    const fullUser = response.data.resultData;
                    const detailContent = document.getElementById('userDetailContent');
                    detailContent.innerHTML = `
                        <div class="user-detail-info">
                            <div class="detail-item">
                                <label>ID</label>
                                <span>${fullUser.id}</span>
                            </div>
                            <div class="detail-item">
                                <label>사용자명</label>
                                <span>${fullUser.username || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <label>이메일</label>
                                <span>${fullUser.email || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <label>역할</label>
                                <span class="role-badge ${fullUser.role === 'ADMIN' ? 'admin-badge' : 'user-badge'}">
                                    ${fullUser.role === 'ADMIN' ? '관리자' : '일반 사용자'}
                                </span>
                            </div>
                            <div class="detail-item">
                                <label>가입일</label>
                                <span>${formatDate(fullUser.regdate)}</span>
                            </div>
                            <div class="detail-item">
                                <label>최종 수정일</label>
                                <span>${formatDate(fullUser.last_updated)}</span>
                            </div>
                        </div>
                    `;
                    userDetailModal.style.display = 'flex';
                } else {
                    alert('사용자 정보를 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('사용자 상세 정보 조회 오류:', error);
                alert('사용자 정보를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 사용자 수정
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            editingUserId = userId;
            document.getElementById('modalTitle').textContent = '사용자 수정';
            document.getElementById('userId').value = user.id;
            document.getElementById('username').value = user.username || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('password').value = '';
            document.getElementById('role').value = user.role || 'USER';
            document.getElementById('passwordLabel').innerHTML = '비밀번호 <span class="optional">(선택)</span>';
            document.getElementById('passwordHint').style.display = 'block';
            document.getElementById('password').required = false;
            
            userModal.style.display = 'flex';
        }

        // 사용자 추가 모달 열기
        addUserBtn.addEventListener('click', () => {
            editingUserId = null;
            document.getElementById('modalTitle').textContent = '사용자 추가';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('passwordLabel').innerHTML = '비밀번호 <span class="required">*</span>';
            document.getElementById('passwordHint').style.display = 'none';
            document.getElementById('password').required = true;
            userModal.style.display = 'flex';
        });

        // 사용자 저장
        document.getElementById('saveUserBtn').addEventListener('click', async () => {
            const form = document.getElementById('userForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const userId = document.getElementById('userId').value;
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;

            const data = {
                username: username,
                email: email,
                role: role
            };

            if (userId) {
                // 수정
                data.id = parseInt(userId);
                if (password) {
                    data.password = password;
                }
                
                try {
                    const response = await axios.post('/api/admin/update', data);
                    if (response.data.returnCode === 'SUCCESS') {
                        showToast('사용자 정보가 수정되었습니다.');
                        userModal.style.display = 'none';
                        await loadUsers();
                    } else {
                        alert('수정 실패: ' + (response.data.errorMessage || '알 수 없는 오류'));
                    }
                } catch (error) {
                    console.error('사용자 수정 오류:', error);
                    alert('사용자 수정 중 오류가 발생했습니다: ' + (error.response?.data?.errorMessage || error.message));
                }
            } else {
                // 추가
                if (!password) {
                    alert('비밀번호를 입력해주세요.');
                    return;
                }
                data.password = password;

                try {
                    const response = await axios.post('/api/admin/register', data);
                    if (response.data.returnCode === 'SUCCESS') {
                        showToast('사용자가 추가되었습니다.');
                        userModal.style.display = 'none';
                        await loadUsers();
                    } else {
                        alert('추가 실패: ' + (response.data.errorMessage || '알 수 없는 오류'));
                    }
                } catch (error) {
                    console.error('사용자 추가 오류:', error);
                    alert('사용자 추가 중 오류가 발생했습니다: ' + (error.response?.data?.errorMessage || error.message));
                }
            }
        });

        // 사용자 삭제
        function deleteUser(userId) {
            deletingUserId = userId;
            const user = users.find(u => u.id === userId);
            if (user) {
                deleteModal.querySelector('.modal-body p').textContent = 
                    `정말 "${user.username}" 사용자를 삭제하시겠습니까?`;
            }
            deleteModal.style.display = 'flex';
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deletingUserId) return;

            try {
                const response = await axios.delete(`/api/admin/delete/${deletingUserId}`);
                if (response.data.returnCode === 'SUCCESS') {
                    showToast('사용자가 삭제되었습니다.');
                    deleteModal.style.display = 'none';
                    deletingUserId = null;
                    await loadUsers();
                } else {
                    alert('삭제 실패: ' + (response.data.errorMessage || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('사용자 삭제 오류:', error);
                alert('사용자 삭제 중 오류가 발생했습니다: ' + (error.response?.data?.errorMessage || error.message));
            }
        });

        // 모달 닫기
        document.getElementById('closeUserModal').addEventListener('click', () => {
            userModal.style.display = 'none';
        });

        document.getElementById('cancelUserBtn').addEventListener('click', () => {
            userModal.style.display = 'none';
        });

        document.getElementById('closeDetailModal').addEventListener('click', () => {
            userDetailModal.style.display = 'none';
        });

        document.getElementById('closeDetailBtn').addEventListener('click', () => {
            userDetailModal.style.display = 'none';
        });

        document.getElementById('closeDeleteModal').addEventListener('click', () => {
            deleteModal.style.display = 'none';
            deletingUserId = null;
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            deleteModal.style.display = 'none';
            deletingUserId = null;
        });

        // 모달 외부 클릭 시 닫기
        [userModal, userDetailModal, deleteModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // ESC 키로 모달 닫기
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                userModal.style.display = 'none';
                userDetailModal.style.display = 'none';
                deleteModal.style.display = 'none';
            }
        });

        // 검색 및 필터 이벤트
        // 페이지네이션 렌더링
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // 이전 버튼
            paginationHTML += `
                <button class="pagination-btn ${currentPage === 1 ? 'disabled' : ''}" 
                        ${currentPage === 1 ? 'disabled' : `onclick="loadUsers(${currentPage - 1})"`}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;

            // 페이지 번호 버튼
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                paginationHTML += `<button class="pagination-btn" onclick="loadUsers(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="pagination-ellipsis">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="loadUsers(${i})">
                        ${i}
                    </button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="pagination-ellipsis">...</span>`;
                }
                paginationHTML += `<button class="pagination-btn" onclick="loadUsers(${totalPages})">${totalPages}</button>`;
            }

            // 다음 버튼
            paginationHTML += `
                <button class="pagination-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                        ${currentPage === totalPages ? 'disabled' : `onclick="loadUsers(${currentPage + 1})"`}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;

            pagination.innerHTML = paginationHTML;
        }

        searchInput.addEventListener('input', () => {
            currentPage = 1;
            renderUsers();
            renderPagination();
        });
        roleFilter.addEventListener('change', () => {
            currentPage = 1;
            renderUsers();
            renderPagination();
        });

        // 초기 로드
        loadUsers(1);
    });
</script>
</th:block>
</body>
</html>

