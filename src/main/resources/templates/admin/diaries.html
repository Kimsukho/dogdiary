<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<head>
    <title>일지 관리</title>
</head>
<body>
<div layout:fragment="content">
    <div class="admin-users-page">
        <div class="admin-header">
            <h2><i class="fas fa-book-open"></i> 일지 관리</h2>
        </div>

        <!-- 검색 및 필터 영역 -->
        <div class="admin-search-filter">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="반려견 이름, 내용으로 검색...">
            </div>
            <div class="filter-box">
                <select id="moodFilter" class="filter-select">
                    <option value="">전체 기분</option>
                    <option value="HAPPY">행복</option>
                    <option value="SAD">슬픔</option>
                    <option value="ANGRY">화남</option>
                    <option value="EXCITED">신남</option>
                </select>
            </div>
            <div class="filter-box">
                <select id="userFilter" class="filter-select">
                    <option value="">전체 사용자</option>
                </select>
            </div>
        </div>

        <!-- 일지 목록 테이블 -->
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>반려견</th>
                        <th>기분</th>
                        <th>내용</th>
                        <th>작성일</th>
                        <th>수정일</th>
                        <th>작성자</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="diaryTableBody">
                    <tr>
                        <td colspan="8" class="loading-row">
                            <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 빈 상태 -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-book-open"></i>
            <p>등록된 일지가 없습니다.</p>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination-container" id="paginationContainer" style="display: none;">
            <div class="pagination" id="pagination">
                <!-- 페이지네이션 버튼이 여기에 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>

    <!-- 일지 상세 정보 모달 -->
    <div id="diaryDetailModal" class="modal-overlay" style="display: none;">
        <div class="modal-container admin-modal-container">
            <div class="modal-header">
                <h3>일지 상세 정보</h3>
                <button class="modal-close" id="closeDetailModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="diaryDetailContent">
                    <!-- 일지 상세 정보가 여기에 표시됩니다 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="button confirm-button" id="closeDetailBtn">닫기</button>
            </div>
        </div>
    </div>

    <!-- 일지 수정 모달 -->
    <div id="diaryEditModal" class="modal-overlay" style="display: none;">
        <div class="modal-container admin-modal-container">
            <div class="modal-header">
                <h3>일지 수정</h3>
                <button class="modal-close" id="closeEditModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="diaryEditForm">
                    <input type="hidden" id="diaryId">
                    <div class="form-field">
                        <label for="diaryDate">날짜 <span class="required">*</span></label>
                        <input type="date" id="diaryDate" required>
                    </div>
                    <div class="form-field">
                        <label for="diaryMood">기분 <span class="required">*</span></label>
                        <select id="diaryMood" required>
                            <option value="HAPPY">행복</option>
                            <option value="SAD">슬픔</option>
                            <option value="ANGRY">화남</option>
                            <option value="EXCITED">신남</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="diaryContent">내용</label>
                        <textarea id="diaryContent" rows="5" style="resize: vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="button cancel-button" id="cancelEditBtn">취소</button>
                <button class="button confirm-button" id="saveEditBtn">저장</button>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="deleteConfirmModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3>삭제 확인</h3>
                <button class="modal-close" id="closeDeleteModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>정말 이 일지를 삭제하시겠습니까?</p>
                <p class="warning-text">이 작업은 되돌릴 수 없습니다.</p>
            </div>
            <div class="modal-footer">
                <button class="button cancel-button" id="cancelDeleteBtn">취소</button>
                <button class="button confirm-button" id="confirmDeleteBtn">삭제</button>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const diaryTableBody = document.getElementById('diaryTableBody');
        const searchInput = document.getElementById('searchInput');
        const moodFilter = document.getElementById('moodFilter');
        const userFilter = document.getElementById('userFilter');
        const diaryDetailModal = document.getElementById('diaryDetailModal');
        const diaryEditModal = document.getElementById('diaryEditModal');
        const deleteModal = document.getElementById('deleteConfirmModal');
        
        let diaries = [];
        let users = [];
        let editingDiaryId = null;
        let deletingDiaryId = null;

        const moodLabelMap = {
            'HAPPY': '행복',
            'SAD': '슬픔',
            'ANGRY': '화남',
            'EXCITED': '신남'
        };

        const moodColorMap = {
            'HAPPY': '#FF6B9D',
            'SAD': '#1976D2',
            'ANGRY': '#C62828',
            'EXCITED': '#7B1FA2'
        };

        // 날짜 포맷팅 함수
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 내용 요약 함수
        function truncateContent(content, maxLength = 50) {
            if (!content) return '-';
            if (content.length <= maxLength) return content;
            return content.substring(0, maxLength) + '...';
        }

        // 사용자 목록 로드 (관리자 제외)
        async function loadUsers() {
            try {
                const response = await axios.get('/api/admin/getUserList');
                if (response.data.returnCode === 'SUCCESS') {
                    users = response.data.resultData.list || [];
                    userFilter.innerHTML = '<option value="">전체 사용자</option>';
                    // 관리자(ADMIN) 제외하고 일반 사용자만 필터 목록에 추가
                    users.filter(user => user.role !== 'ADMIN').forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username || `사용자 ${user.id}`;
                        userFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('사용자 목록 조회 오류:', error);
            }
        }

        // 페이지네이션 변수
        let currentPage = 1;
        const pageSize = 10;
        let totalPages = 1;
        let totalCount = 0;

        // 일지 목록 로드
        async function loadDiaries(page = 1) {
            try {
                currentPage = page;
                const userFilterValue = userFilter.value;
                
                let params = `page=1&size=10000`;
                if (userFilterValue) {
                    params += `&user_id=${userFilterValue}`;
                }
                
                const response = await axios.get(`/api/getAllDiaries?${params}`);
                if (response.data.returnCode === 'SUCCESS') {
                    const result = response.data.resultData;
                    let diaryList = result.list || [];
                    
                    const searchTerm = searchInput.value.toLowerCase();
                    const moodFilterValue = moodFilter.value;
                    
                    // 프론트엔드 필터링 (검색어, 기분)
                    let allFilteredDiaries = diaryList.filter(diary => {
                        const matchesSearch = !searchTerm || 
                            (diary.name && diary.name.toLowerCase().includes(searchTerm)) ||
                            (diary.content && diary.content.toLowerCase().includes(searchTerm));
                        const matchesMood = !moodFilterValue || diary.mood === moodFilterValue;
                        return matchesSearch && matchesMood;
                    });
                    
                    // 필터링된 결과 기준으로 페이지네이션 재계산
                    const filteredCount = allFilteredDiaries.length;
                    totalCount = filteredCount;
                    totalPages = Math.ceil(filteredCount / pageSize);
                    
                    // 현재 페이지가 필터링된 결과의 페이지 수를 초과하면 첫 페이지로 이동
                    if (currentPage > totalPages && totalPages > 0) {
                        currentPage = 1;
                    }
                    
                    // 현재 페이지에 해당하는 데이터만 표시
                    const startIndex = (currentPage - 1) * pageSize;
                    const endIndex = startIndex + pageSize;
                    diaries = allFilteredDiaries.slice(startIndex, endIndex);
                    
                    renderDiaries();
                    renderPagination();
                } else {
                    console.error('일지 목록 조회 실패:', response.data.errorMessage);
                    showToast('일지 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('일지 목록 조회 중 오류:', error);
                showToast('일지 목록을 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 전역 함수로 노출
        window.loadDiaries = loadDiaries;

        // 일지 목록 렌더링
        function renderDiaries() {
            diaryTableBody.innerHTML = '';

            if (diaries.length === 0) {
                diaryTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-row">
                            검색 결과가 없습니다.
                        </td>
                    </tr>
                `;
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }

            if (totalPages > 1) {
                document.getElementById('paginationContainer').style.display = 'flex';
            } else {
                document.getElementById('paginationContainer').style.display = 'none';
            }

            diaries.forEach(diary => {
                const row = document.createElement('tr');
                const user = users.find(u => u.id == diary.user_id);
                row.innerHTML = `
                    <td>${diary.id}</td>
                    <td>${diary.name || '-'}</td>
                    <td>
                        <span class="mood-badge" style="background: ${moodColorMap[diary.mood] || '#ccc'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${moodLabelMap[diary.mood] || diary.mood || '-'}
                        </span>
                    </td>
                    <td>${truncateContent(diary.content)}</td>
                    <td>${formatDate(diary.created_at)}</td>
                    <td>${formatDate(diary.last_updated)}</td>
                    <td>${user ? user.username : `사용자 ${diary.user_id}`}</td>
                    <td class="action-buttons">
                        <button class="action-btn view-btn" data-id="${diary.id}" title="상세 보기">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn edit-btn" data-id="${diary.id}" title="수정">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" data-id="${diary.id}" title="삭제">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                diaryTableBody.appendChild(row);
            });

            // 이벤트 리스너 추가
            attachEventListeners();
        }

        // 이벤트 리스너 연결
        function attachEventListeners() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const diaryId = parseInt(e.currentTarget.dataset.id);
                    showDiaryDetail(diaryId);
                });
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const diaryId = parseInt(e.currentTarget.dataset.id);
                    editDiary(diaryId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const diaryId = parseInt(e.currentTarget.dataset.id);
                    deleteDiary(diaryId);
                });
            });
        }

        // 일지 상세 정보 표시
        function showDiaryDetail(diaryId) {
            const diary = diaries.find(d => d.id === diaryId);
            if (!diary) return;

            const user = users.find(u => u.id == diary.user_id);
            const detailContent = document.getElementById('diaryDetailContent');
            detailContent.innerHTML = `
                <div class="user-detail-info">
                    <div class="detail-item">
                        <label>ID</label>
                        <span>${diary.id}</span>
                    </div>
                    <div class="detail-item">
                        <label>반려견</label>
                        <span>${diary.name || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <label>기분</label>
                        <span class="mood-badge" style="background: ${moodColorMap[diary.mood] || '#ccc'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${moodLabelMap[diary.mood] || diary.mood || '-'}
                        </span>
                    </div>
                    <div class="detail-item">
                        <label>내용</label>
                        <span style="white-space: pre-wrap;">${diary.content || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <label>작성일</label>
                        <span>${formatDate(diary.created_at)}</span>
                    </div>
                    <div class="detail-item">
                        <label>수정일</label>
                        <span>${formatDate(diary.last_updated)}</span>
                    </div>
                    <div class="detail-item">
                        <label>작성자</label>
                        <span>${user ? user.username : `사용자 ${diary.user_id}`}</span>
                    </div>
                </div>
            `;
            diaryDetailModal.style.display = 'flex';
        }

        // 일지 수정
        function editDiary(diaryId) {
            const diary = diaries.find(d => d.id === diaryId);
            if (!diary) return;

            editingDiaryId = diaryId;
            document.getElementById('diaryId').value = diary.id;
            
            const dateObj = new Date(diary.created_at);
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            document.getElementById('diaryDate').value = `${year}-${month}-${day}`;
            document.getElementById('diaryMood').value = diary.mood || 'HAPPY';
            document.getElementById('diaryContent').value = diary.content || '';
            
            diaryEditModal.style.display = 'flex';
        }

        // 일지 저장
        document.getElementById('saveEditBtn').addEventListener('click', async () => {
            const form = document.getElementById('diaryEditForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const diary = diaries.find(d => d.id === editingDiaryId);
            if (!diary) return;

            const data = {
                id: editingDiaryId,
                dog_id: diary.dog_id,
                mood: document.getElementById('diaryMood').value,
                content: document.getElementById('diaryContent').value,
                created_at: document.getElementById('diaryDate').value,
                user_id: diary.user_id // 관리자 수정을 위해 user_id 포함
            };

            try {
                const response = await axios.post('/api/updateDogDiaryByDogId', data);
                if (response.data.returnCode === 'SUCCESS') {
                    showToast('일지가 수정되었습니다.');
                    diaryEditModal.style.display = 'none';
                    await loadDiaries(currentPage);
                } else {
                    alert('수정 실패: ' + (response.data.errorMessage || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('일지 수정 오류:', error);
                alert('일지 수정 중 오류가 발생했습니다: ' + (error.response?.data?.errorMessage || error.message));
            }
        });

        // 일지 삭제
        function deleteDiary(diaryId) {
            deletingDiaryId = diaryId;
            deleteModal.style.display = 'flex';
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deletingDiaryId) return;

            try {
                const response = await axios.post('/api/deleteDogDiaryById', { id: deletingDiaryId });
                if (response.data.returnCode === 'SUCCESS') {
                    showToast('일지가 삭제되었습니다.');
                    deleteModal.style.display = 'none';
                    deletingDiaryId = null;
                    await loadDiaries(currentPage);
                } else {
                    alert('삭제 실패: ' + (response.data.errorMessage || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('일지 삭제 오류:', error);
                alert('일지 삭제 중 오류가 발생했습니다: ' + (error.response?.data?.errorMessage || error.message));
            }
        });

        // 모달 닫기
        document.getElementById('closeDetailModal').addEventListener('click', () => {
            diaryDetailModal.style.display = 'none';
        });

        document.getElementById('closeDetailBtn').addEventListener('click', () => {
            diaryDetailModal.style.display = 'none';
        });

        document.getElementById('closeEditModal').addEventListener('click', () => {
            diaryEditModal.style.display = 'none';
        });

        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            diaryEditModal.style.display = 'none';
        });

        document.getElementById('closeDeleteModal').addEventListener('click', () => {
            deleteModal.style.display = 'none';
            deletingDiaryId = null;
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            deleteModal.style.display = 'none';
            deletingDiaryId = null;
        });

        // 모달 외부 클릭 시 닫기
        [diaryDetailModal, diaryEditModal, deleteModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // ESC 키로 모달 닫기
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                diaryDetailModal.style.display = 'none';
                diaryEditModal.style.display = 'none';
                deleteModal.style.display = 'none';
            }
        });

        // 검색 및 필터 이벤트
        // 페이지네이션 렌더링
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';

            // 이전 버튼
            paginationHTML += `
                <button class="pagination-btn ${currentPage === 1 ? 'disabled' : ''}" 
                        ${currentPage === 1 ? 'disabled' : `onclick="loadDiaries(${currentPage - 1})"`}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;

            // 페이지 번호 버튼
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                paginationHTML += `<button class="pagination-btn" onclick="loadDiaries(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="pagination-ellipsis">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="loadDiaries(${i})">
                        ${i}
                    </button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="pagination-ellipsis">...</span>`;
                }
                paginationHTML += `<button class="pagination-btn" onclick="loadDiaries(${totalPages})">${totalPages}</button>`;
            }

            // 다음 버튼
            paginationHTML += `
                <button class="pagination-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                        ${currentPage === totalPages ? 'disabled' : `onclick="loadDiaries(${currentPage + 1})"`}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;

            pagination.innerHTML = paginationHTML;
        }

        searchInput.addEventListener('input', () => {
            currentPage = 1;
            loadDiaries(1);
        });
        moodFilter.addEventListener('change', () => {
            currentPage = 1;
            loadDiaries(1);
        });
        userFilter.addEventListener('change', () => {
            currentPage = 1;
            loadDiaries(1);
        });

        // 초기 로드
        loadUsers();
        loadDiaries(1);
    });
</script>
</th:block>
</body>
</html>

