<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<head>
    <title>산책 관리</title>
</head>
<body>
<div layout:fragment="content">
    <div class="admin-users-page">
        <div class="admin-header">
            <h2><i class="fas fa-walking"></i> 산책 관리</h2>
        </div>

        <!-- 검색 및 필터 영역 -->
        <div class="admin-search-filter">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="반려견 이름, 메모로 검색...">
            </div>
            <div class="filter-box">
                <select id="weatherFilter" class="filter-select">
                    <option value="">전체 날씨</option>
                    <option value="맑음">맑음</option>
                    <option value="흐림">흐림</option>
                    <option value="비">비</option>
                    <option value="눈">눈</option>
                </select>
            </div>
            <div class="filter-box">
                <select id="userFilter" class="filter-select">
                    <option value="">전체 사용자</option>
                </select>
            </div>
        </div>

        <!-- 산책 목록 테이블 -->
        <div class="admin-table-container">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>반려견</th>
                        <th>날짜</th>
                        <th>시간</th>
                        <th>날씨</th>
                        <th>메모</th>
                        <th>작성자</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody id="walkTableBody">
                    <tr>
                        <td colspan="8" class="loading-row">
                            <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 빈 상태 -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-walking"></i>
            <p>등록된 산책 기록이 없습니다.</p>
        </div>

        <!-- 페이지네이션 -->
        <div class="pagination-container" id="paginationContainer" style="display: none;">
            <div class="pagination" id="pagination">
                <!-- 페이지네이션 버튼이 여기에 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>

    <!-- 산책 상세 정보 모달 -->
    <div id="walkDetailModal" class="modal-overlay" style="display: none;">
        <div class="modal-container admin-modal-container">
            <div class="modal-header">
                <h3>산책 상세 정보</h3>
                <button class="modal-close" id="closeDetailModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="walkDetailContent">
                    <!-- 산책 상세 정보가 여기에 표시됩니다 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="button confirm-button" id="closeDetailBtn">닫기</button>
            </div>
        </div>
    </div>

    <!-- 산책 수정 모달 -->
    <div id="walkEditModal" class="modal-overlay" style="display: none;">
        <div class="modal-container admin-modal-container">
            <div class="modal-header">
                <h3>산책 수정</h3>
                <button class="modal-close" id="closeEditModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="walkEditForm">
                    <input type="hidden" id="walkId">
                    <div class="form-field">
                        <label for="walkDate">날짜 <span class="required">*</span></label>
                        <input type="date" id="walkDate" required>
                    </div>
                    <div class="form-field">
                        <label for="walkDuration">시간 (분)</label>
                        <input type="number" id="walkDuration" min="0" placeholder="예: 30">
                    </div>
                    <div class="form-field">
                        <label for="walkWeather">날씨</label>
                        <select id="walkWeather">
                            <option value="">선택 안함</option>
                            <option value="맑음">맑음</option>
                            <option value="흐림">흐림</option>
                            <option value="비">비</option>
                            <option value="눈">눈</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="walkMemo">메모</label>
                        <textarea id="walkMemo" rows="5" style="resize: vertical;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="button cancel-button" id="cancelEditBtn">취소</button>
                <button class="button confirm-button" id="saveEditBtn">저장</button>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div id="deleteConfirmModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h3>삭제 확인</h3>
                <button class="modal-close" id="closeDeleteModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>정말 이 산책 기록을 삭제하시겠습니까?</p>
                <p class="warning-text">이 작업은 되돌릴 수 없습니다.</p>
            </div>
            <div class="modal-footer">
                <button class="button cancel-button" id="cancelDeleteBtn">취소</button>
                <button class="button confirm-button" id="confirmDeleteBtn">삭제</button>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const walkTableBody = document.getElementById('walkTableBody');
        const searchInput = document.getElementById('searchInput');
        const weatherFilter = document.getElementById('weatherFilter');
        const userFilter = document.getElementById('userFilter');
        const walkDetailModal = document.getElementById('walkDetailModal');
        const walkEditModal = document.getElementById('walkEditModal');
        const deleteModal = document.getElementById('deleteConfirmModal');
        
        let walks = [];
        let users = [];
        let editingWalkId = null;
        let deletingWalkId = null;

        // 날짜 포맷팅 함수
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // 메모 요약 함수
        function truncateContent(content, maxLength = 50) {
            if (!content) return '-';
            if (content.length <= maxLength) return content;
            return content.substring(0, maxLength) + '...';
        }

        // 사용자 목록 로드 (관리자 제외)
        async function loadUsers() {
            try {
                const response = await axios.get('/api/admin/getUserList');
                if (response.data.returnCode === 'SUCCESS') {
                    users = response.data.resultData.list || [];
                    userFilter.innerHTML = '<option value="">전체 사용자</option>';
                    // 관리자(ADMIN) 제외하고 일반 사용자만 필터 목록에 추가
                    users.filter(user => user.role !== 'ADMIN').forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username || `사용자 ${user.id}`;
                        userFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('사용자 목록 조회 오류:', error);
            }
        }

        // 페이지네이션 변수
        let currentPage = 1;
        const pageSize = 10;
        let totalPages = 1;
        let totalCount = 0;

        // 산책 목록 로드
        async function loadWalks(page = 1) {
            try {
                currentPage = page;
                const userFilterValue = userFilter.value;
                
                let params = `page=1&size=10000`;
                if (userFilterValue) {
                    params += `&user_id=${userFilterValue}`;
                }
                
                const response = await axios.get(`/api/admin/getAllWalks?${params}`);
                if (response.data.returnCode === 'SUCCESS') {
                    const result = response.data.resultData;
                    let walkList = result.list || [];
                    
                    // 프론트엔드 필터링 (검색어, 날씨)
                    const searchTerm = searchInput.value.toLowerCase();
                    const weatherFilterValue = weatherFilter.value;
                    
                    let allFilteredWalks = walkList.filter(walk => {
                        const matchesSearch = !searchTerm || 
                            (walk.dog_name && walk.dog_name.toLowerCase().includes(searchTerm)) ||
                            (walk.memo && walk.memo.toLowerCase().includes(searchTerm));
                        const matchesWeather = !weatherFilterValue || walk.weather === weatherFilterValue;
                        return matchesSearch && matchesWeather;
                    });
                    
                    // 필터링된 결과 기준으로 페이지네이션 재계산
                    const filteredCount = allFilteredWalks.length;
                    totalCount = filteredCount;
                    totalPages = Math.ceil(filteredCount / pageSize);
                    
                    // 현재 페이지가 필터링된 결과의 페이지 수를 초과하면 첫 페이지로 이동
                    if (currentPage > totalPages && totalPages > 0) {
                        currentPage = 1;
                    }
                    
                    // 현재 페이지에 해당하는 데이터만 표시
                    const startIndex = (currentPage - 1) * pageSize;
                    const endIndex = startIndex + pageSize;
                    walks = allFilteredWalks.slice(startIndex, endIndex);
                    
                    renderWalks();
                    renderPagination();
                } else {
                    console.error('산책 목록 조회 실패:', response.data.errorMessage);
                    showToast('산책 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('산책 목록 조회 중 오류:', error);
                showToast('산책 목록을 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 전역 함수로 노출
        window.loadWalks = loadWalks;

        // 산책 목록 렌더링
        function renderWalks() {
            walkTableBody.innerHTML = '';

            if (walks.length === 0) {
                walkTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-row">
                            검색 결과가 없습니다.
                        </td>
                    </tr>
                `;
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }

            if (totalPages > 1) {
                document.getElementById('paginationContainer').style.display = 'flex';
            } else {
                document.getElementById('paginationContainer').style.display = 'none';
            }

            walks.forEach(walk => {
                const row = document.createElement('tr');
                const user = users.find(u => u.id == walk.user_id);
                row.innerHTML = `
                    <td>${walk.id}</td>
                    <td>${walk.dog_name || '-'}</td>
                    <td>${formatDate(walk.date)}</td>
                    <td>${walk.duration ? walk.duration + '분' : '-'}</td>
                    <td>${walk.weather || '-'}</td>
                    <td>${truncateContent(walk.memo)}</td>
                    <td>${user ? user.username : `사용자 ${walk.user_id}`}</td>
                    <td class="action-buttons">
                        <button class="action-btn view-btn" data-id="${walk.id}" title="상세 보기">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn edit-btn" data-id="${walk.id}" title="수정">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" data-id="${walk.id}" title="삭제">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                walkTableBody.appendChild(row);
            });

            // 이벤트 리스너 추가
            attachEventListeners();
        }

        // 이벤트 리스너 연결
        function attachEventListeners() {
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const walkId = parseInt(e.currentTarget.dataset.id);
                    showWalkDetail(walkId);
                });
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const walkId = parseInt(e.currentTarget.dataset.id);
                    editWalk(walkId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const walkId = parseInt(e.currentTarget.dataset.id);
                    deleteWalk(walkId);
                });
            });
        }

        // 산책 상세 정보 표시
        function showWalkDetail(walkId) {
            const walk = walks.find(w => w.id === walkId);
            if (!walk) return;

            const user = users.find(u => u.id == walk.user_id);
            const detailContent = document.getElementById('walkDetailContent');
            detailContent.innerHTML = `
                <div class="user-detail-info">
                    <div class="detail-item">
                        <label>ID</label>
                        <span>${walk.id}</span>
                    </div>
                    <div class="detail-item">
                        <label>반려견</label>
                        <span>${walk.dog_name || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <label>날짜</label>
                        <span>${formatDate(walk.date)}</span>
                    </div>
                    <div class="detail-item">
                        <label>시간</label>
                        <span>${walk.duration ? walk.duration + '분' : '-'}</span>
                    </div>
                    <div class="detail-item">
                        <label>날씨</label>
                        <span>${walk.weather || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <label>메모</label>
                        <span style="white-space: pre-wrap;">${walk.memo || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <label>작성자</label>
                        <span>${user ? user.username : `사용자 ${walk.user_id}`}</span>
                    </div>
                    <div class="detail-item">
                        <label>작성일</label>
                        <span>${formatDate(walk.created_at)}</span>
                    </div>
                    <div class="detail-item">
                        <label>수정일</label>
                        <span>${formatDate(walk.updated_at)}</span>
                    </div>
                </div>
            `;
            walkDetailModal.style.display = 'flex';
        }

        // 산책 수정
        function editWalk(walkId) {
            const walk = walks.find(w => w.id === walkId);
            if (!walk) return;

            editingWalkId = walkId;
            document.getElementById('walkId').value = walk.id;
            
            const dateObj = new Date(walk.date);
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            document.getElementById('walkDate').value = `${year}-${month}-${day}`;
            document.getElementById('walkDuration').value = walk.duration || '';
            document.getElementById('walkWeather').value = walk.weather || '';
            document.getElementById('walkMemo').value = walk.memo || '';
            
            walkEditModal.style.display = 'flex';
        }

        // 산책 저장
        document.getElementById('saveEditBtn').addEventListener('click', async () => {
            const form = document.getElementById('walkEditForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const walk = walks.find(w => w.id === editingWalkId);
            if (!walk) return;

            const data = {
                id: editingWalkId,
                dog_id: walk.dog_id,
                date: document.getElementById('walkDate').value,
                duration: document.getElementById('walkDuration').value ? parseInt(document.getElementById('walkDuration').value) : null,
                weather: document.getElementById('walkWeather').value || null,
                memo: document.getElementById('walkMemo').value || null,
                user_id: walk.user_id // 관리자 수정을 위해 user_id 포함
            };

            try {
                const response = await axios.post('/api/updateWalk', data);
                if (response.data.returnCode === 'SUCCESS') {
                    showToast('산책 기록이 수정되었습니다.');
                    walkEditModal.style.display = 'none';
                    await loadWalks(currentPage);
                } else {
                    alert('수정 실패: ' + (response.data.errorMessage || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('산책 수정 오류:', error);
                alert('산책 수정 중 오류가 발생했습니다: ' + (error.response?.data?.errorMessage || error.message));
            }
        });

        // 산책 삭제
        function deleteWalk(walkId) {
            deletingWalkId = walkId;
            deleteModal.style.display = 'flex';
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deletingWalkId) return;

            try {
                const response = await axios.post('/api/deleteWalk', { id: deletingWalkId });
                if (response.data.returnCode === 'SUCCESS') {
                    showToast('산책 기록이 삭제되었습니다.');
                    deleteModal.style.display = 'none';
                    deletingWalkId = null;
                    await loadWalks(currentPage);
                } else {
                    alert('삭제 실패: ' + (response.data.errorMessage || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('산책 삭제 오류:', error);
                alert('산책 삭제 중 오류가 발생했습니다: ' + (error.response?.data?.errorMessage || error.message));
            }
        });

        // 모달 닫기
        document.getElementById('closeDetailModal').addEventListener('click', () => {
            walkDetailModal.style.display = 'none';
        });

        document.getElementById('closeDetailBtn').addEventListener('click', () => {
            walkDetailModal.style.display = 'none';
        });

        document.getElementById('closeEditModal').addEventListener('click', () => {
            walkEditModal.style.display = 'none';
        });

        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            walkEditModal.style.display = 'none';
        });

        document.getElementById('closeDeleteModal').addEventListener('click', () => {
            deleteModal.style.display = 'none';
            deletingWalkId = null;
        });

        document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
            deleteModal.style.display = 'none';
            deletingWalkId = null;
        });

        // 모달 외부 클릭 시 닫기
        [walkDetailModal, walkEditModal, deleteModal].forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // ESC 키로 모달 닫기
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                walkDetailModal.style.display = 'none';
                walkEditModal.style.display = 'none';
                deleteModal.style.display = 'none';
            }
        });

        // 검색 및 필터 이벤트
        // 페이지네이션 렌더링
        function renderPagination() {
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // 이전 버튼
            paginationHTML += `
                <button class="pagination-btn ${currentPage === 1 ? 'disabled' : ''}" 
                        ${currentPage === 1 ? 'disabled' : `onclick="loadWalks(${currentPage - 1})"`}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;

            // 페이지 번호 버튼
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                paginationHTML += `<button class="pagination-btn" onclick="loadWalks(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="pagination-ellipsis">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" 
                            onclick="loadWalks(${i})">
                        ${i}
                    </button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span class="pagination-ellipsis">...</span>`;
                }
                paginationHTML += `<button class="pagination-btn" onclick="loadWalks(${totalPages})">${totalPages}</button>`;
            }

            // 다음 버튼
            paginationHTML += `
                <button class="pagination-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                        ${currentPage === totalPages ? 'disabled' : `onclick="loadWalks(${currentPage + 1})"`}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;

            pagination.innerHTML = paginationHTML;
        }

        searchInput.addEventListener('input', () => {
            currentPage = 1;
            loadWalks(1);
        });
        weatherFilter.addEventListener('change', () => {
            currentPage = 1;
            loadWalks(1);
        });
        userFilter.addEventListener('change', () => {
            currentPage = 1;
            loadWalks(1);
        });

        // 초기 로드
        loadUsers();
        loadWalks(1);
    });
</script>
</th:block>
</body>
</html>

