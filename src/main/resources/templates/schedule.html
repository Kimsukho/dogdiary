<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<head>
    <title>ì¼ì • ê´€ë¦¬</title>
</head>
<body>
<div layout:fragment="content">
    <div class="schedule-page">
        <div class="schedule-calendar-container">
            <div class="schedule-calendar-header">
                <div class="schedule-calendar-selectors">
                    <div class="select-wrapper">
                        <select id="yearSelect" class="styled-select"></select>
                    </div>
                    <div class="select-wrapper">
                        <select id="monthSelect" class="styled-select"></select>
                    </div>
                </div>

                <div class="calendar-controls">
                    <button id="prevMonthBtn" class="icon-btn"><i class="fas fa-chevron-left"></i></button>
                    <button id="nextMonthBtn" class="icon-btn"><i class="fas fa-chevron-right"></i></button>
                    <button class="today-btn" id="todayButton"><i class="fas fa-calendar-day"></i> ì˜¤ëŠ˜</button>
                </div>
            </div>

            <div class="schedule-calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="schedule-detail-panel" id="scheduleDetail">
            <h3>ğŸ“Œ ì¼ì • ìƒì„¸</h3>
            <div class="detail-content">
                <p class="placeholder">ì¼ì •ì„ í´ë¦­í•˜ë©´ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <div class="floating-menu">
        <button id="mainFab" class="fab main-fab">ï¼‹</button>
        <div class="fab-menu">
            <button class="fab-item" data-target="walkModal"><i class="fas fa-walking"></i><span>ì‚°ì±…</span></button>
            <button class="fab-item" data-target="hospitalModal"><i class="fas fa-clinic-medical"></i><span>ë³‘ì› ê¸°ë¡</span></button>
        </div>
    </div>

    <!-- ğŸ¦® ì‚°ì±… ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="walkModal" class="diaryModal hidden">
        <div class="modal-content">
            <h3>ì‚°ì±… ê¸°ë¡</h3>
            <input type="hidden" id="walkId">
            <select id="walkDogSelect" required>
                <option value="" selected hidden>ë°˜ë ¤ê²¬ ì„ íƒ</option>
            </select>
             <div class="walkModal-item">
                <label>ë‚ ì§œ</label>
                <input type="date" id="walkDate" readonly>
            </div>
            <div class="walkModal-item">
                <label>ì‚°ì±… ì‹œê°„ (ë¶„)</label>
                <input type="number" id="walkDuration" placeholder="ì˜ˆ: 30">
            </div>
            <div class="walkModal-item">
                <label>ë‚ ì”¨</label>
                <input type="text" id="walkWeather" placeholder="ì˜ˆ: ë§‘ìŒ / íë¦¼">
            </div>
            <textarea id="walkMemo" placeholder="ì‚°ì±… ì¤‘ íŠ¹ì´ì‚¬í•­ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
            <div class="modal-buttons">
                <button class="button save-button" id="saveWalkBtn">ì €ì¥</button>
                <button class="button close-button" id="closeWalkModalBtn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ğŸ¥ ë³‘ì› ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="hospitalModal" class="diaryModal hidden">
        <div class="modal-content">
            <h3>ë³‘ì› ê¸°ë¡</h3>
            <input type="hidden" id="hospitalId">
            <select id="hospitalDogSelect" required>
                <option value="" selected hidden>ë°˜ë ¤ê²¬ ì„ íƒ</option>
            </select>
            <div class="hospitalModal-item">
                <label>ë‚ ì§œ</label>
                <input type="date" id="hospitalDate" readonly>
            </div>
            <div class="hospitalModal-item">
                <label>ë³‘ì› ì´ë¦„</label>
                <input type="text" id="hospitalName" placeholder="ë³‘ì›ëª… ì…ë ¥">
            </div>
            <div class="hospitalModal-item">
                <label>ì§„ë£Œ í•­ëª©</label>
                <input type="text" id="hospitalDiagnosis" placeholder="ì˜ˆ: ì •ê¸°ê²€ì§„, ì˜ˆë°©ì ‘ì¢… ë“±">
            </div>
            <div class="hospitalModal-item">
                <label>ë¹„ìš© (ì›)</label>
                <input type="number" id="hospitalCost" placeholder="ì˜ˆ: 45000">
            </div>
            <textarea id="hospitalMemo" placeholder="ì§„ë£Œ ë‚´ìš©, ì²˜ë°© ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
            <div class="modal-buttons">
                <button class="button save-button" id="saveHospitalBtn">ì €ì¥</button>
                <button class="button close-button" id="closeHospitalModalBtn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ğŸ—‘ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3>ì‚­ì œ í™•ì¸</h3>
            <p>ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="modal-buttons">
                <button class="button confirm-button" id="confirmDeleteBtn">ì‚­ì œ</button>
                <button class="button cancel-button" id="cancelDeleteBtn">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ“œ ìŠ¤í¬ë¦½íŠ¸ -->
<th:block layout:fragment="script">
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const calendarGrid = document.getElementById("calendarGrid");
        const yearSelect = document.getElementById("yearSelect");
        const monthSelect = document.getElementById("monthSelect");
        const todayButton = document.getElementById("todayButton");
        const detailPanel = document.getElementById("scheduleDetail");
        const detailContent = document.getElementById("scheduleDetail").querySelector(".detail-content");

        const mainFab = document.getElementById("mainFab");
        const fabMenu = document.querySelector(".fab-menu");

        const saveWalkBtn = document.getElementById("saveWalkBtn");
        const saveHospitalBtn = document.getElementById("saveHospitalBtn");
    
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();

        let schedules = [];
        let selectedDate = `${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;


        function initSelectors(){
            for(let y=today.getFullYear()-5; y<=today.getFullYear()+5; y++){
                const opt=document.createElement("option"); 
                opt.value=y; opt.textContent=`${y}ë…„`; 
                if(y===currentYear) opt.selected=true; 
                yearSelect.appendChild(opt);
            }
            for(let m=0; m<12; m++){
                const opt=document.createElement("option"); 
                opt.value=m; opt.textContent=`${m+1}ì›”`;
                if(m===currentMonth) opt.selected=true; 
                monthSelect.appendChild(opt);
            }
            yearSelect.addEventListener("change", () => { 
                currentYear=parseInt(yearSelect.value); 
                renderCalendar(); 
            });
            monthSelect.addEventListener("change", () => { 
                currentMonth=parseInt(monthSelect.value); 
                renderCalendar(); 
            });
        }

        async function loadMonthlySchedules(year, month) {
            try {
                const formattedMonth = `${year}-${String(month + 1).padStart(2, "0")}`;
                const response = await axios.get(`/api/getSchedulesByMonth`, {
                    params: { user_id: 3, month: formattedMonth }
                });
                if(response.data.returnCode === "SUCCESS"){
                    return response.data.resultData || [];
                }
                return [];
            } catch (error) {
                console.error("ì›”ë³„ ì¼ì • ì¡°íšŒ ì‹¤íŒ¨:", error);
                return [];
            }
        }

        async function renderCalendar(){
            calendarGrid.innerHTML = "";
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth+1,0);
            const startDay = firstDay.getDay();

            schedules = await loadMonthlySchedules(currentYear, currentMonth);

            for(let i=0;i<startDay;i++){
                const emptyDiv=document.createElement("div"); 
                emptyDiv.classList.add("schedule-calendar-day","empty");
                calendarGrid.appendChild(emptyDiv);
            }

            for(let day=1; day<=lastDay.getDate(); day++){
                const div=document.createElement("div"); 
                div.classList.add("schedule-calendar-day");

                const num=document.createElement("div"); 
                num.classList.add("schedule-calendar-day-number"); 
                num.textContent=day; 
                div.appendChild(num);

                const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
                const daySchedules = schedules.filter(s=>s.date===dateStr);
                
                daySchedules.forEach(s => {
                    const item = document.createElement("div");
                    item.classList.add("schedule-item", s.type);
                    item.textContent = s.type === "walk" ? `ì‚°ì±…: ${s.dog_name || '-'}` : `ë³‘ì›: ${s.hospital_name || '-'}`;
                    
                    item.addEventListener("click", (e) => {
                        e.stopPropagation();
                        document.querySelectorAll(".schedule-item").forEach(si => si.classList.remove("selected"));
                        item.classList.add("selected");

                        showDetail(s);
                    });

                    div.appendChild(item);
                });

                div.addEventListener("click", () => {
                    selectedDate = dateStr;
                    document.querySelectorAll(".schedule-calendar-day").forEach(d => d.classList.remove("selected"));
                    div.classList.add("selected");

                    const daySchedules = schedules.filter(s => s.date === selectedDate);
                    if(daySchedules.length){
                        detailContent.innerHTML = "";
                        daySchedules.forEach(s => showDetail(s));
                    } else {
                        detailContent.innerHTML = `<p class="placeholder">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    }
                });

                if (currentYear === today.getFullYear() && currentMonth === today.getMonth() && day === today.getDate()) {
                    div.classList.add("today");
                }

                calendarGrid.appendChild(div);
            }
            const todaySchedule = schedules.find(s=>s.date===selectedDate);
            if(todaySchedule){
                showDetail(todaySchedule);
            } else {
                document.querySelector("#scheduleDetail h3").textContent = `ğŸ“Œ ì¼ì • ìƒì„¸ (${selectedDate})`;
                detailContent.innerHTML = `<p class="placeholder">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
        }

        // async function renderSchedulesByDate(date) {
        //     const calendarGrid = document.getElementById("calendarGrid");
        //     const detailContent = document.querySelector("#scheduleDetail .detail-content");

        //     const [year, month] = date.split("-"); 
        //     const monthStr = `${year}-${month}`;
        //     const schedules = await loadMonthlySchedules(year, parseInt(month)-1); // loadMonthlySchedulesëŠ” ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš©

        //     const daySchedules = schedules.filter(s => s.date === date);

        //     document.querySelectorAll(".schedule-calendar-day").forEach(d => d.classList.remove("selected"));
        //     const day = parseInt(date.split("-")[2], 10);
        //     const targetDay = Array.from(document.querySelectorAll(".schedule-calendar-day-number"))
        //         .find(d => parseInt(d.textContent, 10) === day);
        //     if (targetDay) targetDay.parentElement.classList.add("selected");

        //     if (daySchedules.length) {
        //         detailContent.innerHTML = "";
        //         daySchedules.forEach(s => showDetail(s));
        //     } else {
        //         detailContent.innerHTML = `<p class="placeholder">ì¼ì •ì„ í´ë¦­í•˜ë©´ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>`;
        //     }
        // }


        async function loadDogs(selectElement){
            try{
                const response = await axios.get("/api/getDogsByUserId", { params: { userId: 1 } });
                if(response.data.returnCode==="SUCCESS"){
                    selectElement.innerHTML='<option selected hidden value="">ë°˜ë ¤ê²¬ ì„ íƒ</option>';
                    response.data.resultData.forEach(dog=>{
                        const opt=document.createElement("option");
                        opt.value=dog.id;
                        opt.textContent=dog.name;
                        selectElement.appendChild(opt);
                    });
                }
            } catch(e){ console.error("ë°˜ë ¤ê²¬ ì¡°íšŒ ì‹¤íŒ¨", e); }
        }

        function openModal(modalId, schedule = null) {
            document.querySelectorAll(".diaryModal").forEach(m => {
                m.classList.add("hidden");
                m.style.opacity=0;
            });

            const modal=document.getElementById(modalId);
            modal.classList.remove("hidden");
            modal.style.transition="opacity 0.3s ease";
            setTimeout(()=> modal.style.opacity=1, 0);

            if(modalId==="walkModal"){
                const walkSelect = document.getElementById("walkDogSelect");
                const dateInput = document.getElementById("walkDate");
                dateInput.value = schedule?.date || selectedDate;
                dateInput.readOnly = true;
                loadDogs(walkSelect).then(()=>{ walkSelect.value = schedule?.dog_id || ""; });

                document.getElementById("walkId").value = schedule?.id || "";
                document.getElementById("walkDuration").value = schedule?.duration || "";
                document.getElementById("walkWeather").value = schedule?.weather || "";
                document.getElementById("walkMemo").value = schedule?.desc || "";
            } else if(modalId==="hospitalModal"){
                const hospitalSelect = document.getElementById("hospitalDogSelect");
                const dateInput = document.getElementById("hospitalDate");
                dateInput.value = schedule?.date || selectedDate;
                dateInput.readOnly = true;
                loadDogs(hospitalSelect).then(()=>{ hospitalSelect.value = schedule?.dog_id || ""; });

                document.getElementById("hospitalId").value = schedule?.id || "";
                document.getElementById("hospitalName").value = schedule?.hospitalName || "";
                document.getElementById("hospitalDiagnosis").value = schedule?.diagnosis || "";
                document.getElementById("hospitalCost").value = schedule?.cost || "";
                document.getElementById("hospitalMemo").value = schedule?.desc || "";
            }
        }

        function showDetail(schedule){
            let content = `
                <div class="detail-card ${schedule.type}">
                    <h4>${schedule.type =="walk" ? "ì‚°ì±…": "ë³‘ì›"}</h4>
                    <p><strong>ğŸ“… ë‚ ì§œ:</strong> ${schedule.date}</p>
                    <p><strong>ğŸ¶ ë°˜ë ¤ê²¬:</strong> ${schedule.dog_name || "-"}</p>
            `;
            if(schedule.type === "walk"){
                content += `
                    <p><strong>â± ì‹œê°„:</strong> ${schedule.duration || "-"} ë¶„</p>
                    <p><strong>ğŸŒ¤ ë‚ ì”¨:</strong> ${schedule.weather || "-"}</p>
                `;
            } else {
                content += `
                    <p><strong>ğŸ¥ ë³‘ì›ëª…:</strong> ${schedule.hospital_name || "-"}</p>
                    <p><strong>ğŸ’‰ ì§„ë£Œ í•­ëª©:</strong> ${schedule.diagnosis || "-"}</p>
                    <p><strong>ğŸ’° ë¹„ìš©:</strong> ${schedule.cost || "-"} ì›</p>
                `;
            }
            content += `<p><strong>ğŸ“ ë©”ëª¨:</strong> ${schedule.desc || "-"}</p>
                <div class="detail-actions">
                    <button class="edit-btn" title="ìˆ˜ì •"><i class="fas fa-pencil-alt"></i></button>
                    <button class="delete-btn" title="ì‚­ì œ"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`;
            detailContent.innerHTML = content;

            detailContent.querySelector(".edit-btn").addEventListener("click", ()=>{
                saveWalkBtn.textContent = "ìˆ˜ì •";
                openModal(schedule.type==="walk"?"walkModal":"hospitalModal", schedule);
            });

            detailContent.querySelector(".delete-btn").addEventListener("click", ()=>{
                const modal=document.getElementById("deleteConfirmModal"); 
                modal.style.display="flex";
                const confirmBtn=document.getElementById("confirmDeleteBtn");
                const cancelBtn=document.getElementById("cancelDeleteBtn");
                confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));

                document.getElementById("confirmDeleteBtn").addEventListener("click", async ()=>{
                    try{
                        if(schedule.type==="walk"){
                            await axios.post("/api/deleteWalk", { id: schedule.id });
                        } else {
                            await axios.post("/api/deleteHospital", { id: schedule.id });
                        }
                        schedules = schedules.filter(s=>s.id!==schedule.id);
                        await renderCalendar();
                        detailContent.innerHTML=`<p class="placeholder">ì˜¤ëŠ˜ (${selectedDate}) ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                        modal.style.display="none";
                    } catch(e){ console.error(e); alert("ì‚­ì œ ì‹¤íŒ¨"); }
                });

                document.getElementById("cancelDeleteBtn").addEventListener("click", ()=>{ modal.style.display="none"; });
            });
        }

        saveWalkBtn.addEventListener("click", async ()=>{
            const id = document.getElementById("walkId").value;
            const walkData = {
                user_id: 3,
                dog_id: document.getElementById("walkDogSelect").value,
                duration: parseInt(document.getElementById("walkDuration").value || 0),
                weather: document.getElementById("walkWeather").value,
                memo: document.getElementById("walkMemo").value,
                date: selectedDate
            };
            const url = id ? "/api/updateWalk" : "/api/createWalk";
            try{
                const response = await axios.post(url, id? { id, ...walkData }: walkData, { headers: { "Content-Type": "application/json" }});
                
                if(response.data.returnCode === "SUCCESS") {
                    alert("ì €ì¥ ì™„ë£Œ!");
                    document.getElementById("walkModal").classList.add("hidden");
                    await renderCalendar();
                }
            } catch(e){ console.error(e); alert("ì €ì¥ ì˜¤ë¥˜"); }
        });

        saveHospitalBtn.addEventListener("click", async ()=>{
            const id = document.getElementById("hospitalId").value;
            const hospitalData = {
                user_id: 3,
                dog_id: document.getElementById("hospitalDogSelect").value,
                hospital_name: document.getElementById("hospitalName").value,
                diagnosis: document.getElementById("hospitalDiagnosis").value,
                cost: parseInt(document.getElementById("hospitalCost").value || 0),
                memo: document.getElementById("hospitalMemo").value,
                date: selectedDate
            };
            const url = id ? "/api/updateHospital" : "/api/createHospital";

            try {
                const response = await axios.post(url, id ? { id, ...hospitalData } : hospitalData, { headers: { "Content-Type": "application/json" }});

                if (response.data.returnCode === "SUCCESS") {
                    alert("ì €ì¥ ì™„ë£Œ!");
                    document.getElementById("hospitalModal").classList.add("hidden");
                    await renderCalendar();
                }
            } catch(e){ console.error(e); alert("ì €ì¥ ì˜¤ë¥˜"); }
        });

        mainFab.addEventListener("click", () => {
            fabMenu.classList.toggle("show");
        });

        document.querySelectorAll(".fab-item").forEach(item=>{
            item.addEventListener("click", ()=>{
                openModal(item.dataset.target);
                saveWalkBtn.textContent = "ì €ì¥";
                fabMenu.classList.remove("show");
            });
        });

        document.querySelectorAll(".close-button").forEach(btn=>{
            btn.addEventListener("click", ()=>{
                btn.closest(".diaryModal").classList.add("hidden");
            });
        });

        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                fabMenu.classList.remove("show");
                document.querySelectorAll(".diaryModal").forEach(m => {
                    m.classList.add("hidden");
                    m.style.display = "none";
                });
            }
        });

        todayButton.addEventListener("click", async () => {
            currentYear=today.getFullYear();
            currentMonth=today.getMonth();
            yearSelect.value=currentYear;
            monthSelect.value=currentMonth;
            renderCalendar();
        });

        initSelectors();
        renderCalendar();
    });
</script>
</th:block>
</body>
</html>
