<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<head>
    <title>일정 관리</title>
</head>
<body>
<div layout:fragment="content">
    <div class="diary-page">
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prevMonthBtn">◀</button>
                <h3 id="currentMonth"></h3>
                <button id="nextMonthBtn">▶</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="diary-content">
            <div class="summary-container">
                <div class="summary-item">
                    <div class="summary-value" id="currentMonthTotalCount">0</div>
                    <div class="summary-label" id="currentMonthLabel">0월 총 일지</div>
                </div>
                <div class="summary-item"><div class="summary-value" id="happyCount">0</div><div class="summary-label">😊 행복</div></div>
                <div class="summary-item"><div class="summary-value" id="sadCount">0</div><div class="summary-label">😢 슬픔</div></div>
                <div class="summary-item"><div class="summary-value" id="angryCount">0</div><div class="summary-label">😡 화남</div></div>
                <div class="summary-item"><div class="summary-value" id="excitedCount">0</div><div class="summary-label">🤩 신남</div></div>
            </div>

            <div class="diary-cards" id="diaryCards">
                <div id="emptyCard" class="empty-card">등록된 일지가 없습니다.</div>
            </div>
        </div>
    </div>

    <div class="floating-menu">
        <button id="mainFab" class="fab main-fab">＋</button>

        <div class="fab-menu">
            <button class="fab-item" data-target="diaryModal">
                <i class="fas fa-book"></i><span>일지 작성</span>
            </button>
            <button class="fab-item" data-target="walkModal">
                <i class="fas fa-walking"></i><span>산책</span>
            </button>
            <button class="fab-item" data-target="hospitalModal">
                <i class="fas fa-clinic-medical"></i><span>병원 기록</span>
            </button>
        </div>
    </div>

    <!-- 각각의 모달 -->    
    <div id="diaryModal" class="diaryModal hidden">
        <div class="modal-content">
            <h3 id="modalTitle">일지 작성</h3>
            <input type="hidden" id="diaryId" name="diaryId" />
            <select id="diaryDogSelect" required="required">
                <option value="" selected hidden>반려견 선택</option>
            </select>
            <select id="diaryMood" required="required">
                <option value="" selected hidden>기분 선택</option>
                <option value="HAPPY">행복</option>
                <option value="SAD">슬픔</option>
                <option value="ANGRY">화남</option>
                <option value="EXCITED">신남</option>
            </select>
            <textarea id="diaryContent" placeholder="내용"></textarea>
            <div class="modal-buttons">
                <button class="button save-button" id="saveDiaryBtn">저장</button>
                <button class="button close-button" id="closeModalBtn">닫기</button>
            </div>
        </div>
    </div>

    <!-- 🦮 산책 기록 모달 -->
    <div id="walkModal" class="diaryModal hidden">
        <div class="modal-content">
            <h3>산책 기록</h3>
            <input type="hidden" id="walkId">

            <select id="walkDogSelect" required>
                <option value="" selected hidden>반려견 선택</option>
            </select>

            <div class="walkModal-item">
                <label>산책 거리 (km)</label>
                <input type="number" id="walkDistance" placeholder="예: 2.5" step="0.1">
            </div>

            <div class="walkModal-item">
                <label>산책 시간 (분)</label>
                <input type="number" id="walkDuration" placeholder="예: 30">
            </div>

            <div class="walkModal-item">
                <label>날씨</label>
                <input type="text" id="walkWeather" placeholder="예: 맑음 / 흐림">
            </div>

            <textarea id="walkMemo" placeholder="산책 중 특이사항을 기록하세요."></textarea>

            <div class="modal-buttons">
                <button class="button save-button" id="saveWalkBtn">저장</button>
                <button class="button close-button" id="closeWalkModalBtn">닫기</button>
            </div>
        </div>
    </div>

    <!-- 🏥 병원 기록 모달 -->
    <div id="hospitalModal" class="diaryModal hidden">
        <div class="modal-content">
            <h3>병원 기록</h3>
            <input type="hidden" id="hospitalId">

            <select id="hospitalDogSelect" required>
                <option value="" selected hidden>반려견 선택</option>
            </select>

            <div class="hospitalModal-item">
                <label>병원 이름</label>
                <input type="text" id="hospitalName" placeholder="병원명 입력">
            </div>

            <div class="hospitalModal-item">
                <label>진료 항목</label>
                <input type="text" id="hospitalDiagnosis" placeholder="예: 정기검진, 예방접종 등">
            </div>

            <div class="hospitalModal-item">
                <label>비용 (원)</label>
                <input type="number" id="hospitalCost" placeholder="예: 45000">
            </div>

            <textarea id="hospitalMemo" placeholder="진료 내용, 처방 등을 기록하세요."></textarea>

            <div class="modal-buttons">
                <button class="button save-button" id="saveHospitalBtn">저장</button>
                <button class="button close-button" id="closeHospitalModalBtn">닫기</button>
            </div>
        </div>
    </div>
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3>삭제 확인</h3>
            <p>정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.</p>
            <div class="modal-buttons">
            <button class="button confirm-button" id="confirmDeleteBtn">삭제</button>
            <button class="button cancel-button" id="cancelDeleteBtn">취소</button>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            async function init() {
                const diaryCards = document.getElementById('diaryCards');
                const emptyCard = document.getElementById('emptyCard');
                const calendarGrid = document.getElementById('calendarGrid');
                const currentMonthEl = document.getElementById('currentMonth');

                const currentMonthTotalCountEl = document.getElementById('currentMonthTotalCount');
                const cuurentMonthLabel = document.getElementById('currentMonthLabel');
                
                const happyCountEl = document.getElementById('happyCount');
                const sadCountEl = document.getElementById('sadCount');
                const angryCountEl = document.getElementById('angryCount');
                const excitedCountEl = document.getElementById('excitedCount');

                const closeModalBtn = document.getElementById('closeModalBtn');
                const saveDiaryBtn = document.getElementById('saveDiaryBtn');

                const modalTitle = document.getElementById('modalTitle');
                const diaryId = document.getElementById('diaryId');
                const diarySelect = document.getElementById('diaryDogSelect');
                const diaryContent = document.getElementById('diaryContent');
                const diaryMood = document.getElementById('diaryMood');

                const deleteModal = document.getElementById("deleteConfirmModal");
                const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
                const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");            
                
                // 플로팅 메뉴
                const mainFab = document.getElementById("mainFab");
                const fabMenu = document.querySelector(".fab-menu");

                let selectedDate = new Date();
                let diaries = [];
                let editingId = null;

                const moodClassMap = { 'HAPPY':'mood-Happy','SAD':'mood-Sad','ANGRY':'mood-Angry','EXCITED':'mood-Excited' };

                // 모달 열기/닫기
                // openModalBtn.onclick = () => {
                //     modal.style.display='flex'; 
                //     editingId=null; 
                //     modalTitle.textContent='일지 작성';
                //     saveDiaryBtn.textContent='저장';
                //     diaryId.value=''; 
                //     diarySelect.value=''; 
                //     diaryMood.value=''; 
                //     diaryContent.value=''; 
                // };

                // 닫기 버튼
                closeModalBtn.onclick = () => { 
                    modal.style.display='none';
                    diaryId.value=''; 
                    diarySelect.value=''; 
                    diaryMood.value=''; 
                    diaryContent.value=''; 
                };

                // 저장 버튼
                saveDiaryBtn.onclick = async () => {
                    const data = { 
                        id: diaryId.value, 
                        dog_id: diarySelect.value, 
                        mood: diaryMood.value,
                        content: diaryContent.value
                    };
                    
                    const response = await axios.post(saveDiaryBtn.textContent == "저장"? "/api/saveDogDiaryByDogId" : "/api/updateDogDiaryByDogId", data);
                    if (response.data.returnCode === "SUCCESS") {
                        modal.style.display='none';
                        await loadDiaries();
                        renderCalendar(selectedDate);
                        renderDiaryList();
                        renderSummary(selectedDate);
                    }
                };

                // 삭제 확인
                confirmDeleteBtn.onclick = async () => {
                    try {
                        const response = await axios.post("/api/deleteDogDiaryById", { id: diaryId.value });
                        if (response.data.returnCode === "SUCCESS") {
                            await loadDiaries();
                            renderDiaryList();
                            renderCalendar(selectedDate);
                            renderSummary(selectedDate);
                        } else {
                            alert("삭제 실패: " + response.data.errorMessage);
                        }
                    } catch (e) { console.error(e); }
                    modal.style.display = "none";
                    deleteModal.style.display = "none";
                };

                // 취소 클릭
                cancelDeleteBtn.onclick = () => { 
                    modal.style.display = "none";
                    deleteModal.style.display = "none";
                };

                // 플로팅 버튼 토글
                mainFab.addEventListener("click", () => {
                    fabMenu.classList.toggle("show");
                });

                fabMenu.addEventListener("click", (e) => {
                    if (e.target.closest(".fab-item")) {
                    const targetModalId = e.target.closest(".fab-item").dataset.target;
                    const targetModal = document.getElementById(targetModalId);
                    if (targetModal) {
                        targetModal.classList.remove("hidden");
                        fabMenu.classList.remove("show");
                    }
                    }
                });

                async function loadDogs() {
                    try {
                    const response = await axios.get("/api/getDogsByUserId");
                    if (response.data.returnCode === "SUCCESS") {
                        const dogs = response.data.resultData;

                        diarySelect.innerHTML = '<option selected hidden value="">반려견 선택</option>';

                        dogs.forEach(dog => {
                            const option = document.createElement("option");
                            option.value = dog.id;
                            option.textContent = dog.name;
                            diarySelect.appendChild(option);
                        });
                    } else {
                        console.warn("반려견 목록 불러오기 실패:", response.data.message);
                    }
                    } catch (error) {
                        console.error("반려견 목록 조회 중 오류 발생:", error);
                    }
                }

                async function loadDiaries() {
                    try { 
                        const res = await axios.get('/api/getAllDiaries'); 
                        if(res.data.returnCode==='SUCCESS') diaries=res.data.resultData; 
                    } 
                    catch(e){ 
                        console.error(e); 
                    }
                }

                function renderSummary(referenceDate){
                    const now = selectedDate;
                    const monthDiaries = diaries.filter(d => {
                        const dd = new Date(d.created_at);
                        return dd.getFullYear() === now.getFullYear() && dd.getMonth() === now.getMonth();
                    });
                    currentMonthTotalCountEl.textContent = monthDiaries.length;
                    cuurentMonthLabel.textContent = `${now.getMonth() + 1}월 총 일지`;

                    happyCountEl.textContent = monthDiaries.filter(d => d.mood === 'HAPPY').length;
                    sadCountEl.textContent = monthDiaries.filter(d => d.mood === 'SAD').length;
                    angryCountEl.textContent = monthDiaries.filter(d=>d.mood==='ANGRY').length;
                    excitedCountEl.textContent = monthDiaries.filter(d=>d.mood==='EXCITED').length;
                }

                function renderDiaryList() {
                    const filtered = diaries.filter(d=>new Date(d.created_at).toDateString()===selectedDate.toDateString());
                    diaryCards.innerHTML='';
                    if(filtered.length===0){ 
                        diaryCards.appendChild(emptyCard); 
                        emptyCard.style.display='flex'; 
                    } else {
                        filtered.forEach(d=>{
                            const moodClass=moodClassMap[d.mood]||'';
                            const card=document.createElement('div');
                            card.className='diary-card';
                            card.innerHTML=`
                                <div class="diary-card-header">${d.name}</div>
                                <div class="diary-card-content">${d.content}</div>
                                <div class="diary-footer">
                                    <div class="diary-mood ${moodClass}">${d.mood||'-'}</div>
                                    <div>${new Date(d.created_at).toLocaleDateString('ko-KR')}</div>
                                </div>
                                <div class="dog-card-actions">
                                    <button class="edit-btn" data-id="${d.id}"><i class="fas fa-edit"></i></button>
                                    <button class="delete-btn" data-id="${d.id}"><i class="fas fa-trash"></i></button>
                                </div>
                            `;
                            diaryCards.appendChild(card);
                            
                            // 수정 클릭
                            card.querySelector('.edit-btn').onclick = () => {
                                modal.style.display='flex';
                                modalTitle.textContent='일지 수정';
                                saveDiaryBtn.textContent='수정';
                                diaryId.value = d.id;
                                diarySelect.value=d.dog_id; 
                                diaryMood.value=d.mood; 
                                diaryContent.value=d.content; 
                            };
                            // 삭제 클릭
                            card.querySelector('.delete-btn').onclick = async () => {
                                deleteModal.style.display='flex';
                                diaryId.value = d.id;
                            };
                        });
                    }
                }

                function renderCalendar(date){
                    const year=date.getFullYear(); const month=date.getMonth();
                    currentMonthEl.textContent=`${year}년 ${month+1}월`;
                    const firstDay=new Date(year,month,1).getDay();
                    const lastDate=new Date(year,month+1,0).getDate();
                    calendarGrid.innerHTML='';
                    for(let i=0;i<firstDay;i++) calendarGrid.appendChild(document.createElement('div'));
                    for(let day=1;day<=lastDate;day++){
                        const dayEl=document.createElement('div'); dayEl.className='calendar-day'; dayEl.textContent=day;
                        const thisDate=new Date(year,month,day);
                        const hasDiary=diaries.some(d=>{const dd=new Date(d.created_at); return dd.getFullYear()===year && dd.getMonth()===month && dd.getDate()===day;});
                        if(hasDiary){ const dot=document.createElement('div'); dot.className='calendar-dot'; dayEl.appendChild(dot); }
                        dayEl.onclick=()=>{ selectedDate=thisDate; renderCalendar(selectedDate); renderDiaryList(); };
                        if(thisDate.toDateString()===selectedDate.toDateString()) dayEl.classList.add('selected');
                        calendarGrid.appendChild(dayEl);
                    }
                }

                window.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") {
                    document.querySelectorAll(".modal").forEach(m => m.classList.add("hidden"));
                    }
                });

                document.getElementById('prevMonthBtn').onclick=()=>{ 
                    selectedDate.setMonth(selectedDate.getMonth() - 1);
                    renderCalendar(selectedDate);
                    renderDiaryList();
                    renderSummary(selectedDate);
                };

                document.getElementById('nextMonthBtn').onclick=()=>{ 
                    selectedDate.setMonth(selectedDate.getMonth() + 1);
                    renderCalendar(selectedDate);
                    renderDiaryList();
                    renderSummary(selectedDate); 
                };

                document.querySelectorAll(".close-button").forEach(btn => {
                    btn.addEventListener("click", () => {
                    btn.closest(".diaryModal").classList.add("hidden");
                    });
                });

                await loadDiaries();
                await loadDogs();
                renderCalendar(selectedDate);
                renderDiaryList();
                renderSummary(selectedDate);
            }
            init();
        });

    </script>
</th:block>
</body>
</html>
