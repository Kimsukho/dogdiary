<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<head>
    <title>ì¼ì • ê´€ë¦¬</title>
</head>
<body>
<div layout:fragment="content">
    <div class="diary-page">
        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prevMonthBtn">â—€</button>
                <h3 id="currentMonth"></h3>
                <button id="nextMonthBtn">â–¶</button>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="diary-content">
            <div class="summary-container">
                <div class="summary-item">
                    <div class="summary-value" id="currentMonthTotalCount">0</div>
                    <div class="summary-label" id="currentMonthLabel">0ì›” ì´ ì¼ì§€</div>
                </div>
                <div class="summary-item"><div class="summary-value" id="happyCount">0</div><div class="summary-label">ğŸ˜Š í–‰ë³µ</div></div>
                <div class="summary-item"><div class="summary-value" id="sadCount">0</div><div class="summary-label">ğŸ˜¢ ìŠ¬í””</div></div>
                <div class="summary-item"><div class="summary-value" id="angryCount">0</div><div class="summary-label">ğŸ˜¡ í™”ë‚¨</div></div>
                <div class="summary-item"><div class="summary-value" id="excitedCount">0</div><div class="summary-label">ğŸ¤© ì‹ ë‚¨</div></div>
            </div>

            <div class="diary-cards" id="diaryCards">
                <div id="emptyCard" class="empty-card">ë“±ë¡ëœ ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <div class="floating-menu">
        <button id="mainFab" class="fab main-fab">ï¼‹</button>

        <div class="fab-menu">
            <button class="fab-item" data-target="diaryModal">
                <i class="fas fa-book"></i><span>ì¼ì§€ ì‘ì„±</span>
            </button>
            <button class="fab-item" data-target="walkModal">
                <i class="fas fa-walking"></i><span>ì‚°ì±…</span>
            </button>
            <button class="fab-item" data-target="hospitalModal">
                <i class="fas fa-clinic-medical"></i><span>ë³‘ì› ê¸°ë¡</span>
            </button>
        </div>
    </div>

    <!-- ê°ê°ì˜ ëª¨ë‹¬ -->    
    <div id="diaryModal" class="diaryModal hidden">
        <div class="modal-content">
            <h3 id="modalTitle">ì¼ì§€ ì‘ì„±</h3>
            <input type="hidden" id="diaryId" name="diaryId" />
            <select id="diaryDogSelect" required="required">
                <option value="" selected hidden>ë°˜ë ¤ê²¬ ì„ íƒ</option>
            </select>
            <select id="diaryMood" required="required">
                <option value="" selected hidden>ê¸°ë¶„ ì„ íƒ</option>
                <option value="HAPPY">í–‰ë³µ</option>
                <option value="SAD">ìŠ¬í””</option>
                <option value="ANGRY">í™”ë‚¨</option>
                <option value="EXCITED">ì‹ ë‚¨</option>
            </select>
            <textarea id="diaryContent" placeholder="ë‚´ìš©"></textarea>
            <div class="modal-buttons">
                <button class="button save-button" id="saveDiaryBtn">ì €ì¥</button>
                <button class="button close-button" id="closeModalBtn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ğŸ¦® ì‚°ì±… ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="walkModal" class="diaryModal hidden">
        <div class="modal-content">
            <h3>ì‚°ì±… ê¸°ë¡</h3>
            <input type="hidden" id="walkId">

            <select id="walkDogSelect" required>
                <option value="" selected hidden>ë°˜ë ¤ê²¬ ì„ íƒ</option>
            </select>

            <div class="walkModal-item">
                <label>ì‚°ì±… ê±°ë¦¬ (km)</label>
                <input type="number" id="walkDistance" placeholder="ì˜ˆ: 2.5" step="0.1">
            </div>

            <div class="walkModal-item">
                <label>ì‚°ì±… ì‹œê°„ (ë¶„)</label>
                <input type="number" id="walkDuration" placeholder="ì˜ˆ: 30">
            </div>

            <div class="walkModal-item">
                <label>ë‚ ì”¨</label>
                <input type="text" id="walkWeather" placeholder="ì˜ˆ: ë§‘ìŒ / íë¦¼">
            </div>

            <textarea id="walkMemo" placeholder="ì‚°ì±… ì¤‘ íŠ¹ì´ì‚¬í•­ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>

            <div class="modal-buttons">
                <button class="button save-button" id="saveWalkBtn">ì €ì¥</button>
                <button class="button close-button" id="closeWalkModalBtn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ğŸ¥ ë³‘ì› ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="hospitalModal" class="diaryModal hidden">
        <div class="modal-content">
            <h3>ë³‘ì› ê¸°ë¡</h3>
            <input type="hidden" id="hospitalId">

            <select id="hospitalDogSelect" required>
                <option value="" selected hidden>ë°˜ë ¤ê²¬ ì„ íƒ</option>
            </select>

            <div class="hospitalModal-item">
                <label>ë³‘ì› ì´ë¦„</label>
                <input type="text" id="hospitalName" placeholder="ë³‘ì›ëª… ì…ë ¥">
            </div>

            <div class="hospitalModal-item">
                <label>ì§„ë£Œ í•­ëª©</label>
                <input type="text" id="hospitalDiagnosis" placeholder="ì˜ˆ: ì •ê¸°ê²€ì§„, ì˜ˆë°©ì ‘ì¢… ë“±">
            </div>

            <div class="hospitalModal-item">
                <label>ë¹„ìš© (ì›)</label>
                <input type="number" id="hospitalCost" placeholder="ì˜ˆ: 45000">
            </div>

            <textarea id="hospitalMemo" placeholder="ì§„ë£Œ ë‚´ìš©, ì²˜ë°© ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>

            <div class="modal-buttons">
                <button class="button save-button" id="saveHospitalBtn">ì €ì¥</button>
                <button class="button close-button" id="closeHospitalModalBtn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3>ì‚­ì œ í™•ì¸</h3>
            <p>ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="modal-buttons">
            <button class="button confirm-button" id="confirmDeleteBtn">ì‚­ì œ</button>
            <button class="button cancel-button" id="cancelDeleteBtn">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            async function init() {
                const diaryCards = document.getElementById('diaryCards');
                const emptyCard = document.getElementById('emptyCard');
                const calendarGrid = document.getElementById('calendarGrid');
                const currentMonthEl = document.getElementById('currentMonth');

                const currentMonthTotalCountEl = document.getElementById('currentMonthTotalCount');
                const cuurentMonthLabel = document.getElementById('currentMonthLabel');
                
                const happyCountEl = document.getElementById('happyCount');
                const sadCountEl = document.getElementById('sadCount');
                const angryCountEl = document.getElementById('angryCount');
                const excitedCountEl = document.getElementById('excitedCount');

                const closeModalBtn = document.getElementById('closeModalBtn');
                const saveDiaryBtn = document.getElementById('saveDiaryBtn');

                const modalTitle = document.getElementById('modalTitle');
                const diaryId = document.getElementById('diaryId');
                const diarySelect = document.getElementById('diaryDogSelect');
                const diaryContent = document.getElementById('diaryContent');
                const diaryMood = document.getElementById('diaryMood');

                const deleteModal = document.getElementById("deleteConfirmModal");
                const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
                const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");            
                
                // í”Œë¡œíŒ… ë©”ë‰´
                const mainFab = document.getElementById("mainFab");
                const fabMenu = document.querySelector(".fab-menu");

                let selectedDate = new Date();
                let diaries = [];
                let editingId = null;

                const moodClassMap = { 'HAPPY':'mood-Happy','SAD':'mood-Sad','ANGRY':'mood-Angry','EXCITED':'mood-Excited' };

                // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
                // openModalBtn.onclick = () => {
                //     modal.style.display='flex'; 
                //     editingId=null; 
                //     modalTitle.textContent='ì¼ì§€ ì‘ì„±';
                //     saveDiaryBtn.textContent='ì €ì¥';
                //     diaryId.value=''; 
                //     diarySelect.value=''; 
                //     diaryMood.value=''; 
                //     diaryContent.value=''; 
                // };

                // ë‹«ê¸° ë²„íŠ¼
                closeModalBtn.onclick = () => { 
                    modal.style.display='none';
                    diaryId.value=''; 
                    diarySelect.value=''; 
                    diaryMood.value=''; 
                    diaryContent.value=''; 
                };

                // ì €ì¥ ë²„íŠ¼
                saveDiaryBtn.onclick = async () => {
                    const data = { 
                        id: diaryId.value, 
                        dog_id: diarySelect.value, 
                        mood: diaryMood.value,
                        content: diaryContent.value
                    };
                    
                    const response = await axios.post(saveDiaryBtn.textContent == "ì €ì¥"? "/api/saveDogDiaryByDogId" : "/api/updateDogDiaryByDogId", data);
                    if (response.data.returnCode === "SUCCESS") {
                        modal.style.display='none';
                        await loadDiaries();
                        renderCalendar(selectedDate);
                        renderDiaryList();
                        renderSummary(selectedDate);
                    }
                };

                // ì‚­ì œ í™•ì¸
                confirmDeleteBtn.onclick = async () => {
                    try {
                        const response = await axios.post("/api/deleteDogDiaryById", { id: diaryId.value });
                        if (response.data.returnCode === "SUCCESS") {
                            await loadDiaries();
                            renderDiaryList();
                            renderCalendar(selectedDate);
                            renderSummary(selectedDate);
                        } else {
                            alert("ì‚­ì œ ì‹¤íŒ¨: " + response.data.errorMessage);
                        }
                    } catch (e) { console.error(e); }
                    modal.style.display = "none";
                    deleteModal.style.display = "none";
                };

                // ì·¨ì†Œ í´ë¦­
                cancelDeleteBtn.onclick = () => { 
                    modal.style.display = "none";
                    deleteModal.style.display = "none";
                };

                // í”Œë¡œíŒ… ë²„íŠ¼ í† ê¸€
                mainFab.addEventListener("click", () => {
                    fabMenu.classList.toggle("show");
                });

                fabMenu.addEventListener("click", (e) => {
                    if (e.target.closest(".fab-item")) {
                    const targetModalId = e.target.closest(".fab-item").dataset.target;
                    const targetModal = document.getElementById(targetModalId);
                    if (targetModal) {
                        targetModal.classList.remove("hidden");
                        fabMenu.classList.remove("show");
                    }
                    }
                });

                async function loadDogs() {
                    try {
                    const response = await axios.get("/api/getDogsByUserId");
                    if (response.data.returnCode === "SUCCESS") {
                        const dogs = response.data.resultData;

                        diarySelect.innerHTML = '<option selected hidden value="">ë°˜ë ¤ê²¬ ì„ íƒ</option>';

                        dogs.forEach(dog => {
                            const option = document.createElement("option");
                            option.value = dog.id;
                            option.textContent = dog.name;
                            diarySelect.appendChild(option);
                        });
                    } else {
                        console.warn("ë°˜ë ¤ê²¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", response.data.message);
                    }
                    } catch (error) {
                        console.error("ë°˜ë ¤ê²¬ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    }
                }

                async function loadDiaries() {
                    try { 
                        const res = await axios.get('/api/getAllDiaries'); 
                        if(res.data.returnCode==='SUCCESS') diaries=res.data.resultData; 
                    } 
                    catch(e){ 
                        console.error(e); 
                    }
                }

                function renderSummary(referenceDate){
                    const now = selectedDate;
                    const monthDiaries = diaries.filter(d => {
                        const dd = new Date(d.created_at);
                        return dd.getFullYear() === now.getFullYear() && dd.getMonth() === now.getMonth();
                    });
                    currentMonthTotalCountEl.textContent = monthDiaries.length;
                    cuurentMonthLabel.textContent = `${now.getMonth() + 1}ì›” ì´ ì¼ì§€`;

                    happyCountEl.textContent = monthDiaries.filter(d => d.mood === 'HAPPY').length;
                    sadCountEl.textContent = monthDiaries.filter(d => d.mood === 'SAD').length;
                    angryCountEl.textContent = monthDiaries.filter(d=>d.mood==='ANGRY').length;
                    excitedCountEl.textContent = monthDiaries.filter(d=>d.mood==='EXCITED').length;
                }

                function renderDiaryList() {
                    const filtered = diaries.filter(d=>new Date(d.created_at).toDateString()===selectedDate.toDateString());
                    diaryCards.innerHTML='';
                    if(filtered.length===0){ 
                        diaryCards.appendChild(emptyCard); 
                        emptyCard.style.display='flex'; 
                    } else {
                        filtered.forEach(d=>{
                            const moodClass=moodClassMap[d.mood]||'';
                            const card=document.createElement('div');
                            card.className='diary-card';
                            card.innerHTML=`
                                <div class="diary-card-header">${d.name}</div>
                                <div class="diary-card-content">${d.content}</div>
                                <div class="diary-footer">
                                    <div class="diary-mood ${moodClass}">${d.mood||'-'}</div>
                                    <div>${new Date(d.created_at).toLocaleDateString('ko-KR')}</div>
                                </div>
                                <div class="dog-card-actions">
                                    <button class="edit-btn" data-id="${d.id}"><i class="fas fa-edit"></i></button>
                                    <button class="delete-btn" data-id="${d.id}"><i class="fas fa-trash"></i></button>
                                </div>
                            `;
                            diaryCards.appendChild(card);
                            
                            // ìˆ˜ì • í´ë¦­
                            card.querySelector('.edit-btn').onclick = () => {
                                modal.style.display='flex';
                                modalTitle.textContent='ì¼ì§€ ìˆ˜ì •';
                                saveDiaryBtn.textContent='ìˆ˜ì •';
                                diaryId.value = d.id;
                                diarySelect.value=d.dog_id; 
                                diaryMood.value=d.mood; 
                                diaryContent.value=d.content; 
                            };
                            // ì‚­ì œ í´ë¦­
                            card.querySelector('.delete-btn').onclick = async () => {
                                deleteModal.style.display='flex';
                                diaryId.value = d.id;
                            };
                        });
                    }
                }

                function renderCalendar(date){
                    const year=date.getFullYear(); const month=date.getMonth();
                    currentMonthEl.textContent=`${year}ë…„ ${month+1}ì›”`;
                    const firstDay=new Date(year,month,1).getDay();
                    const lastDate=new Date(year,month+1,0).getDate();
                    calendarGrid.innerHTML='';
                    for(let i=0;i<firstDay;i++) calendarGrid.appendChild(document.createElement('div'));
                    for(let day=1;day<=lastDate;day++){
                        const dayEl=document.createElement('div'); dayEl.className='calendar-day'; dayEl.textContent=day;
                        const thisDate=new Date(year,month,day);
                        const hasDiary=diaries.some(d=>{const dd=new Date(d.created_at); return dd.getFullYear()===year && dd.getMonth()===month && dd.getDate()===day;});
                        if(hasDiary){ const dot=document.createElement('div'); dot.className='calendar-dot'; dayEl.appendChild(dot); }
                        dayEl.onclick=()=>{ selectedDate=thisDate; renderCalendar(selectedDate); renderDiaryList(); };
                        if(thisDate.toDateString()===selectedDate.toDateString()) dayEl.classList.add('selected');
                        calendarGrid.appendChild(dayEl);
                    }
                }

                window.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") {
                    document.querySelectorAll(".modal").forEach(m => m.classList.add("hidden"));
                    }
                });

                document.getElementById('prevMonthBtn').onclick=()=>{ 
                    selectedDate.setMonth(selectedDate.getMonth() - 1);
                    renderCalendar(selectedDate);
                    renderDiaryList();
                    renderSummary(selectedDate);
                };

                document.getElementById('nextMonthBtn').onclick=()=>{ 
                    selectedDate.setMonth(selectedDate.getMonth() + 1);
                    renderCalendar(selectedDate);
                    renderDiaryList();
                    renderSummary(selectedDate); 
                };

                document.querySelectorAll(".close-button").forEach(btn => {
                    btn.addEventListener("click", () => {
                    btn.closest(".diaryModal").classList.add("hidden");
                    });
                });

                await loadDiaries();
                await loadDogs();
                renderCalendar(selectedDate);
                renderDiaryList();
                renderSummary(selectedDate);
            }
            init();
        });

    </script>
</th:block>
</body>
</html>
