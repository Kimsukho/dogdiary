<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<head>
    <title>ì¼ì • ê´€ë¦¬</title>
</head>
<body>
<div layout:fragment="content">
    <div class="schedule-page">
        <div class="schedule-calendar-container">
            <div class="schedule-calendar-header">
                <div class="schedule-calendar-selectors">
                    <div class="select-wrapper">
                        <select id="yearSelect" class="styled-select"></select>
                    </div>
                    <div class="select-wrapper">
                        <select id="monthSelect" class="styled-select"></select>
                    </div>
                </div>

                <div class="calendar-controls">
                    <button id="prevMonthBtn" class="icon-btn"><i class="fas fa-chevron-left"></i></button>
                    <button id="nextMonthBtn" class="icon-btn"><i class="fas fa-chevron-right"></i></button>
                    <button class="today-btn" id="todayButton"><i class="fas fa-calendar-day"></i> ì˜¤ëŠ˜</button>
                </div>
            </div>

            <div class="schedule-calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="schedule-detail-panel" id="scheduleDetail">
            <h3>ì¼ì • ìƒì„¸</h3>
            <div class="detail-content">
                <p class="placeholder">ì¼ì •ì„ í´ë¦­í•˜ë©´ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <div class="floating-menu">
        <button id="mainFab" class="fab main-fab">ï¼‹</button>
        <div class="fab-menu">
            <button class="fab-item" data-target="walkModal"><i class="fas fa-walking"></i><span>ì‚°ì±…</span></button>
            <button class="fab-item" data-target="hospitalModal"><i class="fas fa-clinic-medical"></i><span>ë³‘ì› ê¸°ë¡</span></button>
        </div>
    </div>

    <!-- ğŸ¦® ì‚°ì±… ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="walkModal" class="diaryModal hidden">
        <div class="modal-content schedule-modal-content">
            <div class="dogModal-header">
                <h3>
                    <i class="fas fa-walking" style="margin-right: 8px; color: #666;"></i>
                    ì‚°ì±… ê¸°ë¡
                </h3>
                <button class="dogModal-back-btn" id="closeWalkModalBtn" title="ë‹«ê¸°">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <input type="hidden" id="walkId">
            <div class="dogModal-fields">
                <div class="dogModal-field">
                    <label>ë°˜ë ¤ê²¬</label>
                    <div class="dogModal-field-wrapper">
                        <select id="walkDogSelect" required>
                            <option value="" selected hidden>ë°˜ë ¤ê²¬ ì„ íƒ</option>
                        </select>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div class="dogModal-field">
                    <label>ë‚ ì§œ</label>
                    <div class="dogModal-field-wrapper">
                        <input type="date" id="walkDate" readonly>
                    </div>
                </div>
                <div class="dogModal-field dogModal-field-full">
                    <label>ë‚ ì”¨</label>
                    <div class="weather-selector">
                        <button type="button" class="weather-btn" data-weather="ë§‘ìŒ">
                            <!-- <i class="fas fa-sun"></i> -->
                            <span>ë§‘ìŒ</span>
                        </button>
                        <button type="button" class="weather-btn" data-weather="íë¦¼">
                            <!-- <i class="fas fa-cloud"></i> -->
                            <span>íë¦¼</span>
                        </button>
                        <button type="button" class="weather-btn" data-weather="ë¹„">
                            <!-- <i class="fas fa-cloud-rain"></i> -->
                            <span>ë¹„</span>
                        </button>
                        <button type="button" class="weather-btn" data-weather="ëˆˆ">
                            <!-- <i class="fas fa-snowflake"></i> -->
                            <span>ëˆˆ</span>
                        </button>
                    </div>
                    <input type="hidden" id="walkWeather" value="">
                </div>
                <div class="dogModal-field dogModal-field-full">
                    <label>ì‚°ì±… ì‹œê°„</label>
                    <div class="duration-selector">
                        <button type="button" class="duration-btn" data-minutes="15">15ë¶„</button>
                        <button type="button" class="duration-btn" data-minutes="30">30ë¶„</button>
                        <button type="button" class="duration-btn" data-minutes="60">1ì‹œê°„</button>
                        <button type="button" class="duration-btn" data-minutes="90">1ì‹œê°„ ë°˜</button>
                        <button type="button" class="duration-btn" data-minutes="120">2ì‹œê°„</button>
                    </div>
                    <input type="hidden" id="walkDuration" value="">
                </div>
                <div class="dogModal-field dogModal-field-full">
                    <label>ë©”ëª¨</label>
                    <div class="dogModal-field-wrapper">
                        <textarea id="walkMemo" placeholder="ì‚°ì±… ì¤‘ íŠ¹ì´ì‚¬í•­ì„ ê¸°ë¡í•˜ì„¸ìš”." style="resize: vertical; min-height: 80px;"></textarea>
                    </div>
                </div>
            </div>
            <div class="dogModal-action-buttons">
                <button class="dogModal-save-btn" id="saveWalkBtn">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ğŸ¥ ë³‘ì› ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="hospitalModal" class="diaryModal hidden">
        <div class="modal-content schedule-modal-content">
            <div class="dogModal-header">
                <h3>
                    <i class="fas fa-clinic-medical" style="margin-right: 8px; color: #666;"></i>
                    ë³‘ì› ê¸°ë¡
                </h3>
                <button class="dogModal-back-btn" id="closeHospitalModalBtn" title="ë‹«ê¸°">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <input type="hidden" id="hospitalId">
            <div class="dogModal-fields">
                <div class="dogModal-field">
                    <label>ë°˜ë ¤ê²¬</label>
                    <div class="dogModal-field-wrapper">
                        <select id="hospitalDogSelect" required>
                            <option value="" selected hidden>ë°˜ë ¤ê²¬ ì„ íƒ</option>
                        </select>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                <div class="dogModal-field">
                    <label>ë‚ ì§œ</label>
                    <div class="dogModal-field-wrapper">
                        <input type="date" id="hospitalDate" readonly>
                    </div>
                </div>
                <div class="dogModal-field">
                    <label>ë³‘ì› ì´ë¦„</label>
                    <div class="dogModal-field-wrapper">
                        <input type="text" id="hospitalName" placeholder="ë³‘ì›ëª… ì…ë ¥">
                    </div>
                </div>
                <div class="dogModal-field">
                    <label>ì§„ë£Œ í•­ëª©</label>
                    <div class="dogModal-field-wrapper">
                        <input type="text" id="hospitalDiagnosis" placeholder="ì˜ˆ: ì •ê¸°ê²€ì§„, ì˜ˆë°©ì ‘ì¢… ë“±">
                    </div>
                </div>
                <div class="dogModal-field dogModal-field-full">
                    <label>ë¹„ìš© (ì›)</label>
                    <div class="dogModal-field-wrapper">
                        <input type="number" id="hospitalCost" placeholder="ì˜ˆ: 45000">
                    </div>
                </div>
                <div class="dogModal-field dogModal-field-full">
                    <label>ë©”ëª¨</label>
                    <div class="dogModal-field-wrapper">
                        <textarea id="hospitalMemo" placeholder="ì§„ë£Œ ë‚´ìš©, ì²˜ë°© ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”." style="resize: vertical; min-height: 80px;"></textarea>
                    </div>
                </div>
            </div>
            <div class="dogModal-action-buttons">
                <button class="dogModal-save-btn" id="saveHospitalBtn">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ğŸ—‘ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3>ì‚­ì œ í™•ì¸</h3>
            <p>ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="modal-buttons">
                <button class="button confirm-button" id="confirmDeleteBtn">ì‚­ì œ</button>
                <button class="button cancel-button" id="cancelDeleteBtn">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ“œ ìŠ¤í¬ë¦½íŠ¸ -->
<th:block layout:fragment="script">
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const calendarGrid = document.getElementById("calendarGrid");
        const yearSelect = document.getElementById("yearSelect");
        const monthSelect = document.getElementById("monthSelect");
        const todayButton = document.getElementById("todayButton");
        const detailPanel = document.getElementById("scheduleDetail");
        const detailContent = document.getElementById("scheduleDetail").querySelector(".detail-content");

        const mainFab = document.getElementById("mainFab");
        const fabMenu = document.querySelector(".fab-menu");

        const saveWalkBtn = document.getElementById("saveWalkBtn");
        const saveHospitalBtn = document.getElementById("saveHospitalBtn");
    
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();

        let schedules = [];
        let selectedDate = `${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;


        function initSelectors(){
            for(let y=today.getFullYear()-5; y<=today.getFullYear()+5; y++){
                const opt=document.createElement("option"); 
                opt.value=y; opt.textContent=`${y}ë…„`; 
                if(y===currentYear) opt.selected=true; 
                yearSelect.appendChild(opt);
            }
            for(let m=0; m<12; m++){
                const opt=document.createElement("option"); 
                opt.value=m; opt.textContent=`${m+1}ì›”`;
                if(m===currentMonth) opt.selected=true; 
                monthSelect.appendChild(opt);
            }
            yearSelect.addEventListener("change", () => { 
                currentYear=parseInt(yearSelect.value); 
                yearSelect.classList.remove("active");
                monthSelect.classList.remove("active");
                renderCalendar(); 
            });
            monthSelect.addEventListener("change", () => { 
                currentMonth=parseInt(monthSelect.value); 
                yearSelect.classList.remove("active");
                monthSelect.classList.remove("active");
                renderCalendar(); 
            });
        }

        // ì›”ë³„ ì¼ì • ì¡°íšŒëŠ” ApiCommon.loadMonthlySchedules ì‚¬ìš©

        async function renderCalendar(){
            calendarGrid.innerHTML = "";
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth+1,0);
            const startDay = firstDay.getDay();

            let allSchedules = await ApiCommon.loadMonthlySchedules(currentYear, currentMonth, 3);
            
            // localStorageì—ì„œ ê¸°ë³¸ ë°˜ë ¤ê²¬ ID ì½ê¸°
            const defaultDogId = localStorage.getItem('defaultDogId');
            
            // ê¸°ë³¸ ë°˜ë ¤ê²¬ì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ í•´ë‹¹ ê°•ì•„ì§€ì˜ ìŠ¤ì¼€ì¤„ë§Œ í•„í„°ë§
            if (defaultDogId && defaultDogId !== '') {
                schedules = allSchedules.filter(s => s.dog_id == defaultDogId);
            } else {
                schedules = allSchedules;
            }

            // ìš”ì¼ í—¤ë” ì¶”ê°€
            const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            weekdays.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'schedule-calendar-weekday';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            for(let i=0;i<startDay;i++){
                const emptyDiv=document.createElement("div"); 
                emptyDiv.classList.add("schedule-calendar-day","empty");
                calendarGrid.appendChild(emptyDiv);
            }

            for(let day=1; day<=lastDay.getDate(); day++){
                const div=document.createElement("div"); 
                div.classList.add("schedule-calendar-day");
                const thisDate = new Date(currentYear, currentMonth, day);
                const dayOfWeek = thisDate.getDay();
                
                // ì£¼ë§ ìŠ¤íƒ€ì¼ ì¶”ê°€
                if(dayOfWeek === 0) div.classList.add('sunday');
                if(dayOfWeek === 6) div.classList.add('saturday');

                const num=document.createElement("div"); 
                num.classList.add("schedule-calendar-day-number"); 
                num.textContent=day; 
                div.appendChild(num);

                const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
                const daySchedules = schedules.filter(s=>s.date===dateStr);
                
                daySchedules.forEach(s => {
                    const item = document.createElement("div");
                    item.classList.add("schedule-item", s.type);
                    item.textContent = s.type === "walk" ? `ì‚°ì±…: ${s.dog_name || '-'}` : `ë³‘ì›: ${s.hospital_name || '-'}`;
                    
                    item.addEventListener("click", (e) => {
                        e.stopPropagation();
                        selectedDate = dateStr;
                        document.querySelectorAll(".schedule-item").forEach(si => si.classList.remove("selected"));
                        document.querySelectorAll(".schedule-calendar-day").forEach(d => d.classList.remove("selected"));
                        item.classList.add("selected");
                        div.classList.add("selected");

                        showDetail(s);
                    });

                    div.appendChild(item);
                });

                div.addEventListener("click", () => {
                    selectedDate = dateStr;
                    document.querySelectorAll(".schedule-calendar-day").forEach(d => d.classList.remove("selected"));
                    div.classList.add("selected");

                    // selectì— active ìŠ¤íƒ€ì¼ ì œê±° (ì¼ì í´ë¦­ ì‹œì—ëŠ” selectë¥¼ activeë¡œ ë§Œë“¤ì§€ ì•ŠìŒ)
                    yearSelect.classList.remove("active");
                    monthSelect.classList.remove("active");
                    
                    const daySchedules = schedules.filter(s => s.date === selectedDate);
                    if(daySchedules.length){
                        // ì²« ë²ˆì§¸ ì¼ì •(ìµœìƒë‹¨) í‘œì‹œ
                        detailContent.innerHTML = "";
                        showDetail(daySchedules[0]);
                    } else {
                        document.querySelector("#scheduleDetail h3").textContent = `ì¼ì • ìƒì„¸`;
                        detailContent.innerHTML = `<p class="placeholder">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    }
                });

                if (currentYear === today.getFullYear() && currentMonth === today.getMonth() && day === today.getDate()) {
                    div.classList.add("today");
                }

                calendarGrid.appendChild(div);
            }
            // ì„ íƒëœ ë‚ ì§œê°€ í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ì›”ì— ì†í•˜ëŠ”ì§€ í™•ì¸
            const selectedDateObj = new Date(selectedDate);
            const isSelectedDateInCurrentMonth = selectedDateObj.getFullYear() === currentYear && 
                                                  selectedDateObj.getMonth() === currentMonth;
            
            // ì„ íƒëœ ë‚ ì§œê°€ í˜„ì¬ ì›”ì— ì†í•˜ëŠ” ê²½ìš°ì—ë§Œ ì¼ì • ìƒì„¸ íŒ¨ë„ ì—…ë°ì´íŠ¸
            if(isSelectedDateInCurrentMonth){
                const daySchedules = schedules.filter(s => s.date === selectedDate);
                
                if(daySchedules.length > 0){
                    // ì²« ë²ˆì§¸ ì¼ì •(ìµœìƒë‹¨) í‘œì‹œ
                    detailContent.innerHTML = "";
                    showDetail(daySchedules[0]);
                } else {
                    document.querySelector("#scheduleDetail h3").textContent = `ì¼ì • ìƒì„¸`;
                    detailContent.innerHTML = `<p class="placeholder">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                }
            }
            // ì„ íƒëœ ë‚ ì§œê°€ í˜„ì¬ ì›”ì— ì†í•˜ì§€ ì•Šìœ¼ë©´ ì¼ì • ìƒì„¸ íŒ¨ë„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
        }

        // async function renderSchedulesByDate(date) {
        //     const calendarGrid = document.getElementById("calendarGrid");
        //     const detailContent = document.querySelector("#scheduleDetail .detail-content");

        //     const [year, month] = date.split("-"); 
        //     const monthStr = `${year}-${month}`;
        //     const schedules = await loadMonthlySchedules(year, parseInt(month)-1); // loadMonthlySchedulesëŠ” ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš©

        //     const daySchedules = schedules.filter(s => s.date === date);

        //     document.querySelectorAll(".schedule-calendar-day").forEach(d => d.classList.remove("selected"));
        //     const day = parseInt(date.split("-")[2], 10);
        //     const targetDay = Array.from(document.querySelectorAll(".schedule-calendar-day-number"))
        //         .find(d => parseInt(d.textContent, 10) === day);
        //     if (targetDay) targetDay.parentElement.classList.add("selected");

        //     if (daySchedules.length) {
        //         detailContent.innerHTML = "";
        //         daySchedules.forEach(s => showDetail(s));
        //     } else {
        //         detailContent.innerHTML = `<p class="placeholder">ì¼ì •ì„ í´ë¦­í•˜ë©´ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>`;
        //     }
        // }


        async function loadDogs(selectElement, preserveValue = null){
            try{
                const response = await axios.get("/api/getDogsByUserId");
                if(response.data.returnCode==="SUCCESS"){
                    const dogs = response.data.resultData || [];
                    
                    // ê¸°ì¡´ ì˜µì…˜ ì´ˆê¸°í™”
                    selectElement.innerHTML = '';
                    
                    // ê°•ì•„ì§€ ëª©ë¡ì´ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ ì²« ë²ˆì§¸ ê°•ì•„ì§€ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                    if (dogs.length > 0) {
                        dogs.forEach((dog, index) => {
                            const opt = document.createElement("option");
                            opt.value = dog.id;
                            opt.textContent = dog.name;
                            // ë¬´ì¡°ê±´ ì²« ë²ˆì§¸ ê°•ì•„ì§€ë¥¼ ê¸°ë³¸ ì„ íƒ
                            if (index === 0) {
                                opt.selected = true;
                            }
                            selectElement.appendChild(opt);
                        });
                        
                        // preserveValueê°€ ìˆìœ¼ë©´ í•´ë‹¹ ê°’ìœ¼ë¡œ ë³€ê²½ (ì²« ë²ˆì§¸ê°€ ê¸°ë³¸ì´ì§€ë§Œ ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ ê°’ ìœ ì§€)
                        if (preserveValue) {
                            selectElement.value = preserveValue;
                        }
                    } else {
                        // ê°•ì•„ì§€ê°€ ì—†ìœ¼ë©´ "ë°˜ë ¤ê²¬ ì„ íƒ" ì˜µì…˜ë§Œ í‘œì‹œ
                        const opt = document.createElement("option");
                        opt.value = "";
                        opt.textContent = "ë°˜ë ¤ê²¬ ì„ íƒ";
                        opt.selected = true;
                        opt.hidden = true;
                        selectElement.appendChild(opt);
                    }
                }
            } catch(e){ console.error("ë°˜ë ¤ê²¬ ì¡°íšŒ ì‹¤íŒ¨", e); }
        }

        function openModal(modalId, schedule = null) {
            document.querySelectorAll(".diaryModal").forEach(m => {
                m.classList.add("hidden");
                m.style.opacity=0;
            });

            const modal=document.getElementById(modalId);
            modal.classList.remove("hidden");
            modal.style.transition="opacity 0.3s ease";
            setTimeout(()=> modal.style.opacity=1, 0);

            if(modalId==="walkModal"){
                const walkSelect = document.getElementById("walkDogSelect");
                const dateInput = document.getElementById("walkDate");
                dateInput.value = schedule?.date || selectedDate;
                dateInput.readOnly = true;
                loadDogs(walkSelect, schedule?.dog_id || null);

                document.getElementById("walkId").value = schedule?.id || "";
                const durationValue = schedule?.duration || "";
                document.getElementById("walkDuration").value = durationValue;
                
                // ê¸°ì¡´ duration ê°’ì— ë§ëŠ” ë²„íŠ¼ ì„ íƒ
                document.querySelectorAll(".duration-btn").forEach(btn => {
                    btn.classList.remove("active");
                    if(btn.dataset.minutes == durationValue) {
                        btn.classList.add("active");
                    }
                });
                
                const weatherValue = schedule?.weather || "";
                document.getElementById("walkWeather").value = weatherValue;
                
                // ê¸°ì¡´ ë‚ ì”¨ ê°’ì— ë§ëŠ” ë²„íŠ¼ ì„ íƒ
                document.querySelectorAll(".weather-btn").forEach(btn => {
                    btn.classList.remove("active");
                    if(btn.dataset.weather === weatherValue) {
                        btn.classList.add("active");
                    }
                });
                
                document.getElementById("walkMemo").value = schedule?.desc || "";
            } else if(modalId==="hospitalModal"){
                const hospitalSelect = document.getElementById("hospitalDogSelect");
                const dateInput = document.getElementById("hospitalDate");
                dateInput.value = schedule?.date || selectedDate;
                dateInput.readOnly = true;
                loadDogs(hospitalSelect, schedule?.dog_id || null);

                document.getElementById("hospitalId").value = schedule?.id || "";
                document.getElementById("hospitalName").value = schedule?.hospital_name || "";
                document.getElementById("hospitalDiagnosis").value = schedule?.diagnosis || "";
                document.getElementById("hospitalCost").value = schedule?.cost || "";
                document.getElementById("hospitalMemo").value = schedule?.desc || "";
            }
        }

        function showDetail(schedule){
            document.querySelector("#scheduleDetail h3").textContent = `ì¼ì • ìƒì„¸`;
            
            // ë‚ ì§œ í¬ë§·íŒ…
            const dateObj = new Date(schedule.date);
            const formattedDate = `${dateObj.getFullYear()}ë…„ ${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼`;
            
            let statsContent = '';
            let titleText = '';
            
            if(schedule.type === "walk"){
                titleText = "ì‚°ì±…";
                statsContent = `
                    <div class="schedule-stat-item">
                        <div class="schedule-stat-label">
                            <i class="fas fa-clock" style="margin-right: 4px;"></i>ì‹œê°„
                        </div>
                        <div class="schedule-stat-value">${schedule.duration || "-"} ë¶„</div>
                    </div>
                    <div class="schedule-stat-item">
                        <div class="schedule-stat-label">
                            <i class="fas fa-cloud-sun" style="margin-right: 4px;"></i>ë‚ ì”¨
                        </div>
                        <div class="schedule-stat-value">${schedule.weather || "-"}</div>
                    </div>
                `;
            } else {
                titleText = "ë³‘ì›";
                statsContent = `
                    <div class="schedule-stat-item">
                        <div class="schedule-stat-label">
                            <i class="fas fa-hospital" style="margin-right: 4px;"></i>ë³‘ì›ëª…
                        </div>
                        <div class="schedule-stat-value">${schedule.hospital_name || "-"}</div>
                    </div>
                    <div class="schedule-stat-item">
                        <div class="schedule-stat-label">
                            <i class="fas fa-stethoscope" style="margin-right: 4px;"></i>ì§„ë£Œ í•­ëª©
                        </div>
                        <div class="schedule-stat-value">${schedule.diagnosis || "-"}</div>
                    </div>
                    ${schedule.cost ? `
                    <div class="schedule-stat-item">
                        <div class="schedule-stat-label">
                            <i class="fas fa-won-sign" style="margin-right: 4px;"></i>ë¹„ìš©
                        </div>
                        <div class="schedule-stat-value">${schedule.cost.toLocaleString()}ì›</div>
                    </div>
                    ` : ''}
                `;
            }
            
            // ì¼ì • íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ê³¼ ìƒ‰ìƒ ì„¤ì •
            let dateIcon = 'fa-calendar-alt';
            let dateIconColor = 'var(--primary-color)';
            let memoIconColor = 'var(--primary-color)';
            
            if(schedule.type === 'walk') {
                dateIcon = 'fa-walking';
                dateIconColor = '#F57F17';
                memoIconColor = '#F57F17';
            } else if(schedule.type === 'hospital') {
                dateIcon = 'fa-clinic-medical';
                dateIconColor = '#388E3C';
                memoIconColor = '#388E3C';
            }
            
            let content = `
                <div class="schedule-profile-card ${schedule.type}">
                    <div class="schedule-card-header">
                        <div class="schedule-date-header">
                            <i class="fas ${dateIcon}" style="color: ${dateIconColor};"></i>
                            <span>${formattedDate}</span>
                        </div>
                        <div class="schedule-profile-actions">
                            <button class="schedule-edit-btn" title="ìˆ˜ì •"><i class="fas fa-pencil-alt"></i></button>
                            <button class="schedule-delete-btn" title="ì‚­ì œ"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <div class="schedule-profile-header">
                        <div class="schedule-avatar ${schedule.type}">
                            <i class="fas ${schedule.type === 'walk' ? 'fa-walking' : 'fa-clinic-medical'}"></i>
                        </div>
                        <div class="schedule-stats">
                            ${statsContent}
                        </div>
                    </div>
                    <div class="schedule-profile-info">
                        <h3 class="schedule-name">${schedule.dog_name || "-"}</h3>
                    </div>
                    <div class="schedule-about-section">
                        <div class="schedule-about-title">
                            <i class="fas fa-sticky-note" style="margin-right: 6px; color: ${memoIconColor};"></i>ë©”ëª¨
                        </div>
                        <p class="schedule-about-content ${!schedule.desc || schedule.desc === 'ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.' ? 'empty-memo' : ''}">${schedule.desc || "ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤."}</p>
                    </div>
                </div>`;
            detailContent.innerHTML = content;

            detailContent.querySelector(".schedule-edit-btn").addEventListener("click", ()=>{
                if(schedule.type==="walk") {
                    saveWalkBtn.textContent = "ìˆ˜ì •í•˜ê¸°";
                } else {
                    saveHospitalBtn.textContent = "ìˆ˜ì •í•˜ê¸°";
                }
                openModal(schedule.type==="walk"?"walkModal":"hospitalModal", schedule);
            });

            detailContent.querySelector(".schedule-delete-btn").addEventListener("click", ()=>{
                const modal=document.getElementById("deleteConfirmModal"); 
                modal.style.display="flex";
                const confirmBtn=document.getElementById("confirmDeleteBtn");
                const cancelBtn=document.getElementById("cancelDeleteBtn");
                confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));

                document.getElementById("confirmDeleteBtn").addEventListener("click", async ()=>{
                    try{
                        if(schedule.type==="walk"){
                            await ApiCommon.deleteWalk(schedule.id);
                        } else {
                            await ApiCommon.deleteHospital(schedule.id);
                        }
                        schedules = schedules.filter(s=>s.id!==schedule.id);
                        await renderCalendar();
                        detailContent.innerHTML=`<p class="placeholder">ì˜¤ëŠ˜ (${selectedDate}) ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                        modal.style.display="none";
                    } catch(e){ console.error(e); alert("ì‚­ì œ ì‹¤íŒ¨"); }
                });

                document.getElementById("cancelDeleteBtn").addEventListener("click", ()=>{ modal.style.display="none"; });
            });
        }

        saveWalkBtn.addEventListener("click", async ()=>{
            const id = document.getElementById("walkId").value;
            const dogId = document.getElementById("walkDogSelect").value;
            const duration = document.getElementById("walkDuration").value;
            const weather = document.getElementById("walkWeather").value;
            const memo = document.getElementById("walkMemo").value;
            
            // í•„ìˆ˜ í•„ë“œ ê²€ì¦
            if (!dogId || dogId === "") {
                alert("ë°˜ë ¤ê²¬ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            if (!selectedDate || selectedDate === "") {
                alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const walkData = {
                user_id: 3,
                dog_id: parseInt(dogId),
                duration: duration ? parseInt(duration) : null,
                weather: weather || null,
                memo: memo || null,
                date: selectedDate
            };
            
            try{
                const response = id
                    ? await ApiCommon.updateWalk({ id: parseInt(id), ...walkData })
                    : await ApiCommon.createWalk(walkData);
                
                if(response && response.data && response.data.returnCode === "SUCCESS") {
                    alert("ì €ì¥ ì™„ë£Œ!");
                    // ëª¨ë‹¬ ë‹«ê¸° (fade-out íš¨ê³¼)
                    const modal = document.getElementById("walkModal");
                    modal.style.opacity = 0;
                    setTimeout(() => {
                        modal.classList.add("hidden");
                        // í¼ ì´ˆê¸°í™”
                        document.getElementById("walkId").value = "";
                        document.getElementById("walkDogSelect").value = "";
                        document.getElementById("walkDuration").value = "";
                        document.getElementById("walkWeather").value = "";
                        document.getElementById("walkMemo").value = "";
                        document.querySelectorAll(".duration-btn").forEach(btn => btn.classList.remove("active"));
                        document.querySelectorAll(".weather-btn").forEach(btn => btn.classList.remove("active"));
                        saveWalkBtn.textContent = "ì €ì¥í•˜ê¸°";
                    }, 300);
                    await renderCalendar();
                } else {
                    const errorMsg = response?.data?.errorMessage || "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    alert(errorMsg);
                }
            } catch(e){ 
                console.error("ì €ì¥ ì˜¤ë¥˜:", e);
                const errorMsg = e.response?.data?.errorMessage || e.message || "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                alert(errorMsg);
            }
        });

        saveHospitalBtn.addEventListener("click", async ()=>{
            const id = document.getElementById("hospitalId").value;
            const dogId = document.getElementById("hospitalDogSelect").value;
            const hospitalName = document.getElementById("hospitalName").value;
            const diagnosis = document.getElementById("hospitalDiagnosis").value;
            const cost = document.getElementById("hospitalCost").value;
            const memo = document.getElementById("hospitalMemo").value;
            
            // í•„ìˆ˜ í•„ë“œ ê²€ì¦
            if (!dogId || dogId === "") {
                alert("ë°˜ë ¤ê²¬ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            if (!selectedDate || selectedDate === "") {
                alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const hospitalData = {
                user_id: 3,
                dog_id: parseInt(dogId),
                hospital_name: hospitalName || null,
                diagnosis: diagnosis || null,
                cost: cost ? parseInt(cost) : null,
                memo: memo || null,
                date: selectedDate
            };
            
            try {
                const response = id
                    ? await ApiCommon.updateHospital({ id: parseInt(id), ...hospitalData })
                    : await ApiCommon.createHospital(hospitalData);

                if (response && response.data && response.data.returnCode === "SUCCESS") {
                    alert("ì €ì¥ ì™„ë£Œ!");
                    // ëª¨ë‹¬ ë‹«ê¸° (fade-out íš¨ê³¼)
                    const modal = document.getElementById("hospitalModal");
                    modal.style.opacity = 0;
                    setTimeout(() => {
                        modal.classList.add("hidden");
                        // í¼ ì´ˆê¸°í™”
                        document.getElementById("hospitalId").value = "";
                        document.getElementById("hospitalDogSelect").value = "";
                        document.getElementById("hospitalName").value = "";
                        document.getElementById("hospitalDiagnosis").value = "";
                        document.getElementById("hospitalCost").value = "";
                        document.getElementById("hospitalMemo").value = "";
                        saveHospitalBtn.textContent = "ì €ì¥í•˜ê¸°";
                    }, 300);
                    await renderCalendar();
                } else {
                    const errorMsg = response?.data?.errorMessage || "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                    alert(errorMsg);
                }
            } catch(e){ 
                console.error("ì €ì¥ ì˜¤ë¥˜:", e);
                const errorMsg = e.response?.data?.errorMessage || e.message || "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                alert(errorMsg);
            }
        });

        mainFab.addEventListener("click", () => {
            fabMenu.classList.toggle("show");
        });

        document.querySelectorAll(".fab-item").forEach(item=>{
            item.addEventListener("click", ()=>{
                openModal(item.dataset.target);
                if(item.dataset.target === "walkModal") {
                    saveWalkBtn.textContent = "ì €ì¥í•˜ê¸°";
                    // ìƒˆë¡œ ëª¨ë‹¬ì„ ì—´ ë•Œ ëª¨ë“  duration ë²„íŠ¼ ì´ˆê¸°í™”
                    document.querySelectorAll(".duration-btn").forEach(btn => {
                        btn.classList.remove("active");
                    });
                    document.getElementById("walkDuration").value = "";
                    // ë‚ ì”¨ ë²„íŠ¼ë„ ì´ˆê¸°í™”
                    document.querySelectorAll(".weather-btn").forEach(btn => {
                        btn.classList.remove("active");
                    });
                    document.getElementById("walkWeather").value = "";
                } else if(item.dataset.target === "hospitalModal") {
                    saveHospitalBtn.textContent = "ì €ì¥í•˜ê¸°";
                }
                fabMenu.classList.remove("show");
            });
        });

        // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById("closeWalkModalBtn")?.addEventListener("click", ()=>{
            const modal = document.getElementById("walkModal");
            modal.style.opacity = 0;
            setTimeout(() => {
                modal.classList.add("hidden");
            }, 300);
        });
        
        document.getElementById("closeHospitalModalBtn")?.addEventListener("click", ()=>{
            const modal = document.getElementById("hospitalModal");
            modal.style.opacity = 0;
            setTimeout(() => {
                modal.classList.add("hidden");
            }, 300);
        });
        
        // ê¸°ì¡´ close-button í´ë˜ìŠ¤ë„ ì§€ì› (í•˜ìœ„ í˜¸í™˜ì„±)
        document.querySelectorAll(".close-button").forEach(btn=>{
            btn.addEventListener("click", ()=>{
                btn.closest(".diaryModal").classList.add("hidden");
            });
        });

        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                fabMenu.classList.remove("show");
                document.querySelectorAll(".diaryModal").forEach(m => {
                    m.classList.add("hidden");
                });
            }
        });

        todayButton.addEventListener("click", async () => {
            currentYear=today.getFullYear();
            currentMonth=today.getMonth();
            selectedDate = `${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(today.getDate()).padStart(2,"0")}`;
            yearSelect.value=currentYear;
            monthSelect.value=currentMonth;
            yearSelect.classList.remove("active");
            monthSelect.classList.remove("active");
            await renderCalendar();
        });

        // ì´ì „/ë‹¤ìŒ ì›” ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById("prevMonthBtn").addEventListener("click", () => {
            currentMonth--;
            if(currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            yearSelect.value = currentYear;
            monthSelect.value = currentMonth;
            yearSelect.classList.remove("active");
            monthSelect.classList.remove("active");
            renderCalendar();
        });

        document.getElementById("nextMonthBtn").addEventListener("click", () => {
            currentMonth++;
            if(currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            yearSelect.value = currentYear;
            monthSelect.value = currentMonth;
            yearSelect.classList.remove("active");
            monthSelect.classList.remove("active");
            renderCalendar();
        });

        // ì‚°ì±… ì‹œê°„ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll(".duration-btn").forEach(btn => {
            btn.addEventListener("click", function() {
                // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll(".duration-btn").forEach(b => b.classList.remove("active"));
                // í´ë¦­í•œ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
                this.classList.add("active");
                // hidden inputì— ê°’ ì €ì¥
                document.getElementById("walkDuration").value = this.dataset.minutes;
            });
        });

        // ë‚ ì”¨ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll(".weather-btn").forEach(btn => {
            btn.addEventListener("click", function() {
                // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll(".weather-btn").forEach(b => b.classList.remove("active"));
                // í´ë¦­í•œ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
                this.classList.add("active");
                // hidden inputì— ê°’ ì €ì¥
                document.getElementById("walkWeather").value = this.dataset.weather;
            });
        });

        initSelectors();
        renderCalendar();
    });
</script>
</th:block>
</body>
</html>
