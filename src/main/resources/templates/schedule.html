<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<head>
    <title>ì¼ì • ê´€ë¦¬</title>
</head>
<body>
<div layout:fragment="content">
    <div class="schedule-page">
        <div class="schedule-calendar-container">
            <div class="schedule-calendar-header">
                <div class="schedule-calendar-selectors">
                    <select id="yearSelect" class="styled-select"></select>
                    <select id="monthSelect" class="styled-select"></select>
                </div>
                <button class="today-btn" id="todayButton">ì˜¤ëŠ˜ë¡œ ì´ë™</button>
            </div>

            <div class="schedule-calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="schedule-detail-panel" id="scheduleDetail">
            <h3>ğŸ“Œ ì¼ì • ìƒì„¸</h3>
            <div class="detail-content">
                <p class="placeholder">ì¼ì •ì„ í´ë¦­í•˜ë©´ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <div class="floating-menu">
        <button id="mainFab" class="fab main-fab">ï¼‹</button>
        <div class="fab-menu">
            <button class="fab-item" data-target="walkModal"><i class="fas fa-walking"></i><span>ì‚°ì±…</span></button>
            <button class="fab-item" data-target="hospitalModal"><i class="fas fa-clinic-medical"></i><span>ë³‘ì› ê¸°ë¡</span></button>
        </div>
    </div>

    <!-- ğŸ¦® ì‚°ì±… ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="walkModal" class="diaryModal hidden">
        <div class="modal-content">
            <h3>ì‚°ì±… ê¸°ë¡</h3>
            <input type="hidden" id="walkId">
            <select id="walkDogSelect" required>
                <option value="" selected hidden>ë°˜ë ¤ê²¬ ì„ íƒ</option>
            </select>
            <div class="walkModal-item">
                <label>ì‚°ì±… ì‹œê°„ (ë¶„)</label>
                <input type="number" id="walkDuration" placeholder="ì˜ˆ: 30">
            </div>
            <div class="walkModal-item">
                <label>ë‚ ì”¨</label>
                <input type="text" id="walkWeather" placeholder="ì˜ˆ: ë§‘ìŒ / íë¦¼">
            </div>
            <textarea id="walkMemo" placeholder="ì‚°ì±… ì¤‘ íŠ¹ì´ì‚¬í•­ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
            <div class="modal-buttons">
                <button class="button save-button" id="saveWalkBtn">ì €ì¥</button>
                <button class="button close-button" id="closeWalkModalBtn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ğŸ¥ ë³‘ì› ê¸°ë¡ ëª¨ë‹¬ -->
    <div id="hospitalModal" class="diaryModal hidden">
        <div class="modal-content">
            <h3>ë³‘ì› ê¸°ë¡</h3>
            <input type="hidden" id="hospitalId">
            <select id="hospitalDogSelect" required>
                <option value="" selected hidden>ë°˜ë ¤ê²¬ ì„ íƒ</option>
            </select>
            <div class="hospitalModal-item">
                <label>ë³‘ì› ì´ë¦„</label>
                <input type="text" id="hospitalName" placeholder="ë³‘ì›ëª… ì…ë ¥">
            </div>
            <div class="hospitalModal-item">
                <label>ì§„ë£Œ í•­ëª©</label>
                <input type="text" id="hospitalDiagnosis" placeholder="ì˜ˆ: ì •ê¸°ê²€ì§„, ì˜ˆë°©ì ‘ì¢… ë“±">
            </div>
            <div class="hospitalModal-item">
                <label>ë¹„ìš© (ì›)</label>
                <input type="number" id="hospitalCost" placeholder="ì˜ˆ: 45000">
            </div>
            <textarea id="hospitalMemo" placeholder="ì§„ë£Œ ë‚´ìš©, ì²˜ë°© ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
            <div class="modal-buttons">
                <button class="button save-button" id="saveHospitalBtn">ì €ì¥</button>
                <button class="button close-button" id="closeHospitalModalBtn">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ğŸ—‘ ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h3>ì‚­ì œ í™•ì¸</h3>
            <p>ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
            <div class="modal-buttons">
                <button class="button confirm-button" id="confirmDeleteBtn">ì‚­ì œ</button>
                <button class="button cancel-button" id="cancelDeleteBtn">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>
</div>

<!-- ğŸ“œ ìŠ¤í¬ë¦½íŠ¸ -->
<th:block layout:fragment="script">
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const calendarGrid = document.getElementById("calendarGrid");
        const yearSelect = document.getElementById("yearSelect");
        const monthSelect = document.getElementById("monthSelect");
        const todayButton = document.getElementById("todayButton");
        const detailPanel = document.getElementById("scheduleDetail");
        const detailContent = document.getElementById("scheduleDetail").querySelector(".detail-content");

        const mainFab = document.getElementById("mainFab");
        const fabMenu = document.querySelector(".fab-menu");

        const saveWalkBtn = document.getElementById("saveWalkBtn");
        const saveHospitalBtn = document.getElementById("saveHospitalBtn");
    
        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();

        const schedules = [
            { id:1, date:"2025-10-13", type:"walk", title:"ì‚°ì±… - ëŒ•ëŒ•ì´", dogId:1, dogName:"ì½”ì½”", distance:2.5, duration:30, weather:"ë§‘ìŒ", hospitalName:null, diagnosis:null, cost:null, desc:"30ë¶„ ë™ì•ˆ ì‚°ì±…" },
            { id:2, date:"2025-10-13", type:"hospital", title:"ë³‘ì› - ì˜ˆë°©ì ‘ì¢…", dogId:1, dogName:"ì½”ì½”", distance:null, duration:null, weather:null, hospitalName:"ë™ë¬¼ë³‘ì›A", diagnosis:"ê´‘ê²¬ë³‘ ì£¼ì‚¬", cost:45000, desc:"ê´‘ê²¬ë³‘ ì£¼ì‚¬ ë§ê¸°" }
        ];
            

        mainFab.addEventListener("click", () => {
            fabMenu.classList.toggle("show");
        });

        document.querySelectorAll(".fab-item").forEach(item=>{
            item.addEventListener("click", ()=>{
                const target = item.dataset.target;
                openModal(target);
                saveWalkBtn.textContent = "ì €ì¥";
                fabMenu.classList.remove("show");
            });
        });


        document.querySelectorAll(".close-button").forEach(btn=>{
            btn.addEventListener("click", ()=>{
                const modal = btn.closest(".diaryModal"); 
                modal.classList.add("hidden"); 
                modal.style.display="none";
            });
        });

        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                fabMenu.classList.remove("show");
                document.querySelectorAll(".diaryModal").forEach(m => {
                    m.classList.add("hidden");
                    m.style.display = "none";
                });
            }
        });

        window.addEventListener("keydown",(e)=>{ if(e.key==="Escape"){ fabMenu.classList.remove("show"); document.querySelectorAll(".diaryModal").forEach(m=>{ m.classList.add("hidden"); m.style.display="none"; }); } });

        todayButton.addEventListener("click", ()=>{ currentYear=today.getFullYear(); currentMonth=today.getMonth(); yearSelect.value=currentYear; monthSelect.value=currentMonth; renderCalendar(); });

        function initSelectors(){
            for(let y=today.getFullYear()-5; y<=today.getFullYear()+5; y++){
                const opt=document.createElement("option"); 
                opt.value=y; opt.textContent=`${y}ë…„`; 
                if(y===currentYear) opt.selected=true; 
                yearSelect.appendChild(opt);
            }
            for(let m=0; m<12; m++){
                const opt=document.createElement("option"); 
                opt.value=m; opt.textContent=`${m+1}ì›”`;
                if(m===currentMonth) opt.selected=true; 
                monthSelect.appendChild(opt);
            }
            yearSelect.addEventListener("change", () => { 
                currentYear=parseInt(yearSelect.value); 
                renderCalendar(); 
            });
            monthSelect.addEventListener("change", () => { 
                currentMonth=parseInt(monthSelect.value); 
                renderCalendar(); 
            });
        }

        function renderCalendar(){
            calendarGrid.innerHTML = "";
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth+1,0);
            const startDay = firstDay.getDay();

            for(let i=0;i<startDay;i++){
                const emptyDiv=document.createElement("div"); 
                emptyDiv.classList.add("schedule-calendar-day","empty");
                calendarGrid.appendChild(emptyDiv);
            }

            for(let day=1; day<=lastDay.getDate(); day++){
                const div=document.createElement("div"); 
                div.classList.add("schedule-calendar-day");

                const num=document.createElement("div"); 
                num.classList.add("schedule-calendar-day-number"); 
                num.textContent=day; 
                div.appendChild(num);

                const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
                const daySchedules = schedules.filter(s=>s.date===dateStr);
                daySchedules.forEach(s=>{
                    const item=document.createElement("div"); 
                    item.classList.add("schedule-item",s.type); 
                    item.textContent=s.title;
                    item.addEventListener("click", () =>
                        showDetail(s)
                    ); 
                    div.appendChild(item);
                });
                if(currentYear===today.getFullYear() && currentMonth===today.getMonth() && day===today.getDate()){
                    div.classList.add("today");
                }
                calendarGrid.appendChild(div);
            }
        }

        async function loadDogs(selectElement) {
            try {
                const response = await axios.get("/api/getDogsByUserId");
                if (response.data.returnCode === "SUCCESS") {
                    const dogs = response.data.resultData;
                    selectElement.innerHTML = '<option selected hidden value="">ë°˜ë ¤ê²¬ ì„ íƒ</option>';
                    dogs.forEach(dog => {
                        const option = document.createElement("option");
                        option.value = dog.id;
                        option.textContent = dog.name;
                        selectElement.appendChild(option);
                    });
                } else {
                    console.warn("ë°˜ë ¤ê²¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", response.data.message);
                }
            } catch (error) {
                console.error("ë°˜ë ¤ê²¬ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        }

        function openModal(modalId, schedule = null) {
            document.querySelectorAll(".diaryModal").forEach(m => {
                m.classList.add("hidden");
                m.style.display = "none";
            });

            const modal = document.getElementById(modalId);
            modal.classList.remove("hidden");
            modal.style.display = "flex";

            if (modalId === "walkModal") {
                const walkSelect = document.getElementById("walkDogSelect");
                loadDogs(walkSelect).then(() => {
                    walkSelect.value = schedule?.dogId || "";
                });

                document.getElementById("walkId").value = schedule?.id || "";
                document.getElementById("walkDistance").value = schedule?.distance || "";
                document.getElementById("walkDuration").value = schedule?.duration || "";
                document.getElementById("walkWeather").value = schedule?.weather || "";
                document.getElementById("walkMemo").value = schedule?.desc || "";
            } else if (modalId === "hospitalModal") {
                const hospitalSelect = document.getElementById("hospitalDogSelect");
                loadDogs(hospitalSelect).then(() => {
                    hospitalSelect.value = schedule?.dogId || "";
                });

                document.getElementById("hospitalId").value = schedule?.id || "";
                document.getElementById("hospitalName").value = schedule?.hospitalName || "";
                document.getElementById("hospitalDiagnosis").value = schedule?.diagnosis || "";
                document.getElementById("hospitalCost").value = schedule?.cost || "";
                document.getElementById("hospitalMemo").value = schedule?.desc || "";
            }
        }

        function showDetail(schedule){
            let content = `
                <div class="detail-card ${schedule.type}">
                    <h4>${schedule.title}</h4>
                    <p><strong>ğŸ“… ë‚ ì§œ:</strong> ${schedule.date}</p>
                    <p><strong>ğŸ¶ ë°˜ë ¤ê²¬:</strong> ${schedule.dogName || "-"}</p>
            `;
            if(schedule.type === "walk"){
                content += `
                    <p><strong>â± ì‹œê°„:</strong> ${schedule.duration || "-"} ë¶„</p>
                    <p><strong>ğŸŒ¤ ë‚ ì”¨:</strong> ${schedule.weather || "-"}</p>
                `;
            } else {
                content += `
                    <p><strong>ğŸ¥ ë³‘ì›ëª…:</strong> ${schedule.hospitalName || "-"}</p>
                    <p><strong>ğŸ’‰ ì§„ë£Œ í•­ëª©:</strong> ${schedule.diagnosis || "-"}</p>
                    <p><strong>ğŸ’° ë¹„ìš©:</strong> ${schedule.cost || "-"} ì›</p>
                `;
            }
            content += `<p><strong>ğŸ“ ë©”ëª¨:</strong> ${schedule.desc || "-"}</p>
                <div class="detail-actions">
                    <button class="edit-btn" title="ìˆ˜ì •"><i class="fas fa-pencil-alt"></i></button>
                    <button class="delete-btn" title="ì‚­ì œ"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>`;
            detailContent.innerHTML = content;

            const editBtn = detailContent.querySelector(".edit-btn");
            const deleteBtn = detailContent.querySelector(".delete-btn");

            editBtn.addEventListener("click", ()=>{            
                saveWalkBtn.textContent = "ìˆ˜ì •";
                openModal(schedule.type==="walk"?"walkModal":"hospitalModal", schedule);
            });

            deleteBtn.addEventListener("click", ()=>{
                const modal=document.getElementById("deleteConfirmModal"); modal.style.display="flex";
                const confirmBtn=document.getElementById("confirmDeleteBtn");
                const cancelBtn=document.getElementById("cancelDeleteBtn");
                confirmBtn.replaceWith(confirmBtn.cloneNode(true));
                cancelBtn.replaceWith(cancelBtn.cloneNode(true));

                document.getElementById("confirmDeleteBtn").addEventListener("click", async ()=>{
                    const idx = schedules.findIndex(s=>s.id===schedule.id);
                    if(idx>-1) schedules.splice(idx,1);
                    renderCalendar();
                    detailContent.innerHTML=`<p class="placeholder">ì¼ì •ì„ í´ë¦­í•˜ë©´ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>`;
                    modal.style.display="none";
                });

                document.getElementById("cancelDeleteBtn").addEventListener("click", ()=>{ modal.style.display="none"; });
            });

        }

        saveWalkBtn.addEventListener("click", async ()=>{
            const id = document.getElementById("walkId").value;
            const walkData = {
                dogId: document.getElementById("walkDogSelect").value,
                distance: parseFloat(document.getElementById("walkDistance").value),
                duration: parseInt(document.getElementById("walkDuration").value),
                weather: document.getElementById("walkWeather").value,
                desc: document.getElementById("walkMemo").value,
                date: new Date().toISOString().split("T")[0]
            };
            try{
                if(id){
                    await axios.put(`/api/schedule/walk/${id}`, walkData);
                    const idx = schedules.findIndex(s=>s.id==id);
                    if(idx>-1) schedules[idx]={...schedules[idx], ...walkData};
                }else{
                    const response = await axios.post("/api/schedule/walk", walkData);
                    schedules.push({...walkData, id: response.data.id});
                }
                alert("ì €ì¥ ì™„ë£Œ!"); document.getElementById("walkModal").classList.add("hidden");
                renderCalendar();
                detailContent.innerHTML=`<p class="placeholder">ì¼ì •ì„ í´ë¦­í•˜ë©´ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>`;
            }catch(e){ console.error(e); alert("ì €ì¥ ì˜¤ë¥˜"); }
        });

        saveHospitalBtn.addEventListener("click", async ()=>{
            const id = document.getElementById("hospitalId").value;
            const hospitalData = {
                dogId: document.getElementById("hospitalDogSelect").value,
                hospitalName: document.getElementById("hospitalName").value,
                diagnosis: document.getElementById("hospitalDiagnosis").value,
                cost: parseInt(document.getElementById("hospitalCost").value),
                desc: document.getElementById("hospitalMemo").value,
                date: new Date().toISOString().split("T")[0]
            };
            try{
                if(id){
                    await axios.put(`/api/schedule/hospital/${id}`, hospitalData);
                    const idx = schedules.findIndex(s=>s.id==id);
                    if(idx>-1) schedules[idx]={...schedules[idx], ...hospitalData};
                }else{
                    const response = await axios.post("/api/schedule/hospital", hospitalData);
                    schedules.push({...hospitalData, id: response.data.id});
                }
                alert("ì €ì¥ ì™„ë£Œ!"); document.getElementById("hospitalModal").classList.add("hidden");
                renderCalendar();
                detailContent.innerHTML=`<p class="placeholder">ì¼ì •ì„ í´ë¦­í•˜ë©´ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>`;
            }catch(e){ console.error(e); alert("ì €ì¥ ì˜¤ë¥˜"); }
        });


        todayButton.addEventListener("click", () => {
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            yearSelect.value = currentYear;
            monthSelect.value = currentMonth;
            renderCalendar();
        });

        initSelectors();
        renderCalendar();
    });
</script>
</th:block>
</body>
</html>
