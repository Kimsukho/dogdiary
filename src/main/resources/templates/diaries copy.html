<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<head>
    <title>일지 관리</title>
    <style>
        /* ─────────── DataTables Wrapper ─────────── */
        .dataTables_wrapper {
            margin-top: 1rem;
            font-family: inherit;
        }

        /* ─────────── 검색창 ─────────── */
        .dataTables_filter {
            float: right;
            margin-bottom: 10px;
        }
        .dataTables_filter label {
            font-weight: bold;
        }
        .dataTables_filter input {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        /* ─────────── pageLength select ─────────── */
        .dataTables_length select {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px;
            font-size: 0.9rem;
        }

        /* ─────────── info 영역 ─────────── */
        .dataTables_info {
            float: left;
            margin-top: 5px;
            color: #666;
            font-size: 0.9rem;
        }

        /* ─────────── 페이지네이션 ─────────── */
        .dataTables_paginate {
            float: right;
            margin-top: 5px;
        }
        .dataTables_paginate .paginate_button {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 4px 8px;
            margin: 0 2px;
            color: #333 !important;
            background: #fff;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .dataTables_paginate .paginate_button.current {
            background: var(--primary-color);
            color: #fff !important;
            border-color: var(--primary-color);
        }
        .dataTables_paginate .paginate_button:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="diary-page"> 
            <section class="diary-section">
                <h3 class="diary-title">일지 목록</h3>
                <!-- <button class="diary-add-button" onclick="location.href='/diaries/add'"> -->
                <button class="diary-add-button" onclick="alert('일지 작성')">
                    <i class="fas fa-plus"></i> 새 일지 작성
                </button>

                <!-- 일지 목록 테이블 -->
                <div class="diary-table-container">
                    <table class="diary-table" id="diaryTable">
                        <thead>
                            <tr>
                                <th class="col-pet">반려견</th>
                                <th class="col-content">내용</th>
                                <th class="col-mood">상태</th>
                                <th class="col-date">작성일</th>
                                <th class="col-actions">관리</th> <!-- 수정/삭제 등의 액션 컬럼 추가 -->
                            </tr>
                        </thead>
                        <tbody>
                        <tr id="emptyTable" class="empty-row">
                            <td colspan="5">등록된 일지가 없습니다.</td>
                        </tr>
                    </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <ul>
                        <li>
                            <a href="#" >이전</a>
                        </li>
                        <li>
                            <a href="#">1</a>
                        </li>
                        <li>
                            <a href="#" >다음</a>
                        </li>
                    </ul>
                </div>
            </section>
        </div>
    </div>
    <th:block layout:fragment="script">
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                let diaryTable;
                let tableData = [];
                console.log("일지 관리 페이지 로딩됨");

                diaryTable = $('#diaryTable').DataTable({
                    data: [],
                    pageLength: 10,
                    // searching: true,    // 기본 검색창 제거
                    // lengthChange: true, // "xx개씩 보기" 제거
                    // info: false,         // info 문구 제거
                    // paging: true,        // 페이징만 사용
                    language: {
                        lengthMenu: "_MENU_ 개씩 보기",
                        info: "_START_ - _END_ / _TOTAL_ 건",
                        search: "검색:",
                        paginate: { next: "다음", previous: "이전" }
                    },
                    columns: [
                        { data: 'name', className: 'text-center' },
                        { data: 'content', className: 'text-center' },
                        { data: 'mood', className: 'text-center' },
                        { 
                            data: 'last_updated', 
                            className: 'text-center',
                            render: (data) => new Date(data).toLocaleDateString('ko-KR')
                        },
                        { 
                            data: null,
                            className: 'text-center',
                            orderable: false,
                            render: (row) => `
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary edit-user-btn" data-user='${JSON.stringify(row)}'>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-user-btn" data-id="${row.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `
                        }
                    ]
                });

                async function loadDiaryData() {
                    try {
                        console.log('Loading Diary data...');
                        const response = await axios.get('/api/getAllDiaries');
                        console.log('API response:', response);
                        if (response.data.returnCode == "SUCCESS") {
                            const tableData = response.data.resultData;
                            if (tableData.length === 0) {
                                $('#emptyTable').show();
                            } else {
                                $('#emptyTable').hide();
                                diaryTable.clear().rows.add(tableData).draw();
                            }
                        }
                    } catch (error) {
                        console.error('Error loading users data:', error);
                        alert('일지 관리 데이터를 불러오는데 실패했습니다.');
                    }
                }
                
                loadDiaryData();
            });
        </script>
    </th:block>
</body>
</html>