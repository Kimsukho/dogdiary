<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<body>
<div layout:fragment="content">
    <div class="dashboard-page">
        <!-- 상단 카드 -->
        <div class="cards">
            <div class="card" onclick="showToast('총 방문자 수!');">
                <div class="card-header">
                    <h4 class="title">총 방문자 수</h4>
                    <i class="icon fas fa-users"></i>
                </div>
                <div class="card-body">
                    <div class="value">12,345</div>
                    <p class="description">지난 7일간 12% 증가</p>
                </div>
            </div>

            <div class="card" onclick="showToast('새로운 일지가 25개 있어요!');">
                <div class="card-header">
                    <h4 class="title">이번 달 일지</h4>
                    <i class="icon fas fa-book-open"></i>
                </div>
                <div class="card-body">
                    <div class="value" th:text="${walkCount}">0개</div>
                    <p class="description">오늘 작성된 일지</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h4 class="title">이번 달 산책 기록</h4>
                    <i class="icon fas fa-users"></i>
                </div>
                <div class="card-body">
                    <div class="value" th:text="${walkCount}">0번</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h4 class="title">이번 달 병원 기록</h4>
                    <i class="icon fas fa-hospital"></i>
                </div>
                <div class="card-body">
                    <div class="value" th:text="${hospitalCount}">0건</div>
                </div>
            </div>
        </div>

        <div class="chart-activity-grid">
            <!-- 차트 영역 -->
            <div class="chart-section">
                <div class="chart-header">
                    <h4 class="title">강아지 몸무게 변화</h4>
                    <select id="dogSelect" class="dog-select">
                        <option value="" hidden>강아지를 선택하세요</option>
                    </select>
                </div>

                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
                <p>우리 사랑스러운 댕댕이의 몸무게 변화 추이를 통해 건강 관리에 힘써주세요! ✨</p>
            </div>

            <div class="activity-section">
                <h4 class="title">최근 활동</h4>
                <ul>
                    <li>사용자 '김코코'님이 새로운 일지를 작성했습니다. (1분 전)</li>
                    <li>'코코'의 접종 기록이 업데이트 되었습니다. (30분 전)</li>
                    <li>관리자 '김미호'님이 사용자 설정 변경했습니다. (1시간 전)</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const dogSelect = document.getElementById('dogSelect');
            const ctx = document.getElementById('weightChart').getContext('2d');

            let weightChart;

            // ✅ 강아지 목록 불러오기
            try {
                const response = await axios.get('/api/getDogsByUserId');
                const dogs = response.data.resultData; 
                dogs.forEach(dog => {
                    const option = document.createElement('option');
                    option.value = dog.id;
                    option.textContent = dog.name;
                    dogSelect.appendChild(option);
                });
            } catch (error) {
                console.error('강아지 목록 조회 실패:', error);
            }

            dogSelect.addEventListener('change', async () => {
                const dogId = dogSelect.value;
                if (!dogId) return;

                try {
                    const res = await axios.get(`/api/dogs/${dogId}/weight-history`);
                    const data = res.data.resultData;

                    const labels = data.map(d => d.date);
                    const weights = data.map(d => d.weight);

                    if (weightChart) weightChart.destroy();

                    weightChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                        labels: labels,
                        datasets: [{
                            label: '몸무게 (kg)',
                            data: weights,
                            borderWidth: 2,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.3,
                            fill: true,
                        }]
                        },
                        options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true },
                            x: { ticks: { color: '#555' } }
                        }
                        }
                    });
                } catch (err) {
                    console.error('몸무게 데이터 조회 실패:', err);
                }
            });
        });
    </script>
</th:block>
</body>
</html>
