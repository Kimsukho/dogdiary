<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main-layout}">
<body>
<div layout:fragment="content">
    <div class="dashboard-page">
        <div class="cards">
            <div class="card card-diary" onclick="showMonthlyDiaries()" style="cursor: pointer;">
                <div class="card-icon-wrapper diary-icon">
                    <i class="icon fas fa-book-open"></i>
                </div>
                <div class="card-content">
                    <div class="card-header">
                        <h4 class="title">ì´ë²ˆ ë‹¬ ì¼ì§€</h4>
                    </div>
                    <div class="card-body">
                        <div class="value" id="monthlyDiaryCount" th:text="${walkCount}">0ê°œ</div>
                        <p class="description">ì´ë²ˆ ë‹¬ ì‘ì„±ëœ ì¼ì§€</p>
                    </div>
                </div>
            </div>

            <div class="card card-walk" onclick="showMonthlyWalks()" style="cursor: pointer;">
                <div class="card-icon-wrapper walk-icon">
                    <i class="icon fas fa-walking"></i>
                </div>
                <div class="card-content">
                    <div class="card-header">
                        <h4 class="title">ì´ë²ˆ ë‹¬ ì‚°ì±… ê¸°ë¡</h4>
                    </div>
                    <div class="card-body">
                        <div class="value" id="monthlyWalkCount" th:text="${walkCount}">0ë²ˆ</div>
                        <p class="description">ì´ë²ˆ ë‹¬ ì‚°ì±… íšŸìˆ˜</p>
                    </div>
                </div>
            </div>

            <div class="card card-hospital" onclick="showMonthlyHospitals()" style="cursor: pointer;">
                <div class="card-icon-wrapper hospital-icon">
                    <i class="icon fas fa-clinic-medical"></i>
                </div>
                <div class="card-content">
                    <div class="card-header">
                        <h4 class="title">ì´ë²ˆ ë‹¬ ë³‘ì› ê¸°ë¡</h4>
                    </div>
                    <div class="card-body">
                        <div class="value" id="monthlyHospitalCount" th:text="${hospitalCount}">0ê±´</div>
                        <p class="description">ì´ë²ˆ ë‹¬ ë³‘ì› ë°©ë¬¸</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë°ì´í„° ìƒì„¸ ëª¨ë‹¬ -->
        <div id="dataDetailModal" class="modal-overlay" style="display: none;">
            <div class="modal-container dashboard-modal-container">
                <div class="modal-header">
                    <h3 id="modalTitle">ë°ì´í„° ìƒì„¸</h3>
                    <button class="modal-close" onclick="closeDataDetailModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="modalContent" class="dashboard-modal-content">
                        <!-- ë°ì´í„° ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>

        <div class="chart-activity-grid">
            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div class="chart-section">
                <div class="chart-header">
                    <h4 class="title">ì›”ë³„ í†µê³„</h4>
                    <select id="chartTypeSelect" class="dog-select">
                        <option value="walk">ì‚°ì±… íšŸìˆ˜</option>
                        <option value="hospital">ë³‘ì› ë°©ë¬¸</option>
                    </select>
                </div>

                <div class="chart-container">
                    <canvas id="statisticsChart"></canvas>
                </div>
                <p>ì „ì²´ ë°˜ë ¤ë™ë¬¼ Â· ì›”ë³„ ì‚°ì±… ë° ë³‘ì› ë°©ë¬¸ í†µê³„ë¥¼ í†µí•´ ë°˜ë ¤ê²¬ì˜ í™œë™ íŒ¨í„´ì„ í™•ì¸í•˜ì„¸ìš”! ğŸ“Š</p>
            </div>

            <div class="activity-section">
                <h4 class="title">ì˜ˆì •ëœ ì¼ì • <span style="font-size: 0.7em; font-weight: normal; color: var(--text-secondary);">(ì „ì²´ ë°˜ë ¤ë™ë¬¼)</span></h4>
                <ul id="upcomingSchedules">
                    <li class="empty-schedule">ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // ëŒ€ì‹œë³´ë“œ ì§„ì… ì‹œ í™˜ì˜ ë©”ì‹œì§€ í‘œì‹œ
            try {
                const response = await fetch('/api/user/getInfo', {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                if (result.returnCode === 'SUCCESS' && result.resultData) {
                    const username = result.resultData.username || 'ì‚¬ìš©ì';
                    setTimeout(() => {
                        showToast(`í™˜ì˜í•©ë‹ˆë‹¤, ${username}ë‹˜! ğŸ˜Š`);
                    }, 500);
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
            }

            const chartTypeSelect = document.getElementById('chartTypeSelect');
            const ctx = document.getElementById('statisticsChart').getContext('2d');
            const upcomingSchedulesList = document.getElementById('upcomingSchedules');

            // ì´ë²ˆ ë‹¬ ì¼ì§€ ìˆ˜ ë Œë”ë§
            const monthlyDiaryCountEl = document.getElementById('monthlyDiaryCount');
            try {
                const diaries = await ApiCommon.loadDiaries();
                const now = new Date();
                const monthlyCount = (diaries || []).filter(d => {
                    const dd = new Date(d.created_at);
                    return dd.getFullYear() === now.getFullYear() && dd.getMonth() === now.getMonth();
                }).length;
                if (monthlyDiaryCountEl) {
                    monthlyDiaryCountEl.textContent = `${monthlyCount}ê°œ`;
                }
            } catch (e) {
                console.error('ì´ë²ˆ ë‹¬ ì¼ì§€ ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:', e);
            }

            // ì´ë²ˆ ë‹¬ ì‚°ì±…/ë³‘ì› ìˆ˜ ë Œë”ë§
            const monthlyWalkCountEl = document.getElementById('monthlyWalkCount');
            const monthlyHospitalCountEl = document.getElementById('monthlyHospitalCount');
            let currentUserId = null; // ì‚¬ìš©ì ID ì €ì¥ìš©
            
            try {
                const now = new Date();
                // ì‚¬ìš©ì IDëŠ” APIì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ null ì „ë‹¬
                const schedules = await ApiCommon.loadMonthlySchedules(now.getFullYear(), now.getMonth(), null);
                const walkCount = schedules.filter(s => s.type === 'walk').length;
                const hospitalCount = schedules.filter(s => s.type === 'hospital').length;
                if (monthlyWalkCountEl) monthlyWalkCountEl.textContent = `${walkCount}ë²ˆ`;
                if (monthlyHospitalCountEl) monthlyHospitalCountEl.textContent = `${hospitalCount}ê±´`;
            } catch (e) {
                console.error('ì´ë²ˆ ë‹¬ ì‚°ì±…/ë³‘ì› ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:', e);
            }

            // ì˜ˆì •ëœ ì¼ì • ë¡œë“œ
            async function loadUpcomingSchedules() {
                try {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    
                    // í˜„ì¬ ì›”ê³¼ ë‹¤ìŒ 2ê°œì›” ì¼ì • ê°€ì ¸ì˜¤ê¸°
                    const allSchedules = [];
                    for (let i = 0; i < 3; i++) {
                        const targetDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
                        const monthSchedules = await ApiCommon.loadMonthlySchedules(
                            targetDate.getFullYear(), 
                            targetDate.getMonth(), 
                            null
                        );
                        allSchedules.push(...monthSchedules);
                    }
                    
                    // ì˜¤ëŠ˜ ì´í›„ ì¼ì •ë§Œ í•„í„°ë§
                    const upcoming = allSchedules.filter(s => {
                        const scheduleDate = new Date(s.date);
                        scheduleDate.setHours(0, 0, 0, 0);
                        return scheduleDate >= today;
                    }).sort((a, b) => new Date(a.date) - new Date(b.date)).slice(0, 5);
                    
                    upcomingSchedulesList.innerHTML = '';
                    if (upcoming.length === 0) {
                        upcomingSchedulesList.innerHTML = '<li class="empty-schedule">ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
                    } else {
                        upcoming.forEach(schedule => {
                            const dateObj = new Date(schedule.date);
                            const formattedDate = `${dateObj.getMonth() + 1}ì›” ${dateObj.getDate()}ì¼`;
                            const typeText = schedule.type === 'walk' ? 'ì‚°ì±…' : 'ë³‘ì›';
                            const typeIcon = schedule.type === 'walk' ? 'fa-walking' : 'fa-clinic-medical';
                            const typeColor = schedule.type === 'walk' ? '#FFC107' : '#388E3C';
                            const detail = schedule.type === 'walk' 
                                ? `${schedule.duration || '-'}ë¶„` 
                                : schedule.hospital_name || '-';
                            
                            const li = document.createElement('li');
                            li.style.borderLeftColor = typeColor;
                            li.innerHTML = `
                                <div class="schedule-item-preview">
                                    <div class="schedule-item-icon" style="background: ${schedule.type === 'walk' ? '#FFF9C4' : '#C8E6C9'};">
                                        <i class="fas ${typeIcon}" style="color: ${typeColor};"></i>
                                    </div>
                                    <div class="schedule-item-info">
                                        <div class="schedule-item-date">${formattedDate}</div>
                                        <div class="schedule-item-content">
                                            <span class="schedule-item-type">${typeText}</span>
                                            <span class="schedule-item-detail">${schedule.dog_name || '-'} Â· ${detail}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                            upcomingSchedulesList.appendChild(li);
                        });
                    }
                } catch (e) {
                    console.error('ì˜ˆì •ëœ ì¼ì • ì¡°íšŒ ì‹¤íŒ¨:', e);
                    upcomingSchedulesList.innerHTML = '<li class="empty-schedule">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>';
                }
            }

            let statisticsChart;

            // ì›”ë³„ í†µê³„ ì°¨íŠ¸ ë Œë”ë§
            async function renderStatisticsChart(type) {
                try {
                    // APIì—ì„œ ì›”ë³„ í†µê³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const statistics = await ApiCommon.loadMonthlyStatistics(3);
                    
                    // í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ìµœê·¼ 6ê°œì›” ë¼ë²¨ ìƒì„±
                    const now = new Date();
                    const labels = [];
                    const monthDataMap = {};
                    
                    // ìµœê·¼ 6ê°œì›” ë¼ë²¨ ìƒì„± ë° ì´ˆê¸°í™”
                    for (let i = 5; i >= 0; i--) {
                        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const monthKey = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}`;
                        const monthStr = `${targetDate.getMonth() + 1}ì›”`;
                        labels.push(monthStr);
                        monthDataMap[monthKey] = 0;
                    }
                    
                    // API ë°ì´í„°ë¡œ ë§µ ì±„ìš°ê¸°
                    statistics.forEach(stat => {
                        if (stat.type === type && monthDataMap.hasOwnProperty(stat.month)) {
                            monthDataMap[stat.month] = parseInt(stat.count) || 0;
                        }
                    });
                    
                    // ë¼ë²¨ ìˆœì„œëŒ€ë¡œ ë°ì´í„° ë°°ì—´ ìƒì„±
                    const data = [];
                    for (let i = 5; i >= 0; i--) {
                        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        const monthKey = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}`;
                        data.push(monthDataMap[monthKey] || 0);
                    }
                    
                    if (statisticsChart) statisticsChart.destroy();
                    
                    // ë‹¤í¬ ëª¨ë“œ ê°ì§€
                    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                    const labelColor = isDarkMode ? getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim() || '#b0b0b0' : '#666';
                    const labelFontSize = 14; // í°íŠ¸ í¬ê¸° ì¦ê°€ (12 -> 14)
                    
                    statisticsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: type === 'walk' ? 'ì‚°ì±… íšŸìˆ˜' : 'ë³‘ì› ë°©ë¬¸',
                                data: data,
                                backgroundColor: type === 'walk' 
                                    ? 'rgba(245, 127, 23, 0.6)'
                                    : 'rgba(56, 142, 60, 0.6)',
                                borderColor: type === 'walk'
                                    ? 'rgba(245, 127, 23, 1)'
                                    : 'rgba(56, 142, 60, 1)',
                                borderWidth: 2,
                                borderRadius: 8,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    titleFont: { size: 14, weight: 'bold' },
                                    bodyFont: { size: 13 },
                                    cornerRadius: 8,
                                }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    ticks: { 
                                        stepSize: 1,
                                        color: labelColor,
                                        font: { size: labelFontSize }
                                    },
                                    grid: {
                                        color: isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: { 
                                    ticks: { 
                                        color: labelColor,
                                        font: { size: labelFontSize }
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                } catch (err) {
                    console.error('í†µê³„ ì°¨íŠ¸ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨:', err);
                }
            }

            // ì´ˆê¸° ì°¨íŠ¸ ë Œë”ë§
            await renderStatisticsChart('walk');
            
            // ì°¨íŠ¸ íƒ€ì… ë³€ê²½ ì´ë²¤íŠ¸
            chartTypeSelect.addEventListener('change', async () => {
                await renderStatisticsChart(chartTypeSelect.value);
            });

            // ì˜ˆì •ëœ ì¼ì • ë¡œë“œ
            await loadUpcomingSchedules();
        });

        // ì´ë²ˆ ë‹¬ ì¼ì§€ ëª©ë¡ í‘œì‹œ
        async function showMonthlyDiaries() {
            try {
                const diaries = await ApiCommon.loadDiaries();
                const now = new Date();
                const monthlyDiaries = (diaries || []).filter(d => {
                    const dd = new Date(d.created_at);
                    return dd.getFullYear() === now.getFullYear() && dd.getMonth() === now.getMonth();
                }).sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // ìµœì‹ ìˆœ ì •ë ¬

                const modal = document.getElementById('dataDetailModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');

                modalTitle.textContent = `ì´ë²ˆ ë‹¬ ì¼ì§€ (${monthlyDiaries.length}ê°œ)`;
                
                // ê¸°ë¶„ ë§¤í•‘
                const moodClassMap = { 
                    'HAPPY': 'mood-Happy',
                    'SAD': 'mood-Sad',
                    'ANGRY': 'mood-Angry',
                    'EXCITED': 'mood-Excited'
                };
                const moodLabelMap = { 
                    'HAPPY': 'í–‰ë³µ',
                    'SAD': 'ìŠ¬í””',
                    'ANGRY': 'í™”ë‚¨',
                    'EXCITED': 'ì‹ ë‚¨'
                };
                const moodIconMap = {
                    'HAPPY': 'fa-smile',
                    'SAD': 'fa-frown',
                    'ANGRY': 'fa-angry',
                    'EXCITED': 'fa-star'
                };
                const moodColorMap = {
                    'HAPPY': '#FF6B9D',
                    'SAD': '#42A5F5',
                    'ANGRY': '#C62828',
                    'EXCITED': '#BA68C8'
                };
                const moodGradientMap = {
                    'HAPPY': 'linear-gradient(135deg, #FF6B9D 0%, #FF8E9B 100%)',
                    'SAD': 'linear-gradient(135deg, #64B5F6 0%, #90CAF9 100%)',
                    'ANGRY': 'linear-gradient(135deg, #EF5350 0%, #E53935 100%)',
                    'EXCITED': 'linear-gradient(135deg, #BA68C8 0%, #CE93D8 100%)'
                };
                
                if (monthlyDiaries.length === 0) {
                    modalContent.innerHTML = '<p class="dashboard-modal-empty">ì´ë²ˆ ë‹¬ ì‘ì„±ëœ ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    let html = '<div class="dashboard-modal-list">';
                    monthlyDiaries.forEach(diary => {
                        const date = new Date(diary.created_at);
                        const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        const mood = diary.mood || '';
                        const moodClass = moodClassMap[mood] || '';
                        const moodLabel = moodLabelMap[mood] || (mood || '-');
                        const moodIcon = moodIconMap[mood] || 'fa-meh';
                        const moodColor = moodColorMap[mood] || '#666';
                        const moodGradient = moodGradientMap[mood] || '#f8f9fa';
                        const moodBgColor = mood === 'HAPPY' ? 'rgba(255, 107, 157, 0.2)' : mood === 'SAD' ? 'rgba(66, 165, 245, 0.25)' : mood === 'ANGRY' ? 'rgba(239, 83, 80, 0.2)' : mood === 'EXCITED' ? 'rgba(186, 104, 200, 0.25)' : 'rgba(0, 0, 0, 0.1)';
                        
                        html += `
                            <div class="dashboard-modal-item" style="border-left-color: ${moodColor};">
                                <div class="dashboard-modal-item-header">
                                    <div class="dashboard-modal-item-icon" style="background: ${moodGradient};">
                                        <i class="fas ${moodIcon}"></i>
                                    </div>
                                    <div class="dashboard-modal-item-info">
                                        <div class="dashboard-modal-item-title-row">
                                            <div class="dashboard-modal-item-name">${diary.name || 'ë°˜ë ¤ê²¬'}</div>
                                            <span class="dashboard-modal-item-badge" style="background: ${moodBgColor}; color: ${moodColor}; border-color: ${moodColor}40;">
                                                ${moodLabel}
                                            </span>
                                        </div>
                                        <div class="dashboard-modal-item-date">${formattedDate}</div>
                                    </div>
                                </div>
                                <div class="dashboard-modal-item-content">${diary.content || 'ë‚´ìš© ì—†ìŒ'}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    modalContent.innerHTML = html;
                }

                modal.style.display = 'flex';
            } catch (error) {
                console.error('ì¼ì§€ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
                showToast('ì¼ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì´ë²ˆ ë‹¬ ì‚°ì±… ê¸°ë¡ ëª©ë¡ í‘œì‹œ
        async function showMonthlyWalks() {
            try {
                const now = new Date();
                const schedules = await ApiCommon.loadMonthlySchedules(now.getFullYear(), now.getMonth(), null);
                const walks = schedules.filter(s => s.type === 'walk')
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // ìµœì‹ ìˆœ ì •ë ¬

                const modal = document.getElementById('dataDetailModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');

                modalTitle.textContent = `ì´ë²ˆ ë‹¬ ì‚°ì±… ê¸°ë¡ (${walks.length}ë²ˆ)`;
                
                // ì‚°ì±… ê¸°ë³¸ ì•„ì´ì½˜ ë° ìƒ‰ìƒ ì„¤ì •
                const walkIcon = 'fa-walking';
                const walkColor = '#FFC107';
                const walkBackground = '#FFF9C4';
                const walkGradient = 'linear-gradient(135deg, #FFE082 0%, #FFD54F 100%)';
                
                // ë‚ ì”¨ ì•„ì´ì½˜ ë§¤í•‘
                const weatherIconMap = {
                    'ë§‘ìŒ': 'fa-sun',
                    'íë¦¼': 'fa-cloud',
                    'ë¹„': 'fa-cloud-rain',
                    'ëˆˆ': 'fa-snowflake'
                };
                const weatherColorMap = {
                    'ë§‘ìŒ': '#FFC107',
                    'íë¦¼': '#757575',
                    'ë¹„': '#2196F3',
                    'ëˆˆ': '#00BCD4'
                };
                const weatherGradientMap = {
                    'ë§‘ìŒ': 'linear-gradient(135deg, #FFE082 0%, #FFD54F 100%)',
                    'íë¦¼': 'linear-gradient(135deg, #BDBDBD 0%, #9E9E9E 100%)',
                    'ë¹„': 'linear-gradient(135deg, #64B5F6 0%, #42A5F5 100%)',
                    'ëˆˆ': 'linear-gradient(135deg, #80DEEA 0%, #4DD0E1 100%)'
                };
                const weatherBgColorMap = {
                    'ë§‘ìŒ': 'rgba(255, 193, 7, 0.15)',
                    'íë¦¼': 'rgba(158, 158, 158, 0.25)',
                    'ë¹„': 'rgba(33, 150, 243, 0.15)',
                    'ëˆˆ': 'rgba(0, 188, 212, 0.15)'
                };
                
                if (walks.length === 0) {
                    modalContent.innerHTML = '<p class="dashboard-modal-empty">ì´ë²ˆ ë‹¬ ì‚°ì±… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    let html = '<div class="dashboard-modal-list">';
                    walks.forEach(walk => {
                        const date = new Date(walk.date);
                        const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        const weather = walk.weather || '';
                        // ë‚ ì”¨ì— ë”°ë¼ ì•„ì´ì½˜ê³¼ ê·¸ë¼ë°ì´ì…˜ ë³€ê²½
                        const mainIcon = weather && weatherIconMap[weather] ? weatherIconMap[weather] : walkIcon;
                        const mainGradient = weather && weatherGradientMap[weather] ? weatherGradientMap[weather] : walkGradient;
                        const weatherIcon = weatherIconMap[weather] || 'fa-cloud-sun';
                        const weatherColor = weatherColorMap[weather] || walkColor;
                        const borderColor = weather && weatherColorMap[weather] ? weatherColorMap[weather] : walkColor;
                        const weatherBgColor = weather && weatherBgColorMap[weather] ? weatherBgColorMap[weather] : 'rgba(245, 127, 23, 0.1)';
                        const weatherText = weather || '';
                        
                        html += `
                            <div class="dashboard-modal-item" style="border-left-color: ${borderColor};">
                                <div class="dashboard-modal-item-header">
                                    <div class="dashboard-modal-item-icon" style="background: ${mainGradient};">
                                        <i class="fas ${mainIcon}"></i>
                                    </div>
                                    <div class="dashboard-modal-item-info">
                                        <div class="dashboard-modal-item-title-row">
                                            <div class="dashboard-modal-item-name">${walk.dog_name || 'ë°˜ë ¤ê²¬'}</div>
                                            ${weather ? `
                                            <div class="dashboard-modal-item-weather-badge" style="background: ${weatherBgColor};">
                                                <i class="fas ${weatherIcon}" style="color: ${weatherColor};"></i>
                                                <span style="color: ${weatherColor};">${weatherText}</span>
                                            </div>
                                            ` : ''}
                                        </div>
                                        <div class="dashboard-modal-item-date">${formattedDate}</div>
                                    </div>
                                </div>
                                <div class="dashboard-modal-item-content">
                                    <div class="dashboard-modal-item-content-row">
                                        ${walk.duration ? `<span class="dashboard-modal-item-content-item-inline"><i class="fas fa-clock" style="color: ${borderColor};"></i><span>${walk.duration}ë¶„</span></span>` : ''}
                                        ${walk.memo ? `<span class="dashboard-modal-item-content-item-inline"><i class="fas fa-sticky-note" style="color: ${borderColor};"></i><span>${walk.memo}</span></span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    modalContent.innerHTML = html;
                }

                modal.style.display = 'flex';
            } catch (error) {
                console.error('ì‚°ì±… ê¸°ë¡ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
                showToast('ì‚°ì±… ê¸°ë¡ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ì´ë²ˆ ë‹¬ ë³‘ì› ê¸°ë¡ ëª©ë¡ í‘œì‹œ
        async function showMonthlyHospitals() {
            try {
                const now = new Date();
                const schedules = await ApiCommon.loadMonthlySchedules(now.getFullYear(), now.getMonth(), null);
                const hospitals = schedules.filter(s => s.type === 'hospital')
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // ìµœì‹ ìˆœ ì •ë ¬

                const modal = document.getElementById('dataDetailModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');

                modalTitle.textContent = `ì´ë²ˆ ë‹¬ ë³‘ì› ê¸°ë¡ (${hospitals.length}ê±´)`;
                
                // ë³‘ì› ì•„ì´ì½˜ ë° ìƒ‰ìƒ ì„¤ì •
                const hospitalIcon = 'fa-clinic-medical';
                const hospitalColor = '#388E3C';
                const hospitalBackground = '#C8E6C9';
                const hospitalGradient = 'linear-gradient(135deg, #A5D6A7 0%, #81C784 100%)';
                
                if (hospitals.length === 0) {
                    modalContent.innerHTML = '<p class="dashboard-modal-empty">ì´ë²ˆ ë‹¬ ë³‘ì› ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    let html = '<div class="dashboard-modal-list">';
                    hospitals.forEach(hospital => {
                        const date = new Date(hospital.date);
                        const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        
                        html += `
                            <div class="dashboard-modal-item" style="border-left-color: ${hospitalColor};">
                                <div class="dashboard-modal-item-header">
                                    <div class="dashboard-modal-item-icon" style="background: ${hospitalGradient};">
                                        <i class="fas ${hospitalIcon}"></i>
                                    </div>
                                    <div class="dashboard-modal-item-info">
                                        <div class="dashboard-modal-item-name" style="margin-bottom: 4px;">${hospital.dog_name || 'ë°˜ë ¤ê²¬'}</div>
                                        <div class="dashboard-modal-item-date">${formattedDate}</div>
                                    </div>
                                </div>
                                <div class="dashboard-modal-item-content">
                                    <div class="dashboard-modal-item-content-col">
                                        ${hospital.hospital_name ? `
                                        <div class="dashboard-modal-item-content-item">
                                            <i class="fas fa-hospital" style="color: ${hospitalColor};"></i>
                                            <span>${hospital.hospital_name}</span>
                                        </div>
                                        ` : ''}
                                        ${hospital.purpose || hospital.diagnosis ? `
                                        <div class="dashboard-modal-item-content-item">
                                            <i class="fas fa-stethoscope" style="color: ${hospitalColor};"></i>
                                            <span>${hospital.purpose || hospital.diagnosis || '-'}</span>
                                        </div>
                                        ` : ''}
                                        ${hospital.cost ? `
                                        <div class="dashboard-modal-item-content-item">
                                            <i class="fas fa-won-sign" style="color: ${hospitalColor};"></i>
                                            <span>${parseInt(hospital.cost).toLocaleString()}ì›</span>
                                        </div>
                                        ` : ''}
                                        ${hospital.memo || hospital.desc ? `
                                        <div class="dashboard-modal-item-content-item-start">
                                            <i class="fas fa-sticky-note" style="color: ${hospitalColor};"></i>
                                            <span>${hospital.memo || hospital.desc || ''}</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    modalContent.innerHTML = html;
                }

                modal.style.display = 'flex';
            } catch (error) {
                console.error('ë³‘ì› ê¸°ë¡ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
                showToast('ë³‘ì› ê¸°ë¡ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ë°ì´í„° ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeDataDetailModal() {
            document.getElementById('dataDetailModal').style.display = 'none';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('dataDetailModal');
            if (event.target === modal) {
                closeDataDetailModal();
            }
        });
    </script>
</th:block>
</body>
</html>
